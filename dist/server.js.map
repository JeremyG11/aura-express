{"version":3,"sources":["../src/shared/core/logger.ts","../src/shared/core/db.ts","../src/shared/utils/errors.ts","../src/shared/core/events.ts","../src/core/servers/services.ts","../src/core/users/services.ts","../src/core/messaging/services.ts","../src/server.ts","../src/config/routes.ts","../src/core/auth/config.ts","../src/shared/utils/permissions.ts","../src/email/nodemailer.ts","../src/email/email.ts","../src/shared/libs/argon2.ts","../src/core/auth/middleware.ts","../src/shared/utils/api-response.ts","../src/shared/middlewares/errorHandler.ts","../src/core/messaging/routes.ts","../src/core/messaging/controllers.ts","../src/core/messaging/pin.service.ts","../src/core/messaging/poll.service.ts","../src/shared/middlewares/validationMiddleware.ts","../src/shared/schemas/message.schema.ts","../src/core/servers/routes.ts","../src/core/servers/controllers.ts","../src/core/notifications/routes.ts","../src/core/notifications/controllers.ts","../src/core/users/routes.ts","../src/core/users/controllers.ts","../src/socket/index.ts","../src/shared/core/socket.ts","../src/socket/auth.ts","../src/socket/messages.ts","../src/socket/presence.ts","../src/socket/notifications.ts","../src/socket/rooms.ts","../src/core/messaging/events.ts","../src/core/notifications/services.ts","../src/shared/utils/mention-parser.ts","../src/config/app.ts","../src/config/shutdown.ts"],"sourcesContent":["import winston from \"winston\";\n\nconst logger = winston.createLogger({\n  level: \"info\",\n  format: winston.format.json(),\n  defaultMeta: { service: \"user-service\" },\n  transports: [\n    \n  ],\n});\n\nif (process.env.NODE_ENV !== \"production\") {\n  logger.add(\n    new winston.transports.Console({\n      format: winston.format.simple(),\n    }),\n  );\n} else {\n  logger.add(\n    new winston.transports.Console({\n      format: winston.format.json(),\n    }),\n  );\n}\n\nexport default logger;\n","import { PrismaClient } from \"@prisma/client\";\n\nconst prismaClientSingleton = () => {\n  return new PrismaClient();\n};\n\ntype PrismaClientSingleton = ReturnType<typeof prismaClientSingleton>;\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClientSingleton | undefined;\n};\n\nexport const prisma = globalForPrisma.prisma ?? prismaClientSingleton();\n\nif (process.env.NODE_ENV !== \"production\") globalForPrisma.prisma = prisma;","/**\n * Base class for application-specific errors\n */\nexport class AppError extends Error {\n  public readonly statusCode: number;\n  public readonly isOperational: boolean;\n\n  constructor(\n    message: string,\n    statusCode: number = 500,\n    isOperational: boolean = true,\n  ) {\n    super(message);\n    this.statusCode = statusCode;\n    this.isOperational = isOperational;\n\n    Object.setPrototypeOf(this, new.target.prototype);\n    Error.captureStackTrace(this, this.constructor);\n  }\n}\n\n/**\n * 400 Bad Request\n */\nexport class BadRequestError extends AppError {\n  constructor(message: string = \"Bad Request\") {\n    super(message, 400);\n  }\n}\n\n/**\n * 401 Unauthorized\n */\nexport class UnauthorizedError extends AppError {\n  constructor(message: string = \"Unauthorized\") {\n    super(message, 401);\n  }\n}\n\n/**\n * 403 Forbidden\n */\nexport class ForbiddenError extends AppError {\n  constructor(message: string = \"Forbidden\") {\n    super(message, 403);\n  }\n}\n\n/**\n * 404 Not Found\n */\nexport class NotFoundError extends AppError {\n  constructor(message: string = \"Resource not found\") {\n    super(message, 404);\n  }\n}\n\n/**\n * 500 Internal Server Error\n */\nexport class InternalServerError extends AppError {\n  constructor(message: string = \"Internal Server Error\") {\n    super(message, 500);\n  }\n}\n","import { EventEmitter } from \"events\";\n\nexport const events = new EventEmitter();\n\n// Define Event Constants for DRY\nexport const MESSAGE_EVENTS = {\n  CREATED: \"message:created\",\n  UPDATED: \"message:updated\",\n  DELETED: \"message:deleted\",\n};\n\nexport const NOTIFICATION_EVENTS = {\n  NEW: \"notification:new\",\n};\n\nexport const REACTION_EVENTS = {\n  ADDED: \"reaction:added\",\n  REMOVED: \"reaction:removed\",\n};\n\nexport const POLL_EVENTS = {\n  VOTED: \"poll:voted\",\n};\n","import { prisma } from \"@/shared/core/db\";\n\n/**\n * Service for handling member-related logic\n */\nexport class MemberService {\n  /**\n   * Resolve a member from a userId and context\n   */\n  public static async resolveMember(\n    userId: string,\n    context: { serverId?: string; conversationId?: string },\n  ) {\n    const { serverId, conversationId } = context;\n\n    if (serverId) {\n      return await prisma.member.findFirst({\n        where: {\n          serverId,\n          profile: { userId },\n        },\n        include: { profile: true },\n      });\n    }\n\n    if (conversationId) {\n      const conversation = await prisma.conversation.findUnique({\n        where: { id: conversationId },\n        include: {\n          memberOne: { include: { profile: true } },\n          memberTwo: { include: { profile: true } },\n        },\n      });\n\n      if (!conversation) return null;\n\n      if (conversation.memberOne.profile.userId === userId) {\n        return conversation.memberOne;\n      }\n      if (conversation.memberTwo.profile.userId === userId) {\n        return conversation.memberTwo;\n      }\n    }\n\n    return null;\n  }\n}\n","import { prisma } from \"@/shared/core/db\";\nimport logger from \"@/shared/core/logger\";\n\n/**\n * Get profile by userId\n */\nexport const getProfileByUserId = async (userId: string) => {\n  return await prisma.profile.findFirst({\n    where: { userId },\n  });\n};\n\n/**\n * Get profile with servers\n */\nexport const getProfileWithServers = async (userId: string) => {\n  return await prisma.profile.findFirst({\n    where: { userId },\n    include: {\n      members: {\n        include: {\n          server: true,\n        },\n      },\n    },\n  });\n};\n\n/**\n * Update user status and return all online users\n */\nexport const updateUserStatus = async (userId: string, status: boolean) => {\n  try {\n    await prisma.user.update({\n      where: {\n        id: userId,\n      },\n      data: {\n        isOnline: status,\n      },\n    });\n\n    const onlineUsers = await prisma.user.findMany({\n      where: {\n        isOnline: true,\n      },\n    });\n\n    return onlineUsers;\n  } catch (error) {\n    logger.error(\"[UPDATE_USER_STATUS]\", error);\n    throw error;\n  }\n};\n","import { prisma } from \"@/shared/core/db\";\nimport {\n  events,\n  MESSAGE_EVENTS,\n  REACTION_EVENTS,\n  POLL_EVENTS,\n} from \"@/shared/core/events\";\nimport {\n  BadRequestError,\n  NotFoundError,\n  UnauthorizedError,\n} from \"@/shared/utils/errors\";\nimport { MemberService } from \"@/core/servers/services\";\nimport { getProfileByUserId } from \"@/core/users/services\";\nimport { PollService } from \"./poll.service\";\n\n/**\n * Service for handling message logic\n */\nexport class MessageService {\n  /**\n   * Create a channel message\n   */\n  public static async createChannelMessage(payload: {\n    content: string;\n    fileUrl?: string;\n    isEncrypted?: boolean;\n    parentId?: string;\n    serverId: string;\n    channelId: string;\n    userId: string;\n    poll?: {\n      question: string;\n      options: string[];\n      expiresAt?: Date;\n    };\n  }) {\n    const {\n      content,\n      fileUrl,\n      isEncrypted,\n      parentId,\n      serverId,\n      channelId,\n      userId,\n      poll,\n    } = payload;\n\n    const member = await MemberService.resolveMember(userId, { serverId });\n\n    if (!member) {\n      throw new NotFoundError(\"Member not found in this server\");\n    }\n\n    console.time(\n      `[MessageService.createChannelMessage] DB Create with Poll: ${userId}`,\n    );\n    const message = await prisma.message.create({\n      data: {\n        content,\n        fileUrl: fileUrl || null,\n        channelId,\n        memberId: member.id,\n        isEncrypted: !!isEncrypted,\n        parentId: parentId || null,\n        ...(poll && {\n          poll: {\n            create: {\n              question: poll.question,\n              expiresAt: poll.expiresAt,\n              options: {\n                create: poll.options.map((text) => ({ text })),\n              },\n            },\n          },\n        }),\n      },\n      include: {\n        member: {\n          include: {\n            profile: true,\n          },\n        },\n        poll: {\n          include: {\n            options: {\n              include: {\n                votes: true,\n                _count: {\n                  select: { votes: true },\n                },\n              },\n            },\n          },\n        },\n      },\n    });\n    console.timeEnd(\n      `[MessageService.createChannelMessage] DB Create with Poll: ${userId}`,\n    );\n\n    events.emit(MESSAGE_EVENTS.CREATED, {\n      message,\n      type: \"channel\",\n      contextId: channelId,\n    });\n    return message;\n\n    events.emit(MESSAGE_EVENTS.CREATED, {\n      message,\n      type: \"channel\",\n      contextId: channelId,\n    });\n    return message;\n  }\n\n  /**\n   * Create a direct message\n   */\n  public static async createDirectMessage(payload: {\n    content: string;\n    fileUrl?: string;\n    isEncrypted?: boolean;\n    parentId?: string;\n    conversationId: string;\n    userId: string;\n    poll?: {\n      question: string;\n      options: string[];\n      expiresAt?: Date;\n    };\n  }) {\n    const {\n      content,\n      fileUrl,\n      isEncrypted,\n      parentId,\n      conversationId,\n      userId,\n      poll,\n    } = payload;\n\n    const member = await MemberService.resolveMember(userId, {\n      conversationId,\n    });\n\n    if (!member) {\n      throw new NotFoundError(\"Member not found in conversation\");\n    }\n\n    const message = await prisma.directMessage.create({\n      data: {\n        content,\n        fileUrl: fileUrl || null,\n        conversationId,\n        memberId: member.id,\n        isEncrypted: !!isEncrypted,\n        parentId: parentId || null,\n        ...(poll && {\n          poll: {\n            create: {\n              question: poll.question,\n              expiresAt: poll.expiresAt,\n              options: {\n                create: poll.options.map((text) => ({ text })),\n              },\n            },\n          },\n        }),\n      },\n      include: {\n        member: {\n          include: {\n            profile: true,\n          },\n        },\n        poll: {\n          include: {\n            options: {\n              include: {\n                votes: true,\n                _count: {\n                  select: { votes: true },\n                },\n              },\n            },\n          },\n        },\n      },\n    });\n\n    events.emit(MESSAGE_EVENTS.CREATED, {\n      message,\n      type: \"direct\",\n      contextId: conversationId,\n    });\n    return message;\n  }\n\n  /**\n   * Update a message (Polymorphic)\n   */\n  public static async updateMessage(payload: {\n    messageId: string;\n    content: string;\n    userId: string;\n    serverId?: string;\n    conversationId?: string;\n  }) {\n    const { messageId, content, userId, serverId, conversationId } = payload;\n\n    const member = await MemberService.resolveMember(userId, {\n      serverId,\n      conversationId,\n    });\n    if (!member) throw new UnauthorizedError(\"Member not found\");\n\n    if (serverId) {\n      const message = await prisma.message.findFirst({\n        where: { id: messageId, memberId: member.id, deleted: false },\n      });\n\n      if (!message)\n        throw new NotFoundError(\"Message not found or unauthorized\");\n\n      const updated = await prisma.message.update({\n        where: { id: messageId },\n        data: { content },\n        include: { member: { include: { profile: true } } },\n      });\n\n      events.emit(MESSAGE_EVENTS.UPDATED, {\n        message: updated,\n        type: \"channel\",\n        contextId: message.channelId,\n      });\n      return updated;\n    } else if (conversationId) {\n      const message = await prisma.directMessage.findFirst({\n        where: { id: messageId, memberId: member.id, deleted: false },\n      });\n\n      if (!message)\n        throw new NotFoundError(\"Message not found or unauthorized\");\n\n      const updated = await prisma.directMessage.update({\n        where: { id: messageId },\n        data: { content },\n        include: { member: { include: { profile: true } } },\n      });\n\n      events.emit(MESSAGE_EVENTS.UPDATED, {\n        message: updated,\n        type: \"direct\",\n        contextId: conversationId,\n      });\n      return updated;\n    }\n\n    throw new BadRequestError(\n      \"Context missing (serverId or conversationId required)\",\n    );\n  }\n\n  /**\n   * Delete a message (Polymorphic)\n   */\n  public static async deleteMessage(payload: {\n    messageId: string;\n    userId: string;\n    serverId?: string;\n    conversationId?: string;\n  }) {\n    const { messageId, userId, serverId, conversationId } = payload;\n\n    const member = await MemberService.resolveMember(userId, {\n      serverId,\n      conversationId,\n    });\n    if (!member) throw new UnauthorizedError(\"Member not found\");\n\n    if (serverId) {\n      const message = await prisma.message.findFirst({\n        where: { id: messageId },\n        include: { member: true },\n      });\n\n      if (!message || message.deleted)\n        throw new NotFoundError(\"Message not found\");\n\n      const canDelete =\n        message.memberId === member.id ||\n        [\"ADMIN\", \"MODERATOR\"].includes(member.role);\n      if (!canDelete)\n        throw new UnauthorizedError(\"Unauthorized to delete this message\");\n\n      const deleted = await prisma.message.update({\n        where: { id: messageId },\n        data: {\n          fileUrl: null,\n          content: \"This message has been deleted.\",\n          deleted: true,\n        },\n        include: { member: { include: { profile: true } } },\n      });\n\n      events.emit(MESSAGE_EVENTS.UPDATED, {\n        message: deleted,\n        type: \"channel\",\n        contextId: message.channelId,\n      });\n      return deleted;\n    } else if (conversationId) {\n      const message = await prisma.directMessage.findFirst({\n        where: { id: messageId, conversationId },\n      });\n\n      if (!message || message.deleted)\n        throw new NotFoundError(\"Message not found\");\n      if (message.memberId !== member.id)\n        throw new UnauthorizedError(\"Unauthorized to delete this message\");\n\n      const deleted = await prisma.directMessage.update({\n        where: { id: messageId },\n        data: {\n          fileUrl: null,\n          content: \"This message has been deleted.\",\n          deleted: true,\n        },\n        include: { member: { include: { profile: true } } },\n      });\n\n      events.emit(MESSAGE_EVENTS.UPDATED, {\n        message: deleted,\n        type: \"direct\",\n        contextId: conversationId,\n      });\n      return deleted;\n    }\n\n    throw new BadRequestError(\n      \"Context missing (serverId or conversationId required)\",\n    );\n  }\n}\n\n/**\n * Find or create a conversation between two members\n */\nexport const findOrCreateConversation = async (\n  memberOneId: string,\n  memberTwoId: string,\n) => {\n  let conversation = await findConversation(memberOneId, memberTwoId);\n\n  if (!conversation) {\n    conversation = await createNewConversation(memberOneId, memberTwoId);\n  }\n\n  return conversation;\n};\n\nconst findConversation = async (memberOneId: string, memberTwoId: string) => {\n  try {\n    return await prisma.conversation.findFirst({\n      where: {\n        OR: [\n          { AND: [{ memberOneId }, { memberTwoId }] },\n          { AND: [{ memberOneId: memberTwoId }, { memberTwoId: memberOneId }] },\n        ],\n      },\n      include: {\n        memberOne: {\n          include: {\n            profile: true,\n          },\n        },\n        memberTwo: {\n          include: {\n            profile: true,\n          },\n        },\n      },\n    });\n  } catch (error) {\n    console.error(\"Error finding conversation:\", error);\n    return null;\n  }\n};\n\nconst createNewConversation = async (\n  memberOneId: string,\n  memberTwoId: string,\n) => {\n  try {\n    return await prisma.conversation.create({\n      data: {\n        memberOneId,\n        memberTwoId,\n      },\n      include: {\n        memberOne: {\n          include: {\n            profile: true,\n          },\n        },\n        memberTwo: {\n          include: {\n            profile: true,\n          },\n        },\n      },\n    });\n  } catch {\n    return null;\n  }\n};\n\n/**\n * Service for handling reactions\n */\nexport class ReactionService {\n  /**\n   * Add a reaction to a message\n   */\n  public static async addReaction(payload: {\n    userId: string;\n    emoji: string;\n    messageId?: string;\n    directMessageId?: string;\n  }) {\n    const { userId, emoji, messageId, directMessageId } = payload;\n\n    const profile = await getProfileByUserId(userId);\n    if (!profile) throw new NotFoundError(\"Profile not found\");\n\n    let authorProfileId: string | null = null;\n    let authorUserId: string | null = null;\n\n    if (messageId) {\n      const message = await prisma.message.findUnique({\n        where: { id: messageId },\n        include: { member: { include: { profile: true } } },\n      });\n      authorProfileId = message?.member.profile.id || null;\n      authorUserId = message?.member.profile.userId || null;\n    } else if (directMessageId) {\n      const directMessage = await prisma.directMessage.findUnique({\n        where: { id: directMessageId },\n        include: { member: { include: { profile: true } } },\n      });\n      authorProfileId = directMessage?.member.profile.id || null;\n      authorUserId = directMessage?.member.profile.userId || null;\n    }\n\n    const existingReaction = await prisma.reaction.findFirst({\n      where: {\n        profileId: profile.id,\n        messageId,\n        directMessageId,\n      },\n    });\n\n    if (existingReaction) {\n      if (existingReaction.emoji === emoji) {\n        await prisma.reaction.delete({\n          where: { id: existingReaction.id },\n        });\n\n        events.emit(REACTION_EVENTS.REMOVED, { reaction: existingReaction });\n        return null;\n      }\n\n      const oldReaction = { ...existingReaction };\n\n      const updatedReaction = await prisma.reaction.update({\n        where: { id: existingReaction.id },\n        data: { emoji },\n        include: {\n          profile: {\n            select: { id: true, name: true, imageUrl: true },\n          },\n        },\n      });\n\n      events.emit(REACTION_EVENTS.REMOVED, { reaction: oldReaction });\n      events.emit(REACTION_EVENTS.ADDED, {\n        reaction: updatedReaction,\n        authorProfileId,\n        authorUserId,\n        senderProfileId: profile.id,\n      });\n\n      return updatedReaction;\n    }\n\n    const reaction = await prisma.reaction.create({\n      data: {\n        emoji,\n        profileId: profile.id,\n        messageId,\n        directMessageId,\n      },\n      include: {\n        profile: {\n          select: { id: true, name: true, imageUrl: true },\n        },\n      },\n    });\n\n    events.emit(REACTION_EVENTS.ADDED, {\n      reaction,\n      authorProfileId,\n      authorUserId,\n      senderProfileId: profile.id,\n    });\n\n    return reaction;\n  }\n\n  /**\n   * Remove a reaction\n   */\n  public static async removeReaction(payload: {\n    userId: string;\n    reactionId: string;\n  }) {\n    const { userId, reactionId } = payload;\n\n    const profile = await getProfileByUserId(userId);\n    if (!profile) throw new NotFoundError(\"Profile not found\");\n\n    const reaction = await prisma.reaction.delete({\n      where: {\n        id: reactionId,\n        profileId: profile.id,\n      },\n    });\n\n    events.emit(REACTION_EVENTS.REMOVED, { reaction });\n    return reaction;\n  }\n}\n","import dotenv from \"dotenv\";\nimport http from \"http\";\nimport logger from \"@/shared/core/logger\";\nimport { setupRoutes } from \"@/config/routes\";\nimport { initializeSocket } from \"@/socket\";\nimport { createApp, allowedOrigins } from \"@/config/app\";\nimport { serverShutdown } from \"@/config/shutdown\";\n\ndotenv.config();\n\nconst port = process.env.PORT || 7272;\n\n// Create Express app\nexport const app = createApp();\n\n// Setup routes\nsetupRoutes(app);\n\n// Create HTTP server\nconst server = http.createServer(app);\n\n// Initialize Socket.IO\ninitializeSocket(server, allowedOrigins, app);\n\n// Start server\nlet httpServer: http.Server | undefined;\n\nif (process.env.NODE_ENV !== \"test\") {\n  httpServer = server.listen(Number(port), \"0.0.0.0\", () => {\n    logger.info(`âš¡ Server is ready on port:${port} ðŸ”¥`);\n    logger.info(`Allowed origins: ${allowedOrigins}`);\n  });\n}\n\n// Setup graceful shutdown\nserverShutdown(httpServer);\n","import express, { Application } from \"express\";\nimport { toNodeHandler } from \"better-auth/node\";\nimport { auth } from \"@/core/auth/config\";\nimport { authMiddleware } from \"@/core/auth/middleware\";\nimport { errorHandler } from \"@/shared/middlewares/errorHandler\";\nimport messagingRoutes from \"@/core/messaging/routes\";\nimport serverRoutes from \"@/core/servers/routes\";\nimport notificationRoutes from \"@/core/notifications/routes\";\nimport userRoutes from \"@/core/users/routes\";\nimport logger from \"@/shared/core/logger\";\n\nexport function setupRoutes(app: Application): void {\n  // Root route to avoid \"Cannot GET /\"\n  app.get(\"/\", (req, res) => {\n    res.json({\n      message: \"Lively Backend API is running\",\n      documentation: \"/health\",\n    });\n  });\n\n  app.get(\"/api/auth/session\", async (req, res) => {\n    const internalSecret = req.headers[\"x-internal-secret\"];\n\n    if (internalSecret !== process.env.SERVER_INTERNAL_SECRET) {\n      logger.warn(`[Auth] Forbidden introspection attempt from ${req.ip}`);\n      return res\n        .status(403)\n        .json({ error: \"Forbidden - Invalid internal secret\" });\n    }\n\n    const session = await auth.api.getSession({\n      headers: req.headers as any,\n    });\n    res.json({ data: session });\n  });\n\n  app.all(\"/api/auth/*\", toNodeHandler(auth));\n\n  app.get(\"/health\", (req, res) => {\n    res.json({\n      status: \"ok\",\n      timestamp: new Date().toISOString(),\n      uptime: process.uptime(),\n    });\n  });\n\n  app.use(authMiddleware);\n\n  app.use(express.json());\n\n  // API v1 Consolidated Routes\n  const v1Router = express.Router();\n  v1Router.use(messagingRoutes);\n  v1Router.use(serverRoutes);\n  v1Router.use(notificationRoutes);\n  v1Router.use(userRoutes);\n\n  app.use(\"/api/v1\", v1Router);\n\n  app.use(errorHandler);\n}\n","import { betterAuth } from \"better-auth\";\nimport { prismaAdapter } from \"better-auth/adapters/prisma\";\nimport {\n  admin,\n  customSession,\n  magicLink,\n  twoFactor,\n  organization,\n} from \"better-auth/plugins\";\nimport { passkey } from \"@better-auth/passkey\";\nimport { stripe } from \"@better-auth/stripe\";\nimport { Stripe } from \"stripe\";\n\nimport { prisma } from \"@/shared/core/db\";\nimport logger from \"@/shared/core/logger\";\nimport { ac, roles } from \"@/shared/utils/permissions\";\nimport { sendEmailAction } from \"@/email/email\";\nimport { hashPassword, verifyPassword } from \"@/shared/libs/argon2\";\n\nexport const auth = betterAuth({\n  appName: \"Aura\",\n  basePath: \"/api/auth\",\n  trustProxy: true,\n  database: prismaAdapter(prisma, {\n    provider: \"mongodb\",\n  }),\n  debug: true,\n  secret: process.env.BETTER_AUTH_SECRET,\n  baseURL:\n    process.env.BETTER_AUTH_URL || \"https://node-socket-io-hxb4.onrender.com\",\n  trustedOrigins: [\n    \"http://localhost:3000\",\n    \"http://localhost:7272\",\n    \"https://node-socket-io-hxb4.onrender.com\",\n    \"https://aura-seven-lyart.vercel.app\",\n    process.env.FRONTEND_URL,\n    process.env.BETTER_AUTH_URL,\n  ].filter((origin): origin is string => !!origin),\n\n  emailVerification: {\n    sendOnSignUp: true,\n    expiresIn: 60 * 60,\n    autoSignInAfterVerification: true,\n    sendVerificationEmail: async ({ user, url }) => {\n      const link = new URL(url);\n      link.searchParams.set(\"callbackURL\", \"/auth/verify\");\n\n      await sendEmailAction({\n        to: user.email,\n        subject: \"Verify your email address\",\n        meta: {\n          description:\n            \"Please verify your email address to complete the registration process.\",\n          link: String(link),\n        },\n      });\n    },\n  },\n  emailAndPassword: {\n    enabled: true,\n    minPasswordLength: 6,\n    autoSignIn: false,\n    password: {\n      hash: hashPassword,\n      verify: verifyPassword,\n    },\n    requireEmailVerification: false,\n    sendResetPassword: async ({ user, url }) => {\n      await sendEmailAction({\n        to: user.email,\n        subject: \"Reset your password\",\n        meta: {\n          description: \"Please click the link below to reset your password.\",\n          link: String(url),\n        },\n      });\n    },\n  },\n  databaseHooks: {\n    user: {\n      create: {\n        before: async (user) => {\n          const ADMIN_EMAILS = process.env.ADMIN_EMAILS?.split(\";\") ?? [];\n\n          if (ADMIN_EMAILS.includes(user.email)) {\n            return { data: { ...user, role: \"ADMIN\" } };\n          }\n\n          return { data: user };\n        },\n      },\n    },\n  },\n  user: {\n    additionalFields: {\n      role: {\n        type: [\"USER\", \"ADMIN\"],\n        input: false,\n      },\n    },\n  },\n  session: {\n    expiresIn: 30 * 24 * 60 * 60,\n    cookieCache: {\n      enabled: true,\n      maxAge: 5 * 60,\n    },\n  },\n\n  account: {\n    skipStateCookieCheck: true,\n    accountLinking: {\n      enabled: true,\n      trustedProviders: [\"google\", \"github\"],\n    },\n  },\n\n  advanced: {\n    database: {\n      generateId: false,\n    },\n    defaultCookieAttributes: {\n      sameSite: \"none\",\n      secure: true,\n    },\n    useSecureCookies: true,\n  },\n\n  secondaryStorage: {\n    get: async (key) => {\n      const value = await prisma.verification.findUnique({\n        where: { identifier: key },\n      });\n      logger.info(`[SecondaryStorage] GET key=${key} found=${!!value}`);\n      return value?.value || null;\n    },\n    set: async (key, value, expiresAt) => {\n      logger.info(`[SecondaryStorage] SET key=${key} expires=${expiresAt}`);\n      await prisma.verification.upsert({\n        where: { identifier: key },\n        create: {\n          identifier: key,\n          value,\n          expiresAt: new Date(expiresAt),\n        },\n        update: {\n          value,\n          expiresAt: new Date(expiresAt),\n        },\n      });\n    },\n    delete: async (key) => {\n      logger.info(`[SecondaryStorage] DELETE key=${key}`);\n      await prisma.verification.deleteMany({\n        where: { identifier: key },\n      });\n    },\n  },\n  socialProviders: {\n    google: {\n      clientId: process.env.GOOGLE_CLIENT_ID!,\n      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,\n    },\n    github: {\n      clientId: process.env.GITHUB_CLIENT_ID!,\n      clientSecret: process.env.GITHUB_CLIENT_SECRET!,\n    },\n  },\n  plugins: [\n    admin({\n      defaultRole: \"USER\",\n      adminRoles: [\"ADMIN\"],\n      ac,\n      roles,\n    }),\n    magicLink({\n      sendMagicLink: async ({ email, url }) => {\n        await sendEmailAction({\n          to: email,\n          subject: \"Magic Link Login\",\n          meta: {\n            description: \"Please click the link below to log in.\",\n            link: String(url),\n          },\n        });\n      },\n    }),\n    twoFactor({\n      otpOptions: {},\n    }),\n    passkey(),\n    organization(),\n    stripe({\n      stripeClient: new Stripe(process.env.STRIPE_KEY || \"sk_test_\"),\n      stripeWebhookSecret: process.env.STRIPE_WEBHOOK_SECRET!,\n      subscription: {\n        enabled: true,\n        plans: [\n          {\n            name: \"Plus\",\n            priceId:\n              process.env.STRIPE_PLUS_PRICE_ID ||\n              \"price_1RoxnJHmTADgihIthZTLmrPn\",\n          },\n          {\n            name: \"Pro\",\n            priceId:\n              process.env.STRIPE_PRO_PRICE_ID ||\n              \"price_1RoxnRHmTADgihIt4y8c0lVE\",\n          },\n        ],\n      },\n    }),\n    customSession(async ({ user, session }) => {\n      return {\n        session: {\n          expiresAt: session.expiresAt,\n          token: session.token,\n          userAgent: session.userAgent,\n        },\n        user: {\n          id: user.id,\n          name: user.name,\n          email: user.email,\n          image: user.image,\n          createdAt: user.createdAt,\n          role: (user as any).role,\n        },\n      };\n    }),\n  ],\n});\n","import { createAccessControl } from \"better-auth/plugins/access\";\nimport { defaultStatements, adminAc } from \"better-auth/plugins/admin/access\";\n\nconst statements = {\n  ...defaultStatements,\n  posts: [\"create\", \"read\", \"update\", \"delete\", \"update:own\", \"delete:own\"],\n} as const;\n\nexport const ac = createAccessControl(statements);\n\nexport const roles = {\n  USER: ac.newRole({\n    posts: [\"create\", \"read\", \"update:own\", \"delete:own\"],\n  }),\n\n  ADMIN: ac.newRole({\n    posts: [\"create\", \"read\", \"update\", \"delete\", \"update:own\", \"delete:own\"],\n    ...adminAc.statements,\n  }),\n};\n","import nodemailer from \"nodemailer\";\n\nconst transporter = nodemailer.createTransport({\n  host: \"smtp.gmail.com\",\n  port: 465,\n  secure: true,\n  auth: {\n    user: process.env.NODEMAILER_USER,\n    pass: process.env.NODEMAILER_APP_PASSWORD,\n  },\n});\n\nexport default transporter;\n","import transporter from \"@/email/nodemailer\";\n\nconst styles = {\n  container:\n    \"max-width:500px;margin:20px auto;padding:20px;border:1px solid #ddd;border-radius:6px;\",\n  heading: \"font-size:20px;color:#333;\",\n  paragraph: \"font-size:16px;\",\n  link: \"display:inline-block;margin-top:15px;padding:10px 15px;background:#007bff;color:#fff;text-decoration:none;border-radius:4px;\",\n};\n\nexport async function sendEmailAction({\n  to,\n  subject,\n  meta,\n}: {\n  to: string;\n  subject: string;\n  meta: {\n    description: string;\n    link: string;\n  };\n}) {\n  const mailOptions = {\n    from: process.env.NODEMAILER_USER,\n    to,\n    subject: `GameCord - ${subject}`,\n    html: `\n    <div style=\"${styles.container}\">\n      <h1 style=\"${styles.heading}\">${subject}</h1>\n      <p style=\"${styles.paragraph}\">${meta.description}</p>\n      <a href=\"${meta.link}\" style=\"${styles.link}\">Click Here</a>\n    </div>\n    `,\n  };\n\n  try {\n    await transporter.sendMail(mailOptions);\n    return { success: true };\n  } catch (err) {\n    console.error(\"[SendEmail]:\", err);\n    return { success: false };\n  }\n}\n","import { hash, verify, type Options } from \"@node-rs/argon2\";\n\nconst opts: Options = {\n  memoryCost: 19456,\n  timeCost: 2,\n  outputLen: 32,\n  parallelism: 1,\n};\n\nexport async function hashPassword(password: string): Promise<string> {\n  const result = await hash(password, opts);\n  return result;\n}\n\nexport async function verifyPassword(data: {\n  password: string;\n  hash: string;\n}): Promise<boolean> {\n  const { password, hash: hashedPassword } = data;\n\n  const result = await verify(hashedPassword, password, opts);\n  return result;\n}\n","import { Request, Response, NextFunction } from \"express\";\nimport { auth } from \"@/core/auth/config\";\nimport { fromNodeHeaders } from \"better-auth/node\";\nimport logger from \"@/shared/core/logger\";\n\nexport const authMiddleware = async (\n  req: Request,\n  res: Response,\n  next: NextFunction,\n) => {\n  const session = await auth.api.getSession({\n    headers: fromNodeHeaders(req.headers),\n  });\n\n  if (session) {\n    res.locals.userId = session.user.id;\n    res.locals.user = session.user;\n    return next();\n  }\n\n  const internalSecret = req.headers[\"x-internal-secret\"] as string;\n  const bridgedUserId = req.headers[\"x-user-id\"] as string;\n\n  if (\n    internalSecret &&\n    internalSecret === process.env.SERVER_INTERNAL_SECRET &&\n    bridgedUserId\n  ) {\n    res.locals.userId = bridgedUserId;\n    return next();\n  }\n\n  if (process.env.NODE_ENV !== \"production\" && bridgedUserId) {\n    logger.warn(\n      \"[Auth] WARNING: Using insecure fallback userId:\",\n      bridgedUserId,\n    );\n    res.locals.userId = bridgedUserId;\n    return next();\n  }\n\n  logger.error(\"[Auth] Authentication FAILED for:\", req.url);\n  return res\n    .status(401)\n    .json({ error: \"Unauthorized - No valid session or secure bridge found\" });\n};\n","import { Response } from \"express\";\n\n/**\n * Standardized API Response utility\n */\nexport class ApiResponse {\n  /**\n   * Send a success response\n   */\n  public static success(\n    res: Response,\n    data: any,\n    message: string = \"Success\",\n    status: number = 200,\n  ) {\n    return res.status(status).json({\n      success: true,\n      message,\n      data,\n    });\n  }\n\n  /**\n   * Send an error response\n   */\n  public static error(\n    res: Response,\n    error: string,\n    status: number = 500,\n    stack?: string,\n  ) {\n    return res.status(status).json({\n      success: false,\n      error,\n      ...(process.env.NODE_ENV !== \"production\" && stack ? { stack } : {}),\n    });\n  }\n}\n","import { NextFunction, Request, Response } from \"express\";\nimport { ApiResponse } from \"@/shared/utils/api-response\";\nimport { AppError } from \"@/shared/utils/errors\";\nimport logger from \"@/shared/core/logger\";\n\n/**\n * Centralized error handler middleware.\n * Catches all unhandled errors and returns a consistent JSON response.\n */\nexport const errorHandler = (\n  err: any,\n  req: Request,\n  res: Response,\n  next: NextFunction,\n) => {\n  let statusCode = err.statusCode || 500;\n  let message = err.message || \"Something went wrong\";\n\n  if (err instanceof AppError) {\n    statusCode = err.statusCode;\n    message = err.message;\n  }\n\n  if (statusCode >= 500) {\n    logger.error(\n      `[Error] ${req.method} ${req.url} - Status: ${statusCode}`,\n      err,\n    );\n  }\n\n  ApiResponse.error(res, message, statusCode, err.stack);\n};\n","import { Router } from \"express\";\nimport * as controllers from \"./controllers\";\nimport validator from \"@/shared/middlewares/validationMiddleware\";\nimport {\n  createChannelMessageSchema,\n  createDirectMessageSchema,\n  updateMessageSchema,\n  deleteMessageSchema,\n} from \"@/shared/schemas/message.schema\";\n\nconst router = Router();\n\n// --- Messages ---\nconst messageRouter = Router();\nmessageRouter.post(\n  \"/channel\",\n  validator(createChannelMessageSchema),\n  controllers.createChannelMessage,\n);\nmessageRouter.post(\n  \"/direct\",\n  validator(createDirectMessageSchema),\n  controllers.createDirectMessage,\n);\nmessageRouter.patch(\n  \"/:messageId\",\n  validator(updateMessageSchema),\n  controllers.updateMessage,\n);\nmessageRouter.delete(\n  \"/:messageId\",\n  validator(deleteMessageSchema),\n  controllers.deleteMessage,\n);\nmessageRouter.post(\"/:messageId/pin\", controllers.pinMessage);\nmessageRouter.delete(\"/:messageId/pin\", controllers.unpinMessage);\nmessageRouter.get(\"/conversation\", controllers.getConversation);\nmessageRouter.get(\"/\", controllers.getMessages);\n\n// --- Conversations ---\nconst conversationRouter = Router();\nconversationRouter.get(\"/\", controllers.getConversations);\n\n// --- Threads ---\nconst threadRouter = Router();\nthreadRouter.get(\"/channel/:messageId\", controllers.getChannelThreadMetadata);\nthreadRouter.get(\"/direct/:messageId\", controllers.getDirectThreadMetadata);\n\n// --- Reactions ---\nconst reactionRouter = Router();\nreactionRouter.get(\"/message/:messageId\", controllers.getMessageReactions);\nreactionRouter.post(\"/\", controllers.addReaction);\nreactionRouter.delete(\"/:reactionId\", controllers.removeReaction);\n\n// --- Polls ---\nconst pollRouter = Router();\npollRouter.post(\"/:pollId/vote\", controllers.castPollVote);\n\n// --- Link Preview ---\nconst linkPreviewRouter = Router();\nlinkPreviewRouter.get(\"/\", controllers.getLinkPreview);\n\n// Mount all messaging-related routes\nrouter.use(\"/messages\", messageRouter);\nrouter.use(\"/conversations\", conversationRouter);\nrouter.use(\"/threads\", threadRouter);\nrouter.use(\"/reactions\", reactionRouter);\nrouter.use(\"/polls\", pollRouter);\nrouter.use(\"/link-preview\", linkPreviewRouter);\n\nexport default router;\n","import { Request, Response } from \"express\";\nimport { prisma } from \"@/shared/core/db\";\nimport { ApiResponse } from \"@/shared/utils/api-response\";\nimport logger from \"@/shared/core/logger\";\nimport { MessageService } from \"./services\";\nimport { PinService } from \"./pin.service\";\nimport { PollService } from \"./poll.service\";\nimport { findOrCreateConversation } from \"./services\";\nimport { events, POLL_EVENTS, MESSAGE_EVENTS } from \"@/shared/core/events\";\nimport axios from \"axios\";\n\n/**\n * Create a channel message\n */\nexport const createChannelMessage = async (req: Request, res: Response) => {\n  try {\n    const { content, fileUrl, isEncrypted, parentId, poll } = req.body;\n    const { serverId, channelId } = req.query;\n    const userId = res.locals.userId;\n\n    if (!serverId || !channelId) {\n      return ApiResponse.error(res, \"Server ID or Channel ID missing\", 400);\n    }\n\n    console.time(`[CREATE_CHANNEL_MESSAGE] Total: ${userId}`);\n    const message = await MessageService.createChannelMessage({\n      content,\n      fileUrl,\n      isEncrypted,\n      parentId,\n      serverId: serverId as string,\n      channelId: channelId as string,\n      userId,\n      poll,\n    });\n    console.timeEnd(`[CREATE_CHANNEL_MESSAGE] Total: ${userId}`);\n\n    return ApiResponse.success(res, message, \"Message created\", 201);\n  } catch (error: any) {\n    logger.error(\"[CREATE_CHANNEL_MESSAGE]\", error);\n    const status =\n      error.message === \"Member not found in this server\" ? 404 : 500;\n    return ApiResponse.error(\n      res,\n      error.message || \"Internal server error\",\n      status,\n    );\n  }\n};\n\n/**\n * Create a direct message\n */\nexport const createDirectMessage = async (req: Request, res: Response) => {\n  try {\n    const { content, fileUrl, isEncrypted, parentId, poll } = req.body;\n    const { conversationId } = req.query;\n    const userId = res.locals.userId;\n\n    if (!conversationId) {\n      return ApiResponse.error(res, \"Conversation ID missing\", 400);\n    }\n\n    const message = await MessageService.createDirectMessage({\n      content,\n      fileUrl,\n      isEncrypted,\n      parentId,\n      conversationId: conversationId as string,\n      userId,\n      poll,\n    });\n\n    return ApiResponse.success(res, message, \"Direct message created\", 201);\n  } catch (error: any) {\n    logger.error(\"[CREATE_DIRECT_MESSAGE]\", error);\n    const status =\n      error.message === \"Member not found in conversation\" ? 404 : 500;\n    return ApiResponse.error(\n      res,\n      error.message || \"Internal server error\",\n      status,\n    );\n  }\n};\n\n/**\n * Update a message\n */\nexport const updateMessage = async (req: Request, res: Response) => {\n  try {\n    const { messageId } = req.params;\n    const { content } = req.body;\n    const { serverId, conversationId } = req.query;\n    const userId = res.locals.userId;\n\n    if (!content) {\n      return ApiResponse.error(res, \"Content missing\", 400);\n    }\n\n    const updatedMessage = await MessageService.updateMessage({\n      messageId,\n      content,\n      userId,\n      serverId: serverId as string,\n      conversationId: conversationId as string,\n    });\n\n    return ApiResponse.success(res, updatedMessage, \"Message updated\");\n  } catch (error: any) {\n    logger.error(\"[UPDATE_MESSAGE]\", error);\n    return ApiResponse.error(res, error.message || \"Internal server error\");\n  }\n};\n\n/**\n * Delete a message\n */\nexport const deleteMessage = async (req: Request, res: Response) => {\n  try {\n    const { messageId } = req.params;\n    const { serverId, conversationId } = req.query;\n    const userId = res.locals.userId;\n\n    const deletedMessage = await MessageService.deleteMessage({\n      messageId,\n      userId,\n      serverId: serverId as string,\n      conversationId: conversationId as string,\n    });\n\n    return ApiResponse.success(res, deletedMessage, \"Message deleted\");\n  } catch (error: any) {\n    logger.error(\"[DELETE_MESSAGE]\", error);\n    return ApiResponse.error(res, error.message || \"Internal server error\");\n  }\n};\n\n/**\n * Get a conversation between two users\n */\nexport const getConversation = async (req: Request, res: Response) => {\n  const { receiverId } = req.query;\n  try {\n    const conversation = await findOrCreateConversation(\n      res.locals.userId,\n      receiverId as string,\n    );\n    return ApiResponse.success(res, conversation);\n  } catch (err: any) {\n    logger.error(err);\n    return ApiResponse.error(res, err.message);\n  }\n};\n\n/**\n * Send a message (Legacy/Shortcut)\n */\nexport const sendMessageController = async (req: Request, res: Response) => {\n  try {\n    const { message } = req.body;\n    const { receiverId } = req.query;\n    const userId = res.locals.userId;\n\n    const conversation = await findOrCreateConversation(\n      userId,\n      receiverId as string,\n    );\n    if (!conversation)\n      return ApiResponse.error(res, \"Conversation not found\", 404);\n\n    const result = await MessageService.createDirectMessage({\n      content: message,\n      conversationId: conversation.id,\n      userId,\n    });\n\n    return ApiResponse.success(res, result, \"Message sent\", 201);\n  } catch (error: any) {\n    logger.error(error);\n    return ApiResponse.error(res, error.message || \"Internal server error\");\n  }\n};\n\n/**\n * Get messages for a channel or conversation\n */\nexport const getMessages = async (req: Request, res: Response) => {\n  const { receiverId, channelId, cursor } = req.query;\n  const MESSAGES_BATCH = 10;\n\n  try {\n    let messages = [];\n\n    if (channelId) {\n      messages = await prisma.message.findMany({\n        take: MESSAGES_BATCH,\n        ...(cursor && { skip: 1, cursor: { id: cursor as string } }),\n        where: { channelId: channelId as string },\n        include: {\n          member: { include: { profile: true } },\n          poll: {\n            include: {\n              options: {\n                include: {\n                  votes: true,\n                  _count: { select: { votes: true } },\n                },\n              },\n            },\n          },\n        },\n        orderBy: { createdAt: \"desc\" },\n      });\n    } else if (receiverId) {\n      const conversation = await findOrCreateConversation(\n        res.locals.userId,\n        receiverId as string,\n      );\n\n      if (!conversation) {\n        return ApiResponse.error(res, \"Conversation not found\", 404);\n      }\n\n      messages = await prisma.directMessage.findMany({\n        take: MESSAGES_BATCH,\n        ...(cursor && { skip: 1, cursor: { id: cursor as string } }),\n        where: { conversationId: conversation.id },\n        include: { member: { include: { profile: true } } },\n        orderBy: { createdAt: \"desc\" },\n      });\n    } else {\n      return ApiResponse.error(res, \"receiverId or channelId required\", 400);\n    }\n\n    let nextCursor = null;\n    if (messages.length === MESSAGES_BATCH) {\n      nextCursor = messages[MESSAGES_BATCH - 1].id;\n    }\n\n    return ApiResponse.success(res, {\n      items: messages,\n      nextCursor,\n    });\n  } catch (error) {\n    logger.error(\"[GET_MESSAGES]\", error);\n    return ApiResponse.error(res, \"Internal server error\");\n  }\n};\n\n/**\n * Get all active conversations for the current user\n */\nexport const getConversations = async (req: Request, res: Response) => {\n  try {\n    const { serverId } = req.query;\n    const userId = res.locals.userId;\n\n    const profile = await prisma.profile.findFirst({\n      where: {\n        userId: userId,\n      },\n      select: {\n        id: true,\n        userId: true,\n        members: serverId\n          ? {\n              where: { serverId: serverId as string },\n              select: { id: true, serverId: true },\n            }\n          : {\n              select: { id: true, serverId: true },\n            },\n      },\n    });\n\n    if (!profile) {\n      logger.warn(\n        `[ConversationController] No profile found for userId=${userId}`,\n      );\n      return ApiResponse.error(res, \"Profile not found\", 404);\n    }\n\n    let memberIds: string[] = [];\n\n    if (serverId) {\n      const currentMember = profile.members.find(\n        (m) => m.serverId === (serverId as string),\n      );\n\n      if (!currentMember) {\n        return ApiResponse.error(res, \"Member not found in this server\", 404);\n      }\n      memberIds = [currentMember.id];\n    } else {\n      memberIds = profile.members.map((m) => m.id);\n    }\n\n    if (memberIds.length === 0) {\n      return ApiResponse.success(res, {\n        conversations: [],\n        currentMemberId: null,\n      });\n    }\n\n    const conversations = await prisma.conversation.findMany({\n      where: {\n        OR: [\n          { memberOneId: { in: memberIds } },\n          { memberTwoId: { in: memberIds } },\n        ],\n      },\n      include: {\n        memberOne: {\n          include: {\n            profile: true,\n            server: true,\n          },\n        },\n        memberTwo: {\n          include: {\n            profile: true,\n            server: true,\n          },\n        },\n        directMessages: {\n          take: 1,\n          orderBy: {\n            createdAt: \"desc\",\n          },\n        },\n      },\n    });\n\n    const activeConversations = conversations\n      .filter((conv) => conv.directMessages.length > 0)\n      .sort((a, b) => {\n        const aTime = a.directMessages[0]?.createdAt.getTime() || 0;\n        const bTime = b.directMessages[0]?.createdAt.getTime() || 0;\n        return bTime - aTime;\n      });\n\n    return ApiResponse.success(res, {\n      conversations: activeConversations,\n      currentMemberIds: memberIds,\n    });\n  } catch (error) {\n    logger.error(\"[GET_CONVERSATIONS]\", error);\n    return ApiResponse.error(res, \"Internal server error\");\n  }\n};\n\n/**\n * Get thread metadata for a channel message\n */\nexport const getChannelThreadMetadata = async (req: Request, res: Response) => {\n  try {\n    const { messageId } = req.params;\n\n    if (!messageId) {\n      return ApiResponse.error(res, \"Message ID missing\", 400);\n    }\n\n    const replies = await prisma.message.findMany({\n      where: {\n        parentId: messageId,\n        deleted: false,\n      },\n      include: {\n        member: {\n          include: {\n            profile: true,\n          },\n        },\n      },\n      orderBy: {\n        createdAt: \"desc\",\n      },\n    });\n\n    const participantsMap = new Map();\n    replies.forEach((reply) => {\n      if (!participantsMap.has(reply.member.profile.id)) {\n        participantsMap.set(reply.member.profile.id, {\n          id: reply.member.profile.id,\n          name: reply.member.profile.name,\n          imageUrl: reply.member.profile.imageUrl,\n        });\n      }\n    });\n\n    const participants = Array.from(participantsMap.values());\n    const lastReplyAt = replies.length > 0 ? replies[0].createdAt : null;\n\n    return ApiResponse.success(res, {\n      replyCount: replies.length,\n      participants,\n      lastReplyAt,\n    });\n  } catch (error) {\n    logger.error(\"[GET_CHANNEL_THREAD_METADATA]\", error);\n    return ApiResponse.error(res, \"Internal server error\");\n  }\n};\n\n/**\n * Get thread metadata for a direct message\n */\nexport const getDirectThreadMetadata = async (req: Request, res: Response) => {\n  try {\n    const { messageId } = req.params;\n\n    if (!messageId) {\n      return ApiResponse.error(res, \"Message ID missing\", 400);\n    }\n\n    const replies = await prisma.directMessage.findMany({\n      where: {\n        parentId: messageId,\n        deleted: false,\n      },\n      include: {\n        member: {\n          include: {\n            profile: true,\n          },\n        },\n      },\n      orderBy: {\n        createdAt: \"desc\",\n      },\n    });\n\n    const participantsMap = new Map();\n    replies.forEach((reply) => {\n      if (!participantsMap.has(reply.member.profile.id)) {\n        participantsMap.set(reply.member.profile.id, {\n          id: reply.member.profile.id,\n          name: reply.member.profile.name,\n          imageUrl: reply.member.profile.imageUrl,\n        });\n      }\n    });\n\n    const participants = Array.from(participantsMap.values());\n    const lastReplyAt = replies.length > 0 ? replies[0].createdAt : null;\n\n    return ApiResponse.success(res, {\n      replyCount: replies.length,\n      participants,\n      lastReplyAt,\n    });\n  } catch (error) {\n    logger.error(\"[GET_DIRECT_THREAD_METADATA]\", error);\n    return ApiResponse.error(res, \"Internal server error\");\n  }\n};\n\n/**\n * Add emoji reaction to message\n */\nexport const addReaction = async (req: Request, res: Response) => {\n  try {\n    const userId = res.locals.userId;\n    if (!userId) return ApiResponse.error(res, \"Unauthorized\", 401);\n\n    const { emoji, messageId, directMessageId } = req.body;\n\n    if (!emoji || (!messageId && !directMessageId)) {\n      return ApiResponse.error(res, \"Missing required fields\", 400);\n    }\n\n    const reaction = await ReactionService.addReaction({\n      userId,\n      emoji,\n      messageId,\n      directMessageId,\n    });\n\n    return ApiResponse.success(res, reaction, \"Reaction added\");\n  } catch (error: any) {\n    logger.error(\"[ADD_REACTION]\", error);\n    const status = error.message === \"Profile not found\" ? 404 : 500;\n    return ApiResponse.error(\n      res,\n      error.message || \"Internal server error\",\n      status,\n    );\n  }\n};\n\n/**\n * Remove reaction\n */\nexport const removeReaction = async (req: Request, res: Response) => {\n  try {\n    const { reactionId } = req.params;\n    const userId = res.locals.userId;\n    if (!userId) return ApiResponse.error(res, \"Unauthorized\", 401);\n\n    await ReactionService.removeReaction({\n      userId,\n      reactionId,\n    });\n\n    return ApiResponse.success(res, { success: true }, \"Reaction removed\");\n  } catch (error: any) {\n    logger.error(\"[REMOVE_REACTION]\", error);\n    const status = error.message === \"Profile not found\" ? 404 : 500;\n    return ApiResponse.error(\n      res,\n      error.message || \"Internal server error\",\n      status,\n    );\n  }\n};\n\n/**\n * Get all reactions for a message\n */\nexport const getMessageReactions = async (req: Request, res: Response) => {\n  try {\n    const { messageId } = req.params;\n    const { type } = req.query; // \"channel\" or \"direct\"\n\n    const reactions = await prisma.reaction.findMany({\n      where: type === \"direct\" ? { directMessageId: messageId } : { messageId },\n      include: {\n        profile: {\n          select: { id: true, name: true, imageUrl: true },\n        },\n      },\n      orderBy: { createdAt: \"asc\" },\n    });\n\n    const groupedReactions = reactions.reduce(\n      (acc, reaction) => {\n        if (!acc[reaction.emoji]) {\n          acc[reaction.emoji] = [];\n        }\n        acc[reaction.emoji].push(reaction);\n        return acc;\n      },\n      {} as Record<string, typeof reactions>,\n    );\n\n    return ApiResponse.success(res, groupedReactions);\n  } catch (error) {\n    logger.error(\"[GET_MESSAGE_REACTIONS]\", error);\n    return ApiResponse.error(res, \"Internal server error\");\n  }\n};\n\n/**\n * Get link preview for a URL\n */\nexport const getLinkPreview = async (req: Request, res: Response) => {\n  try {\n    const { url } = req.query;\n\n    if (!url || typeof url !== \"string\") {\n      return ApiResponse.error(res, \"URL is required\", 400);\n    }\n\n    const apiKey = process.env.OPENGRAPH_IO_KEY;\n\n    if (!apiKey) {\n      logger.error(\"[LinkPreview] OPENGRAPH_IO_KEY is missing\");\n      return ApiResponse.error(\n        res,\n        \"Link preview service is not configured.\",\n        500,\n      );\n    }\n\n    const opengraphUrl = `https://opengraph.io/api/1.1/site/${encodeURIComponent(url)}?app_id=${apiKey}`;\n    const response = await axios.get(opengraphUrl, { timeout: 10000 });\n    const data = response.data;\n\n    if (data.error) {\n      return ApiResponse.error(res, data.error.message, 400);\n    }\n\n    const hybrid = data.hybridGraph || {};\n    const openGraph = data.openGraph || {};\n    const htmlInferred = data.htmlInferred || {};\n\n    let fallbackTitle = url;\n    try {\n      fallbackTitle = new URL(url).hostname;\n    } catch (e) {\n      /* Ignore */\n    }\n\n    return ApiResponse.success(\n      res,\n      {\n        title:\n          hybrid.title ||\n          openGraph.title ||\n          htmlInferred.title ||\n          fallbackTitle,\n        description:\n          hybrid.description ||\n          openGraph.description ||\n          htmlInferred.description ||\n          \"\",\n        image: hybrid.image || openGraph.image || htmlInferred.image || null,\n        favIcon: data.favicon || null,\n        url: data.url || url,\n      },\n      \"Link preview fetched\",\n    );\n  } catch (error: any) {\n    logger.error(`[LinkPreview] Error: ${error.message}`);\n    return ApiResponse.error(res, \"Failed to fetch link preview\");\n  }\n};\n\nconst ReactionService = {\n  addReaction: async (payload: any) => {\n    // This will be properly defined in services.ts, but for now we keep the reference\n    // Actually, I should probably call the real service in services.ts\n    const { ReactionService: RealReactionService } = require(\"./services\");\n    return await RealReactionService.addReaction(payload);\n  },\n  removeReaction: async (payload: any) => {\n    const { ReactionService: RealReactionService } = require(\"./services\");\n    return await RealReactionService.removeReaction(payload);\n  },\n};\n\n/**\n * Pin a message\n */\nexport const pinMessage = async (req: Request, res: Response) => {\n  try {\n    const { messageId } = req.params;\n    const { serverId, conversationId } = req.query;\n    const userId = res.locals.userId;\n\n    const message = await PinService.pinMessage({\n      messageId,\n      userId,\n      serverId: serverId as string,\n      conversationId: conversationId as string,\n    });\n\n    events.emit(MESSAGE_EVENTS.UPDATED, {\n      message,\n      type: serverId ? \"channel\" : \"direct\",\n      contextId: serverId\n        ? (message as any).channelId\n        : (message as any).conversationId,\n    });\n\n    return ApiResponse.success(res, message, \"Message pinned\");\n  } catch (error: any) {\n    logger.error(\"[PIN_MESSAGE]\", error);\n    return ApiResponse.error(res, error.message || \"Internal server error\");\n  }\n};\n\n/**\n * Unpin a message\n */\nexport const unpinMessage = async (req: Request, res: Response) => {\n  try {\n    const { messageId } = req.params;\n    const { serverId, conversationId } = req.query;\n    const userId = res.locals.userId;\n\n    const message = await PinService.unpinMessage({\n      messageId,\n      userId,\n      serverId: serverId as string,\n      conversationId: conversationId as string,\n    });\n\n    events.emit(MESSAGE_EVENTS.UPDATED, {\n      message,\n      type: serverId ? \"channel\" : \"direct\",\n      contextId: serverId\n        ? (message as any).channelId\n        : (message as any).conversationId,\n    });\n\n    return ApiResponse.success(res, message, \"Message unpinned\");\n  } catch (error: any) {\n    logger.error(\"[UNPIN_MESSAGE]\", error);\n    return ApiResponse.error(res, error.message || \"Internal server error\");\n  }\n};\n\n/**\n * Cast a vote in a poll\n */\nexport const castPollVote = async (req: Request, res: Response) => {\n  try {\n    const { pollId } = req.params;\n    const { optionId } = req.body;\n    const userId = res.locals.userId;\n\n    if (!optionId) {\n      return ApiResponse.error(res, \"Option ID missing\", 400);\n    }\n\n    await PollService.castVote({\n      pollId,\n      userId,\n      optionId,\n    });\n\n    const updatedPoll = await PollService.getPollResults(pollId);\n\n    events.emit(POLL_EVENTS.VOTED, { poll: updatedPoll });\n\n    return ApiResponse.success(res, updatedPoll, \"Vote cast successfully\");\n  } catch (error: any) {\n    logger.error(\"[CAST_POLL_VOTE]\", error);\n    return ApiResponse.error(res, error.message || \"Internal server error\");\n  }\n};\n","import { prisma } from \"@/shared/core/db\";\nimport { MemberService } from \"@/core/servers/services\";\nimport {\n  NotFoundError,\n  UnauthorizedError,\n  BadRequestError,\n} from \"@/shared/utils/errors\";\n\nexport class PinService {\n  /**\n   * Pin a message\n   */\n  public static async pinMessage(payload: {\n    messageId: string;\n    userId: string;\n    serverId?: string;\n    conversationId?: string;\n  }) {\n    return this.setPinStatus({ ...payload, isPinned: true });\n  }\n\n  /**\n   * Unpin a message\n   */\n  public static async unpinMessage(payload: {\n    messageId: string;\n    userId: string;\n    serverId?: string;\n    conversationId?: string;\n  }) {\n    return this.setPinStatus({ ...payload, isPinned: false });\n  }\n\n  /**\n   * Shared logic for pinning/unpinning (DRY)\n   */\n  private static async setPinStatus(payload: {\n    messageId: string;\n    userId: string;\n    isPinned: boolean;\n    serverId?: string;\n    conversationId?: string;\n  }) {\n    const { messageId, userId, isPinned, serverId, conversationId } = payload;\n\n    const member = await MemberService.resolveMember(userId, {\n      serverId,\n      conversationId,\n    });\n\n    if (!member) throw new UnauthorizedError(\"Member not found\");\n\n    if (serverId) {\n      // In servers, only Admin/Moderator can pin\n      if (![\"ADMIN\", \"MODERATOR\"].includes(member.role)) {\n        throw new UnauthorizedError(\n          \"Insufficient permissions to manage pinned messages\",\n        );\n      }\n\n      const message = await prisma.message.findFirst({\n        where: { id: messageId, channel: { serverId } },\n      });\n\n      if (!message) throw new NotFoundError(\"Message not found in this server\");\n\n      return await prisma.message.update({\n        where: { id: messageId },\n        data: { isPinned },\n        include: { member: { include: { profile: true } } },\n      });\n    } else if (conversationId) {\n      // In DMs, either participant can pin\n      const message = await prisma.directMessage.findFirst({\n        where: { id: messageId, conversationId },\n      });\n\n      if (!message)\n        throw new NotFoundError(\"Message not found in this conversation\");\n\n      return await prisma.directMessage.update({\n        where: { id: messageId },\n        data: { isPinned },\n        include: { member: { include: { profile: true } } },\n      });\n    }\n\n    throw new BadRequestError(\n      \"Context missing (serverId or conversationId required)\",\n    );\n  }\n}\n","import { prisma } from \"@/shared/core/db\";\nimport { getProfileByUserId } from \"@/core/users/services\";\nimport { BadRequestError, NotFoundError } from \"@/shared/utils/errors\";\n\nexport class PollService {\n  /**\n   * Create a new poll attached to a message\n   */\n  public static async createPoll(payload: {\n    question: string;\n    options: string[];\n    expiresAt?: Date;\n    messageId?: string;\n    directMessageId?: string;\n  }) {\n    const { question, options, expiresAt, messageId, directMessageId } =\n      payload;\n\n    if (!options || options.length < 2) {\n      throw new BadRequestError(\"A poll must have at least 2 options\");\n    }\n\n    return await prisma.poll.create({\n      data: {\n        question,\n        expiresAt,\n        messageId,\n        directMessageId,\n        options: {\n          create: options.map((text) => ({ text })),\n        },\n      },\n      include: {\n        options: {\n          include: {\n            votes: true,\n            _count: {\n              select: { votes: true },\n            },\n          },\n        },\n      },\n    });\n  }\n\n  /**\n   * Cast a vote in a poll\n   */\n  public static async castVote(payload: {\n    pollId: string;\n    userId: string;\n    optionId: string;\n  }) {\n    const { pollId, userId, optionId } = payload;\n\n    const profile = await getProfileByUserId(userId);\n    if (!profile) throw new NotFoundError(\"Profile not found\");\n\n    // Check if poll exists and isn't expired\n    const poll = await prisma.poll.findUnique({\n      where: { id: pollId },\n    });\n\n    if (!poll) throw new NotFoundError(\"Poll not found\");\n    if (poll.expiresAt && poll.expiresAt < new Date()) {\n      throw new BadRequestError(\"This poll has expired\");\n    }\n\n    const existingVote = await prisma.pollVote.findUnique({\n      where: {\n        profileId_pollId: {\n          profileId: profile.id,\n          pollId,\n        },\n      },\n    });\n\n    if (existingVote) {\n      // If clicking the same option, remove the vote (Toggle behavior)\n      if (existingVote.optionId === optionId) {\n        return await prisma.pollVote.delete({\n          where: { id: existingVote.id },\n        });\n      }\n\n      // Change vote to a different option\n      return await prisma.pollVote.update({\n        where: { id: existingVote.id },\n        data: { optionId },\n      });\n    }\n\n    // New vote\n    return await prisma.pollVote.create({\n      data: {\n        profileId: profile.id,\n        pollId,\n        optionId,\n      },\n    });\n  }\n\n  /**\n   * Get poll results with vote counts\n   */\n  public static async getPollResults(pollId: string) {\n    return await prisma.poll.findUnique({\n      where: { id: pollId },\n      include: {\n        options: {\n          include: {\n            votes: true,\n            _count: {\n              select: { votes: true },\n            },\n          },\n        },\n      },\n    });\n  }\n}\n","import { AnyZodObject } from \"zod\";\nimport { Request, Response, NextFunction } from \"express\";\nimport logger from \"@/shared/core/logger\";\n\nconst validator =\n  (schema: AnyZodObject) =>\n  (req: Request, res: Response, next: NextFunction) => {\n    try {\n      schema.parse({\n        body: req.body,\n        query: req.query,\n        params: req.params,\n      });\n      next();\n    } catch (err: any) {\n      logger.error(\"[ValidationMiddleware] Validation error:\", err);\n      return res.status(400).send(err.errors);\n    }\n  };\n\nexport default validator;\n","import { z } from \"zod\";\n\n/**\n * Schema for creating a channel message\n */\nexport const createChannelMessageSchema = z.object({\n  body: z.object({\n    content: z.string().min(1).max(5000),\n    fileUrl: z.string().url().optional().nullable(),\n    isEncrypted: z.boolean().optional(),\n  }),\n  query: z.object({\n    serverId: z.string().min(1),\n    channelId: z.string().min(1),\n  }),\n});\n\n/**\n * Schema for creating a direct message\n */\nexport const createDirectMessageSchema = z.object({\n  body: z.object({\n    content: z.string().min(1).max(5000),\n    fileUrl: z.string().url().optional().nullable(),\n    isEncrypted: z.boolean().optional(),\n  }),\n  query: z.object({\n    conversationId: z.string().min(1),\n  }),\n});\n\nexport const updateMessageSchema = z.object({\n  params: z.object({\n    messageId: z.string().min(1),\n  }),\n  body: z.object({\n    content: z.string().min(1).max(5000),\n  }),\n  query: z.object({\n    serverId: z.string().optional(),\n    channelId: z.string().optional(),\n    conversationId: z.string().optional(),\n  }),\n});\n\n/**\n * Schema for deleting a message\n */\nexport const deleteMessageSchema = z.object({\n  params: z.object({\n    messageId: z.string().min(1),\n  }),\n  query: z.object({\n    serverId: z.string().optional(),\n    channelId: z.string().optional(),\n    conversationId: z.string().optional(),\n  }),\n});\n\n// Backward compatibility or other uses\nexport const conversationSchema = z.object({\n  query: z.object({\n    receiverId: z.string().min(1),\n  }),\n});\n\nexport const sendMessageSchema = z.object({\n  body: z.object({\n    message: z.string().min(1),\n  }),\n  query: z.object({\n    receiverId: z.string().min(1),\n  }),\n});\n","import { Router } from \"express\";\nimport * as controllers from \"./controllers\";\n\nconst router = Router();\n\n// --- Channels ---\nconst channelRouter = Router();\nchannelRouter.get(\"/server/:serverId\", controllers.getServerChannels);\nchannelRouter.get(\"/:channelId\", controllers.getChannel);\nchannelRouter.post(\"/\", controllers.createChannel);\nchannelRouter.patch(\"/:channelId\", controllers.updateChannel);\nchannelRouter.delete(\"/:channelId\", controllers.deleteChannel);\n\n// --- Members ---\nconst memberRouter = Router();\nmemberRouter.get(\"/server/:serverId\", controllers.getServerMembers);\nmemberRouter.get(\"/:memberId\", controllers.getMember);\nmemberRouter.patch(\"/:memberId\", controllers.updateMemberRole);\nmemberRouter.delete(\"/:memberId\", controllers.kickMember);\n\n// Mount routes\nrouter.use(\"/channels\", channelRouter);\nrouter.use(\"/members\", memberRouter);\n\nexport default router;\n","import { Request, Response } from \"express\";\nimport { prisma } from \"@/shared/core/db\";\nimport { ApiResponse } from \"@/shared/utils/api-response\";\nimport logger from \"@/shared/core/logger\";\n\n/**\n * Get channel information\n */\nexport const getChannel = async (req: Request, res: Response) => {\n  try {\n    const { channelId } = req.params;\n    const channel = await prisma.channel.findUnique({\n      where: { id: channelId },\n    });\n    return ApiResponse.success(res, channel);\n  } catch (error) {\n    logger.error(\"[GET_CHANNEL]\", error);\n    return ApiResponse.error(res, \"Internal server error\");\n  }\n};\n\n/**\n * Get all channels for a server\n */\nexport const getServerChannels = async (req: Request, res: Response) => {\n  try {\n    const { serverId } = req.params;\n    const userId = res.locals.userId;\n\n    if (!serverId) {\n      return ApiResponse.error(res, \"Server ID missing\", 400);\n    }\n\n    const currentMember = await prisma.member.findFirst({\n      where: {\n        serverId,\n        profile: { userId },\n      },\n    });\n\n    if (!currentMember) {\n      return ApiResponse.error(res, \"Forbidden\", 403);\n    }\n\n    const channels = await prisma.channel.findMany({\n      where: { serverId },\n      orderBy: { createdAt: \"asc\" },\n    });\n\n    return ApiResponse.success(res, channels);\n  } catch (error) {\n    logger.error(\"[GET_SERVER_CHANNELS]\", error);\n    return ApiResponse.error(res, \"Internal server error\");\n  }\n};\n\n/**\n * Get member information\n */\nexport const getMember = async (req: Request, res: Response) => {\n  try {\n    const { memberId } = req.params;\n    const member = await prisma.member.findUnique({\n      where: { id: memberId },\n      include: { profile: true },\n    });\n    return ApiResponse.success(res, member);\n  } catch (error) {\n    logger.error(\"[GET_MEMBER]\", error);\n    return ApiResponse.error(res, \"Internal server error\");\n  }\n};\n\n/**\n * Get all members for a server\n */\nexport const getServerMembers = async (req: Request, res: Response) => {\n  try {\n    const { serverId } = req.params;\n    const userId = res.locals.userId;\n\n    if (!serverId) {\n      return ApiResponse.error(res, \"Server ID missing\", 400);\n    }\n\n    const currentMember = await prisma.member.findFirst({\n      where: {\n        serverId,\n        profile: { userId },\n      },\n    });\n\n    if (!currentMember) {\n      return ApiResponse.error(res, \"Forbidden\", 403);\n    }\n\n    const members = await prisma.member.findMany({\n      where: { serverId },\n      include: { profile: true },\n      orderBy: { role: \"asc\" },\n    });\n\n    return ApiResponse.success(res, members);\n  } catch (error) {\n    logger.error(\"[GET_SERVER_MEMBERS]\", error);\n    return ApiResponse.error(res, \"Internal server error\");\n  }\n};\n\n/**\n * Create a new channel\n */\nexport const createChannel = async (req: Request, res: Response) => {\n  try {\n    const { serverId } = req.query;\n    const { name, type } = req.body;\n    const userId = res.locals.userId;\n\n    if (!serverId || typeof serverId !== \"string\") {\n      return ApiResponse.error(res, \"Server ID missing\", 400);\n    }\n\n    if (!name) {\n      return ApiResponse.error(res, \"Channel name is required\", 400);\n    }\n\n    const currentMember = await prisma.member.findFirst({\n      where: {\n        serverId,\n        profile: { userId },\n        role: { in: [\"ADMIN\", \"MODERATOR\"] },\n      },\n    });\n\n    if (!currentMember) {\n      return ApiResponse.error(res, \"Forbidden\", 403);\n    }\n\n    const server = await prisma.server.update({\n      where: { id: serverId },\n      data: {\n        channels: {\n          create: {\n            name,\n            type: type || \"TEXT\",\n            profileId: currentMember.profileId,\n          },\n        },\n      },\n      include: {\n        channels: { orderBy: { createdAt: \"asc\" } },\n        members: { include: { profile: true }, orderBy: { role: \"asc\" } },\n      },\n    });\n\n    return ApiResponse.success(res, server);\n  } catch (error) {\n    logger.error(\"[CREATE_CHANNEL]\", error);\n    return ApiResponse.error(res, \"Internal server error\");\n  }\n};\n\n/**\n * Update a channel\n */\nexport const updateChannel = async (req: Request, res: Response) => {\n  try {\n    const { channelId } = req.params;\n    const { serverId } = req.query;\n    const { name, type } = req.body;\n    const userId = res.locals.userId;\n\n    if (!serverId || typeof serverId !== \"string\") {\n      return ApiResponse.error(res, \"Server ID missing\", 400);\n    }\n\n    if (!channelId) {\n      return ApiResponse.error(res, \"Channel ID missing\", 400);\n    }\n\n    const currentMember = await prisma.member.findFirst({\n      where: {\n        serverId,\n        profile: { userId },\n        role: { in: [\"ADMIN\", \"MODERATOR\"] },\n      },\n    });\n\n    if (!currentMember) {\n      return ApiResponse.error(res, \"Forbidden\", 403);\n    }\n\n    const channel = await prisma.channel.findFirst({\n      where: { id: channelId, serverId },\n    });\n\n    if (!channel) {\n      return ApiResponse.error(res, \"Channel not found\", 404);\n    }\n\n    if (channel.name === \"general\") {\n      return ApiResponse.error(res, \"Cannot edit general channel\", 400);\n    }\n\n    const server = await prisma.server.update({\n      where: { id: serverId },\n      data: {\n        channels: {\n          update: {\n            where: { id: channelId },\n            data: { name, type },\n          },\n        },\n      },\n      include: {\n        channels: { orderBy: { createdAt: \"asc\" } },\n        members: { include: { profile: true }, orderBy: { role: \"asc\" } },\n      },\n    });\n\n    return ApiResponse.success(res, server);\n  } catch (error) {\n    logger.error(\"[UPDATE_CHANNEL]\", error);\n    return ApiResponse.error(res, \"Internal server error\");\n  }\n};\n\n/**\n * Delete a channel\n */\nexport const deleteChannel = async (req: Request, res: Response) => {\n  try {\n    const { channelId } = req.params;\n    const { serverId } = req.query;\n    const userId = res.locals.userId;\n\n    if (!serverId || typeof serverId !== \"string\") {\n      return ApiResponse.error(res, \"Server ID missing\", 400);\n    }\n\n    if (!channelId) {\n      return ApiResponse.error(res, \"Channel ID missing\", 400);\n    }\n\n    const currentMember = await prisma.member.findFirst({\n      where: {\n        serverId,\n        profile: { userId },\n        role: { in: [\"ADMIN\", \"MODERATOR\"] },\n      },\n    });\n\n    if (!currentMember) {\n      return ApiResponse.error(res, \"Forbidden\", 403);\n    }\n\n    const channel = await prisma.channel.findFirst({\n      where: { id: channelId, serverId },\n    });\n\n    if (!channel) {\n      return ApiResponse.error(res, \"Channel not found\", 404);\n    }\n\n    if (channel.name === \"general\") {\n      return ApiResponse.error(res, \"Cannot delete general channel\", 400);\n    }\n\n    const server = await prisma.server.update({\n      where: { id: serverId },\n      data: {\n        channels: {\n          delete: { id: channelId },\n        },\n      },\n      include: {\n        channels: { orderBy: { createdAt: \"asc\" } },\n        members: { include: { profile: true }, orderBy: { role: \"asc\" } },\n      },\n    });\n\n    return ApiResponse.success(res, server);\n  } catch (error) {\n    logger.error(\"[DELETE_CHANNEL]\", error);\n    return ApiResponse.error(res, \"Internal server error\");\n  }\n};\n\n/**\n * Update member role\n */\nexport const updateMemberRole = async (req: Request, res: Response) => {\n  try {\n    const { memberId } = req.params;\n    const { serverId } = req.query;\n    const { role } = req.body;\n    const userId = res.locals.userId;\n\n    if (!serverId || typeof serverId !== \"string\") {\n      return ApiResponse.error(res, \"Server ID missing\", 400);\n    }\n\n    if (!memberId) {\n      return ApiResponse.error(res, \"Member ID missing\", 400);\n    }\n\n    const currentMember = await prisma.member.findFirst({\n      where: {\n        serverId,\n        profile: { userId },\n        role: \"ADMIN\",\n      },\n    });\n\n    if (!currentMember) {\n      return ApiResponse.error(res, \"Forbidden\", 403);\n    }\n\n    const server = await prisma.server.update({\n      where: { id: serverId },\n      data: {\n        members: {\n          update: {\n            where: { id: memberId },\n            data: { role },\n          },\n        },\n      },\n      include: {\n        channels: { orderBy: { createdAt: \"asc\" } },\n        members: { include: { profile: true }, orderBy: { role: \"asc\" } },\n      },\n    });\n\n    return ApiResponse.success(res, server);\n  } catch (error) {\n    logger.error(\"[UPDATE_MEMBER_ROLE]\", error);\n    return ApiResponse.error(res, \"Internal server error\");\n  }\n};\n\n/**\n * Kick member from server\n */\nexport const kickMember = async (req: Request, res: Response) => {\n  try {\n    const { memberId } = req.params;\n    const { serverId } = req.query;\n    const userId = res.locals.userId;\n\n    if (!serverId || typeof serverId !== \"string\") {\n      return ApiResponse.error(res, \"Server ID missing\", 400);\n    }\n\n    if (!memberId) {\n      return ApiResponse.error(res, \"Member ID missing\", 400);\n    }\n\n    const currentMember = await prisma.member.findFirst({\n      where: {\n        serverId,\n        profile: { userId },\n        role: \"ADMIN\",\n      },\n    });\n\n    if (!currentMember) {\n      return ApiResponse.error(res, \"Forbidden\", 403);\n    }\n\n    const server = await prisma.server.update({\n      where: { id: serverId },\n      data: {\n        members: {\n          delete: { id: memberId },\n        },\n      },\n      include: {\n        channels: { orderBy: { createdAt: \"asc\" } },\n        members: { include: { profile: true }, orderBy: { role: \"asc\" } },\n      },\n    });\n\n    return ApiResponse.success(res, server);\n  } catch (error) {\n    logger.error(\"[KICK_MEMBER]\", error);\n    return ApiResponse.error(res, \"Internal server error\");\n  }\n};\n","import { Router } from \"express\";\nimport * as controllers from \"./controllers\";\n\nconst router = Router();\n\nrouter.get(\"/notifications\", controllers.getNotifications);\nrouter.get(\"/notifications/unread-count\", controllers.getUnreadCount);\nrouter.patch(\"/notifications/:notificationId/read\", controllers.markAsRead);\nrouter.patch(\"/notifications/mark-all-read\", controllers.markAllAsRead);\nrouter.delete(\"/notifications/:notificationId\", controllers.deleteNotification);\nrouter.delete(\"/notifications/delete-all\", controllers.deleteAllNotifications);\n\nexport default router;\n","import { Request, Response } from \"express\";\nimport { prisma } from \"@/shared/core/db\";\nimport { ApiResponse } from \"@/shared/utils/api-response\";\nimport logger from \"@/shared/core/logger\";\n\n/**\n * Get notifications for the current user\n */\nexport const getNotifications = async (req: Request, res: Response) => {\n  try {\n    const userId = res.locals.userId;\n    const profile = await prisma.profile.findFirst({ where: { userId } });\n    if (!profile) {\n      return ApiResponse.error(res, \"Profile not found\", 404);\n    }\n\n    const notifications = await prisma.notification.findMany({\n      where: { receiverId: profile.id },\n      include: {\n        sender: {\n          select: { id: true, name: true, imageUrl: true },\n        },\n      },\n      orderBy: { createdAt: \"desc\" },\n      take: 50,\n    });\n\n    return ApiResponse.success(res, notifications);\n  } catch (error) {\n    logger.error(\"[GET_NOTIFICATIONS]\", error);\n    return ApiResponse.error(res, \"Internal server error\");\n  }\n};\n\n/**\n * Get unread notification count\n */\nexport const getUnreadCount = async (req: Request, res: Response) => {\n  try {\n    const userId = res.locals.userId;\n    const profile = await prisma.profile.findFirst({ where: { userId } });\n    if (!profile) {\n      return ApiResponse.error(res, \"Profile not found\", 404);\n    }\n\n    const count = await prisma.notification.count({\n      where: {\n        receiverId: profile.id,\n        isRead: false,\n      },\n    });\n\n    return ApiResponse.success(res, { count });\n  } catch (error) {\n    logger.error(\"[GET_UNREAD_COUNT]\", error);\n    return ApiResponse.error(res, \"Internal server error\");\n  }\n};\n\n/**\n * Mark notification as read\n */\nexport const markAsRead = async (req: Request, res: Response) => {\n  try {\n    const { notificationId } = req.params;\n    const userId = res.locals.userId;\n    const profile = await prisma.profile.findFirst({ where: { userId } });\n    if (!profile) return ApiResponse.error(res, \"Profile not found\", 404);\n\n    const notification = await prisma.notification.update({\n      where: {\n        id: notificationId,\n        receiverId: profile.id,\n      },\n      data: { isRead: true },\n    });\n\n    return ApiResponse.success(\n      res,\n      notification,\n      \"Notification marked as read\",\n    );\n  } catch (error) {\n    logger.error(\"[MARK_AS_READ]\", error);\n    return ApiResponse.error(res, \"Internal server error\");\n  }\n};\n\n/**\n * Mark all notifications as read\n */\nexport const markAllAsRead = async (req: Request, res: Response) => {\n  try {\n    const userId = res.locals.userId;\n    const profile = await prisma.profile.findFirst({ where: { userId } });\n    if (!profile) return ApiResponse.error(res, \"Profile not found\", 404);\n\n    await prisma.notification.updateMany({\n      where: {\n        receiverId: profile.id,\n        isRead: false,\n      },\n      data: { isRead: true },\n    });\n\n    return ApiResponse.success(\n      res,\n      { success: true },\n      \"All notifications marked as read\",\n    );\n  } catch (error) {\n    logger.error(\"[MARK_ALL_AS_READ]\", error);\n    return ApiResponse.error(res, \"Internal server error\");\n  }\n};\n\n/**\n * Delete a notification\n */\nexport const deleteNotification = async (req: Request, res: Response) => {\n  try {\n    const { notificationId } = req.params;\n    const userId = res.locals.userId;\n    const profile = await prisma.profile.findFirst({ where: { userId } });\n    if (!profile) return ApiResponse.error(res, \"Profile not found\", 404);\n\n    await prisma.notification.delete({\n      where: {\n        id: notificationId,\n        receiverId: profile.id,\n      },\n    });\n\n    return ApiResponse.success(res, { success: true }, \"Notification deleted\");\n  } catch (error) {\n    logger.error(\"[DELETE_NOTIFICATION]\", error);\n    return ApiResponse.error(res, \"Internal server error\");\n  }\n};\n\n/**\n * Delete all notifications for current user\n */\nexport const deleteAllNotifications = async (req: Request, res: Response) => {\n  try {\n    const userId = res.locals.userId;\n    const profile = await prisma.profile.findFirst({ where: { userId } });\n    if (!profile) return ApiResponse.error(res, \"Profile not found\", 404);\n\n    await prisma.notification.deleteMany({\n      where: { receiverId: profile.id },\n    });\n\n    return ApiResponse.success(\n      res,\n      { success: true },\n      \"All notifications deleted\",\n    );\n  } catch (error) {\n    logger.error(\"[DELETE_ALL_NOTIFICATIONS]\", error);\n    return ApiResponse.error(res, \"Internal server error\");\n  }\n};\n","import { Router } from \"express\";\nimport * as controllers from \"./controllers\";\n\nconst router = Router();\n\nrouter.get(\"/users/me\", controllers.getCurrentUser);\n\nexport default router;\n","import { Request, Response } from \"express\";\nimport { prisma } from \"@/shared/core/db\";\nimport { ApiResponse } from \"@/shared/utils/api-response\";\nimport logger from \"@/shared/core/logger\";\n\n/**\n * Get current user profile\n */\nexport const getCurrentUser = async (req: Request, res: Response) => {\n  try {\n    const userId = res.locals.userId;\n    const user = await prisma.user.findUnique({\n      where: { id: userId },\n      include: { profile: true },\n    });\n    return ApiResponse.success(res, user);\n  } catch (error) {\n    logger.error(\"[GET_CURRENT_USER]\", error);\n    return ApiResponse.error(res, \"Internal server error\");\n  }\n};\n","import http from \"http\";\nimport { Server } from \"socket.io\";\nimport { Application } from \"express\";\nimport logger from \"@/shared/core/logger\";\nimport { socketService } from \"@/shared/core/socket\";\nimport { CustomSocket } from \"@/shared/types\";\n\n// Import modules\nimport { socketAuthMiddleware } from \"./auth\";\nimport { registerMessageHandlers } from \"./messages\";\nimport { registerPresenceHandlers } from \"./presence\";\nimport { registerNotificationHandlers } from \"./notifications\";\nimport { registerRoomHandlers } from \"./rooms\";\n\n// Import event side-effects\nimport \"@/core/messaging/events\";\n\nexport let io: Server;\n\n/**\n * Initialize Socket.IO server and register handlers\n */\nexport const initializeSocket = (\n  httpServer: http.Server,\n  allowedOrigins: string[],\n  app: Application,\n) => {\n  io = new Server(httpServer, {\n    cors: {\n      origin: allowedOrigins,\n      credentials: true,\n      methods: [\"GET\", \"POST\"],\n    },\n    transports: [\"websocket\", \"polling\"],\n    allowEIO3: true,\n  });\n\n  // Initialize SocketService with the io instance\n  socketService.initialize(io);\n\n  // Attach io instance to Express app for controller access\n  app.set(\"io\", io);\n\n  // Register Middleware\n  io.use(socketAuthMiddleware);\n\n  // Connection Handler\n  io.on(\"connection\", (socket: CustomSocket) => {\n    logger.info(`[Socket.io] Client connected: ${socket.id}`);\n\n    // Join user-specific room for targeted emits\n    socket.join(socket.user?.id as string);\n\n    // A catch-all listener for logging in development\n    if (process.env.NODE_ENV !== \"production\") {\n      socket.onAny((event, ...args) => {\n        logger.info(`[Socket Event] ${event}`, args);\n      });\n    }\n\n    // Register modular handlers\n    registerMessageHandlers(io, socket);\n    registerPresenceHandlers(io, socket);\n    registerNotificationHandlers(io, socket);\n    registerRoomHandlers(io, socket);\n  });\n\n  return io;\n};\n","import { Server } from \"socket.io\";\nimport logger from \"@/shared/core/logger\";\n\nclass SocketService {\n  private io: Server | null = null;\n\n  /**\n   * Initialize the service with the Socket.IO instance\n   */\n  public initialize(io: Server): void {\n    this.io = io;\n    logger.info(\"[SocketService] Initialized\");\n  }\n\n  /**\n   * Emit a message to a specific room or channel\n   */\n  public emit(event: string, data: any, room?: string): void {\n    if (!this.io) {\n      logger.error(\"[SocketService] Called before initialization\");\n      return;\n    }\n\n    if (room) {\n      this.io.to(room).emit(event, data);\n    } else {\n      this.io.emit(event, data);\n    }\n  }\n\n  /**\n   * Emit a chat message to a channel or conversation\n   */\n  public emitChatMessage(\n    contextId: string,\n    event: \"messages\" | \"messages:update\",\n    data: any,\n  ): void {\n    const eventKey = `chat:${contextId}:${event}`;\n    this.emit(eventKey, data);\n  }\n\n  /**\n   * Emit a notification to a specific user\n   */\n  public emitNotification(userId: string, data: any): void {\n    this.emit(\"notification:new\", data, `user:${userId}`);\n  }\n}\n\nexport const socketService = new SocketService();\n","import { CustomSocket } from \"@/shared/types\";\nimport { auth } from \"@/core/auth/config\";\nimport { fromNodeHeaders } from \"better-auth/node\";\nimport logger from \"@/shared/core/logger\";\n\n/**\n * Socket.IO authentication middleware\n */\nexport const socketAuthMiddleware = async (\n  socket: CustomSocket,\n  next: (err?: Error) => void,\n) => {\n  logger.info(\"[Socket.io] New connection attempt\");\n\n  const session = await auth.api.getSession({\n    headers: fromNodeHeaders(socket.handshake.headers),\n  });\n\n  if (!session) {\n    logger.warn(\"[Socket.io] Unauthenticated connection attempt rejected\");\n    return next(new Error(\"Authentication failed\"));\n  }\n\n  socket.user = {\n    id: session.user.id,\n    name: session.user.name,\n    imageUrl: session.user.image || \"\",\n    email: session.user.email,\n  };\n\n  logger.info(`[Socket.io] User authenticated: ${socket.user.id}`);\n  next();\n};\n","import { Server } from \"socket.io\";\nimport { CustomSocket } from \"@/shared/types\";\nimport { prisma } from \"@/shared/core/db\";\nimport logger from \"@/shared/core/logger\";\nimport { findOrCreateConversation } from \"@/core/messaging/services\";\n\n/**\n * Register message-related socket event handlers\n */\nexport const registerMessageHandlers = (io: Server, socket: CustomSocket) => {\n  // Private message handler\n  socket.on(\"private message\", async ({ content, to }) => {\n    io.to(to)\n      .to(socket.user.id)\n      .emit(\"private message\", {\n        ...content,\n        from: socket.user,\n        to,\n      });\n\n    logger.info(`[Socket] Private message from ${socket.user.id} to ${to}`);\n\n    // Save message to database\n    try {\n      const conversation = await findOrCreateConversation(socket.user.id, to);\n      if (!conversation) return;\n\n      const member =\n        conversation.memberOne.profileId === socket.user.id\n          ? conversation.memberOne\n          : conversation.memberTwo;\n\n      await prisma.directMessage.create({\n        data: {\n          content: content.content || content,\n          conversationId: conversation.id,\n          memberId: member.id,\n        },\n      });\n    } catch (err) {\n      logger.error(\"[Socket] Error saving private message:\", err);\n    }\n  });\n\n  // Mark messages as read\n  socket.on(\"markAsRead\", async ({ senderId }) => {\n    try {\n      const receiverId = socket.user.id;\n\n      await prisma.directMessage.updateMany({\n        where: {\n          member: {\n            profileId: senderId,\n          },\n          conversation: {\n            OR: [\n              { memberOneId: receiverId, memberTwoId: senderId },\n              { memberOneId: senderId, memberTwoId: receiverId },\n            ],\n          },\n          seen: false,\n        },\n        data: {\n          seen: true,\n        },\n      });\n\n      io.to(senderId).emit(\"markAsRead\", { senderId, receiverId });\n    } catch (error) {\n      logger.error(\"[Socket] Error marking messages as read:\", error);\n    }\n  });\n};\n","import { Server } from \"socket.io\";\nimport { CustomSocket } from \"@/shared/types\";\nimport { prisma } from \"@/shared/core/db\";\nimport logger from \"@/shared/core/logger\";\n\n/**\n * Register presence-related socket event handlers\n * Handles online status, typing indicators, and active users\n */\nexport const registerPresenceHandlers = (io: Server, socket: CustomSocket) => {\n  // Update user status to online (non-blocking)\n  prisma.user\n    .update({\n      where: { id: socket.user.id },\n      data: { isOnline: true },\n    })\n    .catch((err) =>\n      logger.error(\n        `[Socket] Error updating online status for ${socket.user.id}:`,\n        err,\n      ),\n    );\n\n  // Send active users list\n  const activeUsers = [];\n  for (let [id, socket] of io.of(\"/\").sockets) {\n    activeUsers.push({\n      socketId: id,\n      ...socket.handshake.auth,\n    });\n  }\n  socket.emit(\"active-users\", activeUsers);\n\n  // Broadcast user connected\n  socket.broadcast.emit(\"user connected\", {\n    socketId: socket.id,\n    userData: { ...socket.handshake.auth },\n  });\n\n  // Send session info\n  socket.emit(\"session\", {\n    user: socket.user,\n  });\n\n  // Typing indicator\n  socket.on(\"typing\", (to) => {\n    socket.broadcast.to(to).emit(\"broadcast typing\", {});\n  });\n\n  // Handle disconnect\n  socket.on(\"disconnect\", async () => {\n    logger.info(`[Socket] Client disconnected: ${socket.id}`);\n\n    const userId = socket.user.id;\n    const matchingSockets = await io.in(userId).fetchSockets();\n    const isStillConnected = matchingSockets.length > 0;\n\n    if (!isStillConnected) {\n      logger.info(\n        `[Socket] Last connection for user ${userId} closed. Marking offline.`,\n      );\n\n      // Non-blocking status update\n      (prisma.user.update as any)({\n        where: { id: userId },\n        data: {\n          isOnline: false,\n          lastSeenAt: new Date(),\n        },\n      }).catch((err: any) =>\n        logger.error(\n          `[Socket] Error updating offline status for ${userId}:`,\n          err,\n        ),\n      );\n\n      socket.broadcast.emit(\"user disconnected\", userId);\n    }\n  });\n};\n","import { Server } from \"socket.io\";\nimport { CustomSocket } from \"@/shared/types\";\n\n/**\n * Register notification-related socket event handlers\n */\nexport const registerNotificationHandlers = (\n  io: Server,\n  socket: CustomSocket,\n) => {\n  socket.on(\"notification\", (arg) => {\n    socket.broadcast.to(arg.to).emit(\"notification\", arg.notification);\n  });\n};\n","import { Server } from \"socket.io\";\nimport { CustomSocket } from \"@/shared/types\";\nimport logger from \"@/shared/core/logger\";\n\n/**\n * Register room management socket event handlers\n */\nexport const registerRoomHandlers = (io: Server, socket: CustomSocket) => {\n  socket.on(\"join-room\", (room) => {\n    socket.join(room);\n    logger.info(`[Socket] User ${socket.user.id} joined room ${room}`);\n  });\n\n  socket.on(\"leave-room\", (room) => {\n    socket.leave(room);\n    logger.info(`[Socket] User ${socket.user.id} left room ${room}`);\n  });\n};\n","import { events, MESSAGE_EVENTS, REACTION_EVENTS } from \"@/shared/core/events\";\nimport { socketService } from \"@/shared/core/socket\";\nimport { NotificationService } from \"@/core/notifications/services\";\nimport { extractMentionedUserIds } from \"@/shared/utils/mention-parser\";\nimport { prisma } from \"@/shared/core/db\";\nimport logger from \"@/shared/core/logger\";\n\n/**\n * Handle message created event\n */\nevents.on(MESSAGE_EVENTS.CREATED, async ({ message, type, contextId }) => {\n  try {\n    socketService.emitChatMessage(contextId, \"messages\", message);\n\n    if (type === \"channel\") {\n      const mentionedUserIds = extractMentionedUserIds(message.content);\n      if (mentionedUserIds.length > 0) {\n        const mentionedProfiles = await prisma.profile.findMany({\n          where: { userId: { in: mentionedUserIds } },\n        });\n\n        const channel = await prisma.channel.findUnique({\n          where: { id: message.channelId },\n        });\n\n        for (const profile of mentionedProfiles) {\n          if (profile.id !== message.member.profileId) {\n            await NotificationService.createNotification({\n              type: \"MENTION\",\n              content: `mentioned you in #${channel?.name || \"channel\"}`,\n              senderId: message.member.profileId,\n              receiverId: profile.id,\n              messageId: message.id,\n              channelId: message.channelId,\n              serverId: channel?.serverId,\n            });\n          }\n        }\n      }\n    }\n  } catch (error) {\n    logger.error(\"[MessageHandler] Error handling message:created\", error);\n  }\n});\n\n/**\n * Handle message updated event\n */\nevents.on(MESSAGE_EVENTS.UPDATED, async ({ message, type, contextId }) => {\n  socketService.emitChatMessage(contextId, \"messages:update\", message);\n});\n\n/**\n * Handle reaction added event\n */\nevents.on(\n  REACTION_EVENTS.ADDED,\n  async ({ reaction, authorProfileId, authorUserId, senderProfileId }) => {\n    const roomId = reaction.messageId || reaction.directMessageId;\n    socketService.emit(\"reaction:added\", reaction, roomId);\n\n    // Send notification to author if not reacting to own message\n    if (\n      authorProfileId &&\n      authorProfileId !== senderProfileId &&\n      authorUserId\n    ) {\n      await NotificationService.createNotification({\n        type: \"REACTION\",\n        content: `reacted ${reaction.emoji} to your message`,\n        senderId: senderProfileId,\n        receiverId: authorProfileId,\n        messageId: reaction.messageId || undefined,\n      });\n    }\n  },\n);\n\n/**\n * Handle reaction removed event\n */\nevents.on(REACTION_EVENTS.REMOVED, async ({ reaction }) => {\n  const roomId = reaction.messageId || reaction.directMessageId;\n  socketService.emit(\"reaction:removed\", { id: reaction.id }, roomId);\n});\n","import { prisma } from \"@/shared/core/db\";\nimport { socketService } from \"@/shared/core/socket\";\n\n/**\n * Service for handling notifications\n */\nexport class NotificationService {\n  /**\n   * Create a new notification\n   */\n  public static async createNotification(payload: {\n    type: \"MENTION\" | \"REACTION\" | \"REPLY\" | \"THREAD_REPLY\";\n    content: string;\n    senderId: string;\n    receiverId: string;\n    messageId?: string;\n    channelId?: string;\n    serverId?: string;\n  }) {\n    const {\n      type,\n      content,\n      senderId,\n      receiverId,\n      messageId,\n      channelId,\n      serverId,\n    } = payload;\n\n    const notification = await prisma.notification.create({\n      data: {\n        type,\n        content,\n        senderId,\n        receiverId,\n        messageId,\n        channelId,\n        serverId,\n      },\n      include: {\n        sender: true,\n      },\n    });\n\n    // Emit live via socket\n    socketService.emitNotification(receiverId, notification);\n\n    return notification;\n  }\n}\n","/**\n * Utility to parse @mentions from message content\n * Extracts user IDs from @mention format: @[username](userId)\n */\n\nexport interface Mention {\n  userId: string;\n  username: string;\n  startIndex: number;\n  endIndex: number;\n}\n\n/**\n * Parse mentions from message content\n * Format: @[username](userId)\n */\nexport function parseMentions(content: string): Mention[] {\n  const mentions: Mention[] = [];\n  const mentionRegex = /@\\[([^\\]]+)\\]\\(([^)]+)\\)/g;\n  let match;\n\n  while ((match = mentionRegex.exec(content)) !== null) {\n    mentions.push({\n      username: match[1],\n      userId: match[2],\n      startIndex: match.index,\n      endIndex: match.index + match[0].length,\n    });\n  }\n\n  return mentions;\n}\n\n/**\n * Extract unique user IDs from mentions\n */\nexport function extractMentionedUserIds(content: string): string[] {\n  const mentions = parseMentions(content);\n  const uniqueIds = [...new Set(mentions.map((m) => m.userId))];\n  return uniqueIds;\n}\n\n/**\n * Check if content contains any mentions\n */\nexport function hasMentions(content: string): boolean {\n  return /@\\[([^\\]]+)\\]\\(([^)]+)\\)/.test(content);\n}\n","import express, { Application } from \"express\";\nimport cors from \"cors\";\nimport cookieParser from \"cookie-parser\";\nimport { rateLimit } from \"express-rate-limit\";\nimport logger from \"@/shared/core/logger\";\n\n// CORS configuration - support multiple origins\nconst allowedOrigins = process.env.ALLOWED_ORIGINS\n  ? process.env.ALLOWED_ORIGINS.split(\",\")\n  : [\"http://localhost:3000\"];\n\nexport { allowedOrigins };\n\nexport function createApp(): Application {\n  const app: Application = express();\n\n  app.set(\"trust proxy\", 1);\n\n  // Basic middleware\n  app.use(cookieParser());\n\n  // CORS configuration\n  app.use(\n    cors({\n      origin: (origin, callback) => {\n        if (!origin) return callback(null, true);\n        if (allowedOrigins.indexOf(origin) !== -1) {\n          callback(null, true);\n        } else {\n          callback(new Error(\"Not allowed by CORS\"));\n        }\n      },\n      credentials: true,\n    }),\n  );\n\n  // Request logging\n  app.use((req, res, next) => {\n    logger.info(`[Request] ${req.method} ${req.url}`);\n    next();\n  });\n\n  // Rate limiting to prevent DoS/Brute-force\n  const limiter = rateLimit({\n    windowMs: 15 * 60 * 1000,\n    max: 1000,\n    standardHeaders: true,\n    legacyHeaders: false,\n  });\n  app.use(limiter);\n\n  return app;\n}\n","import http from \"http\";\nimport { prisma } from \"@/shared/core/db\";\nimport logger from \"@/shared/core/logger\";\n\nexport function serverShutdown(httpServer: http.Server | undefined): void {\n  const shutdown = async (signal: string) => {\n    logger.info(`\\n[${signal}] Shutting down gracefully...`);\n\n    if (httpServer) {\n      httpServer.close(async () => {\n        logger.info(\"Http server closed.\");\n\n        try {\n          await prisma.$disconnect();\n          logger.info(\"Database connection closed.\");\n          process.exit(0);\n        } catch (err) {\n          logger.error(\"Error during database disconnection:\", err);\n          process.exit(1);\n        }\n      });\n    } else {\n      try {\n        await prisma.$disconnect();\n        process.exit(0);\n      } catch (err) {\n        process.exit(1);\n      }\n    }\n\n    // Force close after 10s\n    setTimeout(() => {\n      logger.warn(\n        \"Could not close connections in time, forcefully shutting down.\",\n      );\n      process.exit(1);\n    }, 10000);\n  };\n\n  process.on(\"SIGTERM\", () => shutdown(\"SIGTERM\"));\n  process.on(\"SIGINT\", () => shutdown(\"SIGINT\"));\n}\n"],"mappings":"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","names":["init_services","init_services","init_services","init_services","init_services","ReactionService","Router","server","router","Router","routes_default","Router","router","Router","routes_default","Router","router","Router","routes_default","app","routes_default","io","fromNodeHeaders","init_services","io","io","socket","io","io","httpServer","allowedOrigins","app","express","app","express","httpServer"]}