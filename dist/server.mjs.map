{"version":3,"sources":["../src/server.ts","../src/config/app.ts","../src/libs/logger.ts","../src/config/routes.ts","../src/libs/auth.ts","../src/libs/db.ts","../src/libs/permissions.ts","../src/libs/argon2.ts","../src/libs/nodemailer.ts","../src/libs/email.ts","../src/middlewares/authMiddleware.ts","../src/middlewares/errorHandler.ts","../src/routes/socket.ts","../src/libs/socket.ts","../src/libs/conversation.ts","../src/controllers/message.ts","../src/middlewares/validationMiddleware.ts","../src/schemas/message.schema.ts","../src/routes/conversations.ts","../src/controllers/conversation.ts","../src/config/shutdown.ts"],"sourcesContent":["import dotenv from \"dotenv\";\nimport http from \"http\";\nimport { createApp, allowedOrigins } from \"./config/app\";\nimport { setupRoutes } from \"./config/routes\";\nimport { setupGracefulShutdown } from \"./config/shutdown\";\nimport { initializeSocket } from \"./libs/socket\";\nimport logger from \"./libs/logger\";\n\ndotenv.config();\n\nconst port = process.env.PORT || 7272;\n\n// Create Express app\nexport const app = createApp();\n\n// Setup routes\nsetupRoutes(app);\n\n// Create HTTP server\nconst server = http.createServer(app);\n\n// Initialize Socket.IO\ninitializeSocket(server, allowedOrigins);\n\n// Start server\nlet httpServer: http.Server | undefined;\n\nif (process.env.NODE_ENV !== \"test\") {\n  httpServer = server.listen(Number(port), \"0.0.0.0\", () => {\n    logger.info(`âš¡ Server is ready on port:${port} ðŸ”¥`);\n    logger.info(`Allowed origins: ${allowedOrigins}`);\n  });\n}\n\n// Setup graceful shutdown\nsetupGracefulShutdown(httpServer);\n","import express, { Application } from \"express\";\nimport cors from \"cors\";\nimport cookieParser from \"cookie-parser\";\nimport { rateLimit } from \"express-rate-limit\";\nimport logger from \"../libs/logger\";\n\n// CORS configuration - support multiple origins\nconst allowedOrigins = process.env.ALLOWED_ORIGINS\n  ? process.env.ALLOWED_ORIGINS.split(\",\")\n  : [\"http://localhost:3000\"];\n\nexport { allowedOrigins };\n\nexport function createApp(): Application {\n  const app: Application = express();\n\n  // Basic middleware\n  app.use(express.json());\n  app.use(cookieParser());\n\n  // CORS configuration\n  app.use(\n    cors({\n      origin: (origin, callback) => {\n        if (!origin) return callback(null, true);\n        if (allowedOrigins.indexOf(origin) !== -1) {\n          callback(null, true);\n        } else {\n          callback(new Error(\"Not allowed by CORS\"));\n        }\n      },\n      credentials: true,\n    }),\n  );\n\n  // Request logging\n  app.use((req, res, next) => {\n    logger.info(`[Request] ${req.method} ${req.url}`);\n    next();\n  });\n\n  // Rate limiting to prevent DoS/Brute-force\n  const limiter = rateLimit({\n    windowMs: 15 * 60 * 1000, // 15 minutes\n    max: 100, // Limit each IP to 100 requests per `window`\n    standardHeaders: true,\n    legacyHeaders: false,\n  });\n  app.use(limiter);\n\n  return app;\n}\n","import winston from \"winston\";\n\nconst logger = winston.createLogger({\n  level: \"info\",\n  format: winston.format.json(),\n  defaultMeta: { service: \"user-service\" },\n  transports: [\n    \n  ],\n});\n\nif (process.env.NODE_ENV !== \"production\") {\n  logger.add(\n    new winston.transports.Console({\n      format: winston.format.simple(),\n    }),\n  );\n} else {\n  logger.add(\n    new winston.transports.Console({\n      format: winston.format.json(),\n    }),\n  );\n}\n\nexport default logger;\n","import { Application } from \"express\";\nimport { toNodeHandler } from \"better-auth/node\";\nimport { auth } from \"../libs/auth\";\nimport { authMiddleware } from \"../middlewares/authMiddleware\";\nimport { errorHandler } from \"../middlewares/errorHandler\";\nimport socketRoutes from \"../routes/socket\";\nimport conversationsRoutes from \"../routes/conversations\";\nimport logger from \"../libs/logger\";\n\nexport function setupRoutes(app: Application): void {\n  // Session introspection endpoint for aura server-side auth (must be before catch-all)\n  app.get(\"/api/auth/session\", async (req, res) => {\n    const internalSecret = req.headers[\"x-internal-secret\"];\n\n    if (internalSecret !== process.env.SERVER_INTERNAL_SECRET) {\n      logger.warn(`[Auth] Forbidden introspection attempt from ${req.ip}`);\n      return res\n        .status(403)\n        .json({ error: \"Forbidden - Invalid internal secret\" });\n    }\n\n    const session = await auth.api.getSession({\n      headers: req.headers as any,\n    });\n    res.json({ data: session });\n  });\n\n  // Better Auth route (catch-all, must be after specific routes)\n  app.all(\"/api/auth/*\", toNodeHandler(auth));\n\n  // Health check endpoint (Public)\n  app.get(\"/health\", (req, res) => {\n    res.json({\n      status: \"ok\",\n      timestamp: new Date().toISOString(),\n      uptime: process.uptime(),\n    });\n  });\n\n  // Apply global auth middleware from here onwards\n  app.use(authMiddleware);\n\n  // Protected Routes\n  app.use(\"/api/messages\", socketRoutes);\n  app.use(\"/api/conversations\", conversationsRoutes);\n\n  // Centralized error handling (MUST be after all routes)\n  app.use(errorHandler);\n}\n","import { betterAuth } from \"better-auth\";\nimport { prismaAdapter } from \"better-auth/adapters/prisma\";\nimport {\n  admin,\n  customSession,\n  magicLink,\n  twoFactor,\n} from \"better-auth/plugins\";\nimport { passkey } from \"@better-auth/passkey\";\n\nimport { prisma } from \"./db\";\nimport { ac, roles } from \"./permissions\";\nimport { hashPassword, verifyPassword } from \"./argon2\";\nimport { sendEmailAction } from \"./email\";\n\nexport const auth = betterAuth({\n  database: prismaAdapter(prisma, {\n    provider: \"mongodb\",\n  }),\n  secret: process.env.BETTER_AUTH_SECRET,\n  trustedOrigins: [\"http://localhost:3000\"],\n\n  emailVerification: {\n    sendOnSignUp: true,\n    expiresIn: 60 * 60,\n    autoSignInAfterVerification: true,\n    sendVerificationEmail: async ({ user, url }) => {\n      const link = new URL(url);\n      link.searchParams.set(\"callbackURL\", \"/auth/verify\");\n\n      await sendEmailAction({\n        to: user.email,\n        subject: \"Verify your email address\",\n        meta: {\n          description:\n            \"Please verify your email address to complete the registration process.\",\n          link: String(link),\n        },\n      });\n    },\n  },\n  emailAndPassword: {\n    enabled: true,\n    minPasswordLength: 6,\n    autoSignIn: false,\n    password: {\n      hash: hashPassword,\n      verify: verifyPassword,\n    },\n    requireEmailVerification: false,\n    sendResetPassword: async ({ user, url }) => {\n      await sendEmailAction({\n        to: user.email,\n        subject: \"Reset your password\",\n        meta: {\n          description: \"Please click the link below to reset your password.\",\n          link: String(url),\n        },\n      });\n    },\n  },\n  databaseHooks: {\n    user: {\n      create: {\n        before: async (user) => {\n          const ADMIN_EMAILS = process.env.ADMIN_EMAILS?.split(\";\") ?? [];\n\n          if (ADMIN_EMAILS.includes(user.email)) {\n            return { data: { ...user, role: \"ADMIN\" } };\n          }\n\n          return { data: user };\n        },\n      },\n    },\n  },\n  user: {\n    additionalFields: {\n      role: {\n        type: [\"USER\", \"ADMIN\"],\n        input: false,\n      },\n    },\n  },\n  session: {\n    expiresIn: 30 * 24 * 60 * 60,\n    cookieCache: {\n      enabled: true,\n      maxAge: 5 * 60,\n    },\n  },\n  account: {\n    accountLinking: {\n      enabled: true,\n      trustedProviders: [\"google\", \"github\"],\n    },\n  },\n  advanced: {\n    database: {\n      generateId: false,\n    },\n  },\n  socialProviders: {\n    google: {\n      clientId: process.env.GOOGLE_CLIENT_ID!,\n      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,\n    },\n    github: {\n      clientId: process.env.GITHUB_CLIENT_ID!,\n      clientSecret: process.env.GITHUB_CLIENT_SECRET!,\n    },\n  },\n  plugins: [\n    admin({\n      defaultRole: \"USER\",\n      adminRoles: [\"ADMIN\"],\n      ac,\n      roles,\n    }),\n    magicLink({\n      sendMagicLink: async ({ email, url }) => {\n        await sendEmailAction({\n          to: email,\n          subject: \"Magic Link Login\",\n          meta: {\n            description: \"Please click the link below to log in.\",\n            link: String(url),\n          },\n        });\n      },\n    }),\n    twoFactor({\n      otpOptions: {},\n    }),\n    passkey(),\n    customSession(async ({ user, session }) => {\n      return {\n        session: {\n          expiresAt: session.expiresAt,\n          token: session.token,\n          userAgent: session.userAgent,\n        },\n        user: {\n          id: user.id,\n          name: user.name,\n          email: user.email,\n          image: user.image,\n          createdAt: user.createdAt,\n          role: (user as any).role,\n        },\n      };\n    }),\n  ],\n});\n","import { PrismaClient } from \"@prisma/client\";\n\nconst prismaClientSingleton = () => {\n  return new PrismaClient();\n};\n\ntype PrismaClientSingleton = ReturnType<typeof prismaClientSingleton>;\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClientSingleton | undefined;\n};\n\nexport const prisma = globalForPrisma.prisma ?? prismaClientSingleton();\n\nif (process.env.NODE_ENV !== \"production\") globalForPrisma.prisma = prisma;","import { createAccessControl } from \"better-auth/plugins/access\";\nimport { defaultStatements, adminAc } from \"better-auth/plugins/admin/access\";\n\nconst statements = {\n  ...defaultStatements,\n  posts: [\"create\", \"read\", \"update\", \"delete\", \"update:own\", \"delete:own\"],\n} as const;\n\nexport const ac = createAccessControl(statements);\n\nexport const roles = {\n  USER: ac.newRole({\n    posts: [\"create\", \"read\", \"update:own\", \"delete:own\"],\n  }),\n\n  ADMIN: ac.newRole({\n    posts: [\"create\", \"read\", \"update\", \"delete\", \"update:own\", \"delete:own\"],\n    ...adminAc.statements,\n  }),\n};\n","import { hash, verify, type Options } from \"@node-rs/argon2\";\n\nconst opts: Options = {\n  memoryCost: 19456,\n  timeCost: 2,\n  outputLen: 32,\n  parallelism: 1,\n};\n\nexport async function hashPassword(password: string): Promise<string> {\n  const result = await hash(password, opts);\n  return result;\n}\n\nexport async function verifyPassword(data: {\n  password: string;\n  hash: string;\n}): Promise<boolean> {\n  const { password, hash: hashedPassword } = data;\n\n  const result = await verify(hashedPassword, password, opts);\n  return result;\n}\n","import nodemailer from \"nodemailer\";\n\nconst transporter = nodemailer.createTransport({\n  host: \"smtp.gmail.com\",\n  port: 465,\n  secure: true,\n  auth: {\n    user: process.env.NODEMAILER_USER,\n    pass: process.env.NODEMAILER_APP_PASSWORD,\n  },\n});\n\nexport default transporter;\n","import transporter from \"./nodemailer\";\n\nconst styles = {\n  container:\n    \"max-width:500px;margin:20px auto;padding:20px;border:1px solid #ddd;border-radius:6px;\",\n  heading: \"font-size:20px;color:#333;\",\n  paragraph: \"font-size:16px;\",\n  link: \"display:inline-block;margin-top:15px;padding:10px 15px;background:#007bff;color:#fff;text-decoration:none;border-radius:4px;\",\n};\n\nexport async function sendEmailAction({\n  to,\n  subject,\n  meta,\n}: {\n  to: string;\n  subject: string;\n  meta: {\n    description: string;\n    link: string;\n  };\n}) {\n  const mailOptions = {\n    from: process.env.NODEMAILER_USER,\n    to,\n    subject: `GameCord - ${subject}`,\n    html: `\n    <div style=\"${styles.container}\">\n      <h1 style=\"${styles.heading}\">${subject}</h1>\n      <p style=\"${styles.paragraph}\">${meta.description}</p>\n      <a href=\"${meta.link}\" style=\"${styles.link}\">Click Here</a>\n    </div>\n    `,\n  };\n\n  try {\n    await transporter.sendMail(mailOptions);\n    return { success: true };\n  } catch (err) {\n    console.error(\"[SendEmail]:\", err);\n    return { success: false };\n  }\n}\n","import { Request, Response, NextFunction } from \"express\";\nimport { auth } from \"../libs/auth\";\nimport { fromNodeHeaders } from \"better-auth/node\";\n\nexport const authMiddleware = async (\n  req: Request,\n  res: Response,\n  next: NextFunction,\n) => {\n  const session = await auth.api.getSession({\n    headers: fromNodeHeaders(req.headers),\n  });\n\n  console.log(\"[Auth] Session result:\", session ? \"FOUND\" : \"NULL\");\n  if (session) {\n    res.locals.userId = session.user.id;\n    res.locals.user = session.user;\n    return next();\n  }\n\n  const internalSecret = req.headers[\"x-internal-secret\"] as string;\n  const bridgedUserId = req.headers[\"x-user-id\"] as string;\n\n  console.log(\"[Auth] Bridged Auth Attempt:\", {\n    hasSecret: !!internalSecret,\n    hasUserId: !!bridgedUserId,\n    secretMatch: internalSecret === process.env.SERVER_INTERNAL_SECRET,\n  });\n\n  if (\n    internalSecret &&\n    internalSecret === process.env.SERVER_INTERNAL_SECRET &&\n    bridgedUserId\n  ) {\n    res.locals.userId = bridgedUserId;\n    return next();\n  }\n\n  // Temporary fallback for development if cookies/secrets are failing\n  if (process.env.NODE_ENV !== \"production\" && bridgedUserId) {\n    console.warn(\n      \"[Auth] WARNING: Using insecure fallback userId:\",\n      bridgedUserId,\n    );\n    res.locals.userId = bridgedUserId;\n    return next();\n  }\n\n  console.error(\"[Auth] Authentication FAILED for:\", req.url);\n  return res\n    .status(401)\n    .json({ error: \"Unauthorized - No valid session or secure bridge found\" });\n};\n","import { NextFunction, Request, Response } from \"express\";\n\n/**\n * Centralized error handler middleware.\n * Catches all unhandled errors and returns a consistent JSON response.\n */\nexport const errorHandler = (\n  err: any,\n  req: Request,\n  res: Response,\n  next: NextFunction,\n) => {\n  const status = err.status || 500;\n  const message = err.message || \"Something went wrong\";\n\n  console.error(`[Error] ${req.method} ${req.url} - Status: ${status}`, err);\n\n  res.status(status).json({\n    error: message,\n    stack: process.env.NODE_ENV === \"production\" ? undefined : err.stack,\n  });\n};\n","import { Request, Response, Router } from \"express\";\n\nconst router: Router = Router();\n\nimport { io } from \"../libs/socket\";\nimport {\n  createChannelMessage,\n  createDirectMessage,\n  updateMessage,\n  deleteMessage,\n  getConversation,\n  sendMessageController,\n  getMessages,\n} from \"../controllers/message\";\nimport validator from \"../middlewares/validationMiddleware\";\nimport {\n  createChannelMessageSchema,\n  createDirectMessageSchema,\n  updateMessageSchema,\n  deleteMessageSchema,\n} from \"../schemas/message.schema\";\n\nrouter.post(\n  \"/channel\",\n  validator(createChannelMessageSchema),\n  (req: Request, res: Response) => {\n    createChannelMessage(io, req, res);\n  },\n);\n\nrouter.post(\n  \"/direct\",\n  validator(createDirectMessageSchema),\n  (req: Request, res: Response) => {\n    createDirectMessage(io, req, res);\n  },\n);\n\nrouter.patch(\n  \"/:messageId\",\n  validator(updateMessageSchema),\n  (req: Request, res: Response) => {\n    updateMessage(io, req, res);\n  },\n);\n\nrouter.delete(\n  \"/:messageId\",\n  validator(deleteMessageSchema),\n  (req: Request, res: Response) => {\n    deleteMessage(io, req, res);\n  },\n);\n\nrouter.get(\"/conversation\", getConversation);\n\nrouter.get(\"/\", (req: Request, res: Response) => {\n  getMessages(io, req, res);\n});\n\nexport default router;\n","import { Server } from \"socket.io\";\nimport { PrismaClient } from \"@prisma/client\";\nimport { auth } from \"./auth\";\nimport { findOrCreateConversation } from \"./conversation\";\nimport { prisma } from \"./db\";\nimport logger from \"./logger\";\nimport { CustomSocket } from \"../types\";\nimport http from \"http\";\nimport { fromNodeHeaders } from \"better-auth/node\";\n\nexport let io: Server;\n\nexport const initializeSocket = (\n  httpServer: http.Server,\n  allowedOrigins: string[],\n) => {\n  io = new Server(httpServer, {\n    cors: {\n      origin: allowedOrigins,\n      credentials: true,\n      methods: [\"GET\", \"POST\"],\n    },\n    transports: [\"websocket\", \"polling\"],\n    allowEIO3: true,\n  });\n\n  //  middleware for io\n  io.use(async (socket: CustomSocket, next) => {\n    logger.info(\"[Socket.io] New connection attempt\");\n\n    const session = await auth.api.getSession({\n      headers: fromNodeHeaders(socket.handshake.headers),\n    });\n\n    if (!session) {\n      logger.warn(\"[Socket.io] Unauthenticated connection attempt rejected\");\n      return next(new Error(\"Authentication failed\"));\n    }\n\n    socket.user = {\n      id: session.user.id,\n      name: session.user.name,\n      imageUrl: session.user.image || \"\",\n      email: session.user.email,\n    };\n\n    logger.info(`[Socket.io] User authenticated: ${socket.user.id}`);\n    next();\n  });\n\n  // on socket connection\n  io.on(\"connection\", (socket: CustomSocket) => {\n    logger.info(`[Socket.io] Client connected: ${socket.id}`);\n    socket.join(socket.user?.id as string);\n\n    // A catch-all listener\n    socket.onAny((event, ...args) => {\n      logger.info(event, args);\n    });\n\n    const activeUsers = [];\n    for (let [id, socket] of io.of(\"/\").sockets) {\n      activeUsers.push({\n        socketId: id,\n        ...socket.handshake.auth,\n      });\n    }\n    socket.emit(\"active-users\", activeUsers);\n\n    socket.broadcast.emit(\"user connected\", {\n      socketId: socket.id,\n      userData: { ...socket.handshake.auth },\n    });\n\n    // session\n    socket.emit(\"session\", {\n      user: socket.user,\n    });\n\n    // Listening to Direct Messages\n    socket.on(\"private message\", async ({ content, to }) => {\n      io.to(to)\n        .to(socket.user.id)\n        .emit(\"private message\", {\n          ...content,\n          from: socket.user,\n          to,\n        });\n      logger.info(socket.user.id);\n      // message to database\n      try {\n        const conversation = await findOrCreateConversation(socket.user.id, to);\n        if (!conversation) return;\n\n        const member =\n          conversation.memberOne.profileId === socket.user.id\n            ? conversation.memberOne\n            : conversation.memberTwo;\n\n        await prisma.directMessage.create({\n          data: {\n            content: content.content || content, // Handle both object and string\n            conversationId: conversation.id,\n            memberId: member.id,\n          },\n        });\n      } catch (err) {\n        logger.error(err);\n      }\n    });\n\n    // mark as read\n    socket.on(\"markAsRead\", async ({ senderId }) => {\n      try {\n        const receiverId = socket.user.id;\n        // Update all messages from senderId to receiverId in their conversation\n        await prisma.directMessage.updateMany({\n          where: {\n            member: {\n              profileId: senderId,\n            },\n            conversation: {\n              OR: [\n                { memberOneId: receiverId, memberTwoId: senderId },\n                { memberOneId: senderId, memberTwoId: receiverId },\n              ],\n            },\n            seen: false,\n          },\n          data: {\n            seen: true,\n          },\n        });\n\n        // Notify the sender that their messages were read\n        io.to(senderId).emit(\"markAsRead\", { senderId, receiverId });\n      } catch (error) {\n        logger.error(\"âŒ Error marking messages as read:\", error);\n      }\n    });\n\n    // typing\n    socket.on(\"typing\", (to) => {\n      socket.broadcast.to(to).emit(\"broadcast typing\", {});\n    });\n\n    //  notifications\n    const notifications: {} = [];\n    socket.on(\"notification\", (arg) => {\n      // send it to users\n      socket.broadcast.to(arg.to).emit(\"notification\", arg.notification);\n    });\n    // Handle notification acknowledgment\n    socket.on(\"notification-acknowledgment\", (notificationId) => {\n      // const notification = notifications.find((n) => n.id === notificationId);\n      // if (notification) {\n      //   notification.seen = true;\n      // }\n    });\n\n    // Disconnect user\n    socket.on(\"disconnect\", async () => {\n      const matchingSockets = await io.in(socket.user.id).fetchSockets();\n      // const isDisconnected = matchingSockets.size === 0;\n      // if (isDisconnected) {\n      //   socket.broadcast.emit(\"user disconnected\", socket.user.id);\n      //   // update the connection status of the session\n      // }\n    });\n  });\n};\n","import { prisma } from \"./db\";\n\nexport const findOrCreateConversation = async (\n  memberOneId: string,\n  memberTwoId: string,\n) => {\n  let conversation =\n    (await findConversation(memberOneId, memberTwoId)) ||\n    (await findConversation(memberTwoId, memberOneId));\n\n  if (!conversation) {\n    conversation = await createNewConversation(memberOneId, memberTwoId);\n  }\n\n  return conversation;\n};\n\nconst findConversation = async (memberOneId: string, memberTwoId: string) => {\n  try {\n    return await prisma.conversation.findFirst({\n      where: {\n        AND: [{ memberOneId: memberOneId }, { memberTwoId: memberTwoId }],\n      },\n      include: {\n        memberOne: {\n          include: {\n            profile: true,\n          },\n        },\n        memberTwo: {\n          include: {\n            profile: true,\n          },\n        },\n      },\n    });\n  } catch (error) {\n    console.error(\"Error finding conversation:\", error);\n    return null;\n  }\n};\n\nconst createNewConversation = async (\n  memberOneId: string,\n  memberTwoId: string,\n) => {\n  try {\n    return await prisma.conversation.create({\n      data: {\n        memberOneId,\n        memberTwoId,\n      },\n      include: {\n        memberOne: {\n          include: {\n            profile: true,\n          },\n        },\n        memberTwo: {\n          include: {\n            profile: true,\n          },\n        },\n      },\n    });\n  } catch {\n    return null;\n  }\n};\n","import { Server } from \"socket.io\";\nimport { prisma } from \"../libs/db\";\nimport { Request, Response } from \"express\";\nimport { findOrCreateConversation } from \"../libs/conversation\";\n\n// Create a channel message\nexport const createChannelMessage = async (\n  io: Server,\n  req: Request,\n  res: Response,\n) => {\n  try {\n    const { content, fileUrl, isEncrypted } = req.body;\n    const { serverId, channelId } = req.query;\n    const userId = res.locals.userId;\n\n    if (!serverId || !channelId) {\n      return res.status(400).json({ error: \"Server ID or Channel ID missing\" });\n    }\n\n    if (!content) {\n      return res.status(400).json({ error: \"Content missing\" });\n    }\n\n    console.log(\"[CreateMessage] Attempting with:\", {\n      userId,\n      serverId,\n      channelId,\n    });\n\n    // Create message (using the shared aura database schema)\n    // Note: session userId is User.id, but Member uses Profile.id\n    const member = await prisma.member.findFirst({\n      where: {\n        profile: {\n          userId: userId,\n        },\n        serverId: serverId as string,\n      },\n    });\n\n    if (!member) {\n      console.error(\"[CreateMessage] Member NOT FOUND in DB for:\", {\n        userId,\n        serverId,\n      });\n      return res.status(404).json({ error: \"Member not found in this server\" });\n    }\n\n    const message = await prisma.message.create({\n      data: {\n        content,\n        fileUrl: fileUrl || null,\n        channelId: channelId as string,\n        memberId: member.id,\n        isEncrypted: !!isEncrypted,\n      },\n      include: {\n        member: {\n          include: {\n            profile: true,\n          },\n        },\n      },\n    });\n\n    const channelKey = `chat:${channelId}:messages`;\n    io.emit(channelKey, message);\n\n    return res.status(201).json(message);\n  } catch (error) {\n    console.error(\"[CREATE_CHANNEL_MESSAGE]\", error);\n    return res.status(500).json({ error: \"Internal server error\" });\n  }\n};\n\n// Create a direct message\nexport const createDirectMessage = async (\n  io: Server,\n  req: Request,\n  res: Response,\n) => {\n  try {\n    const { content, fileUrl, isEncrypted } = req.body;\n    const { conversationId } = req.query;\n    const userId = res.locals.userId;\n\n    if (!conversationId) {\n      return res.status(400).json({ error: \"Conversation ID missing\" });\n    }\n\n    if (!content) {\n      return res.status(400).json({ error: \"Content missing\" });\n    }\n\n    // Find the member for this conversation\n    const conversation = await prisma.conversation.findUnique({\n      where: { id: conversationId as string },\n      include: {\n        memberOne: true,\n        memberTwo: true,\n      },\n    });\n\n    if (!conversation) {\n      return res.status(404).json({ error: \"Conversation not found\" });\n    }\n\n    // Determine which member is sending the message\n    // Note: session userId is User.id, but Member uses Profile.profileId\n    const member = await prisma.member.findFirst({\n      where: {\n        profile: {\n          userId: userId,\n        },\n        OR: [\n          { id: conversation.memberOneId },\n          { id: conversation.memberTwoId },\n        ],\n      },\n    });\n\n    if (!member) {\n      return res\n        .status(404)\n        .json({ error: \"Member not found in conversation\" });\n    }\n\n    // Create direct message\n    const message = await prisma.directMessage.create({\n      data: {\n        content,\n        fileUrl: fileUrl || null,\n        conversationId: conversationId as string,\n        memberId: member.id,\n        isEncrypted: !!isEncrypted,\n      },\n      include: {\n        member: {\n          include: {\n            profile: true,\n          },\n        },\n      },\n    });\n\n    const channelKey = `chat:${conversationId}:messages`;\n    io.emit(channelKey, message);\n\n    return res.status(201).json(message);\n  } catch (error) {\n    console.error(\"[CREATE_DIRECT_MESSAGE]\", error);\n    return res.status(500).json({ error: \"Internal server error\" });\n  }\n};\n\n// Update a message\nexport const updateMessage = async (\n  io: Server,\n  req: Request,\n  res: Response,\n) => {\n  try {\n    const { messageId } = req.params;\n    const { content } = req.body;\n    const { serverId, conversationId } = req.query;\n    const userId = res.locals.userId;\n\n    if (!content) {\n      return res.status(400).json({ error: \"Content missing\" });\n    }\n\n    if (serverId) {\n      // Channel context\n      const member = await prisma.member.findFirst({\n        where: {\n          profile: { userId },\n          serverId: serverId as string,\n        },\n      });\n\n      if (!member) {\n        return res.status(404).json({ error: \"Member not found\" });\n      }\n\n      const message = await prisma.message.findFirst({\n        where: {\n          id: messageId,\n          memberId: member.id,\n          deleted: false,\n        },\n      });\n\n      if (!message) {\n        return res\n          .status(404)\n          .json({ error: \"Message not found or unauthorized\" });\n      }\n\n      const updatedMessage = await prisma.message.update({\n        where: { id: messageId },\n        data: { content },\n        include: {\n          member: {\n            include: { profile: true },\n          },\n        },\n      });\n\n      const updateKey = `chat:${message.channelId}:messages:update`;\n      io.emit(updateKey, updatedMessage);\n      return res.status(200).json(updatedMessage);\n    } else if (conversationId) {\n      // Direct message context\n      const member = await prisma.member.findFirst({\n        where: {\n          profile: { userId },\n          OR: [\n            {\n              conversationsInitiated: {\n                some: { id: conversationId as string },\n              },\n            },\n            {\n              conversationsReceived: { some: { id: conversationId as string } },\n            },\n          ],\n        },\n      });\n\n      if (!member) {\n        return res\n          .status(404)\n          .json({ error: \"Member not found in conversation\" });\n      }\n\n      const message = await prisma.directMessage.findFirst({\n        where: {\n          id: messageId,\n          memberId: member.id,\n          deleted: false,\n        },\n      });\n\n      if (!message) {\n        return res\n          .status(404)\n          .json({ error: \"Message not found or unauthorized\" });\n      }\n\n      const updatedMessage = await prisma.directMessage.update({\n        where: { id: messageId },\n        data: { content },\n        include: {\n          member: {\n            include: { profile: true },\n          },\n        },\n      });\n\n      const updateKey = `chat:${conversationId}:messages:update`;\n      io.emit(updateKey, updatedMessage);\n      return res.status(200).json(updatedMessage);\n    }\n\n    return res\n      .status(400)\n      .json({ error: \"Context missing (serverId or conversationId)\" });\n  } catch (error) {\n    console.error(\"[UPDATE_MESSAGE]\", error);\n    return res.status(500).json({ error: \"Internal server error\" });\n  }\n};\n\n// Delete a message\nexport const deleteMessage = async (\n  io: Server,\n  req: Request,\n  res: Response,\n) => {\n  try {\n    const { messageId } = req.params;\n    const { serverId, conversationId } = req.query;\n    const userId = res.locals.userId;\n\n    if (serverId) {\n      // Channel context\n      const member = await prisma.member.findFirst({\n        where: {\n          profile: { userId },\n          serverId: serverId as string,\n        },\n      });\n\n      if (!member) {\n        return res.status(404).json({ error: \"Member not found\" });\n      }\n\n      const message = await prisma.message.findFirst({\n        where: {\n          id: messageId,\n        },\n        include: {\n          member: true,\n        },\n      });\n\n      if (!message || message.deleted) {\n        return res.status(404).json({ error: \"Message not found\" });\n      }\n\n      const isMessageOwner = message.memberId === member.id;\n      const isAdmin = member.role === \"ADMIN\";\n      const isModerator = member.role === \"MODERATOR\";\n\n      if (!isMessageOwner && !isAdmin && !isModerator) {\n        return res.status(401).json({ error: \"Unauthorized\" });\n      }\n\n      const deletedMessage = await prisma.message.update({\n        where: { id: messageId },\n        data: {\n          fileUrl: null,\n          content: \"This message has been deleted.\",\n          deleted: true,\n        },\n        include: {\n          member: {\n            include: { profile: true },\n          },\n        },\n      });\n\n      const updateKey = `chat:${message.channelId}:messages:update`;\n      io.emit(updateKey, deletedMessage);\n      return res.status(200).json(deletedMessage);\n    } else if (conversationId) {\n      // Direct message context\n      const member = await prisma.member.findFirst({\n        where: {\n          profile: { userId },\n          OR: [\n            {\n              conversationsInitiated: {\n                some: { id: conversationId as string },\n              },\n            },\n            {\n              conversationsReceived: { some: { id: conversationId as string } },\n            },\n          ],\n        },\n      });\n\n      if (!member) {\n        return res\n          .status(404)\n          .json({ error: \"Member not found in conversation\" });\n      }\n\n      const message = await prisma.directMessage.findFirst({\n        where: {\n          id: messageId,\n          conversationId: conversationId as string,\n        },\n      });\n\n      if (!message || message.deleted) {\n        return res.status(404).json({ error: \"Message not found\" });\n      }\n\n      if (message.memberId !== member.id) {\n        return res.status(401).json({ error: \"Unauthorized\" });\n      }\n\n      const deletedMessage = await prisma.directMessage.update({\n        where: { id: messageId },\n        data: {\n          fileUrl: null,\n          content: \"This message has been deleted.\",\n          deleted: true,\n        },\n        include: {\n          member: {\n            include: { profile: true },\n          },\n        },\n      });\n\n      const updateKey = `chat:${conversationId}:messages:update`;\n      io.emit(updateKey, deletedMessage);\n      return res.status(200).json(deletedMessage);\n    }\n\n    return res\n      .status(400)\n      .json({ error: \"Context missing (serverId or conversationId)\" });\n  } catch (error) {\n    console.error(\"[DELETE_MESSAGE]\", error);\n    return res.status(500).json({ error: \"Internal server error\" });\n  }\n};\n\n// Legacy controllers (keep for backward compatibility)\nexport const getConversation = async (req: Request, res: Response) => {\n  const { receiverId } = req.query;\n  try {\n    const conversation = await findOrCreateConversation(\n      res.locals.userId,\n      receiverId as string,\n    );\n    res.status(200).json(conversation);\n  } catch (err: any) {\n    console.log(err);\n    res.status(500).json({ error: err.message });\n  }\n};\n\nexport const sendMessageController = async (\n  io: Server,\n  req: Request,\n  res: Response,\n) => {\n  try {\n    const { message } = req.body;\n    const { receiverId } = req.query;\n    const userId = res.locals.userId;\n\n    const conversation = await findOrCreateConversation(\n      userId,\n      receiverId as string,\n    );\n\n    if (!conversation) {\n      return res.status(404).json({ error: \"Conversation not found\" });\n    }\n\n    // Determine which member is sending the message\n    const member =\n      conversation.memberOne.profileId === userId\n        ? conversation.memberOne\n        : conversation.memberTwo;\n\n    const result = await prisma.directMessage.create({\n      data: {\n        content: message,\n        conversationId: conversation.id,\n        memberId: member.id,\n      },\n      include: {\n        member: {\n          include: {\n            profile: true,\n          },\n        },\n      },\n    });\n\n    res.status(201).json(result);\n  } catch (error) {\n    console.log(error);\n    res.status(500).json({ error: \"Internal server error\" });\n  }\n};\n\nexport const getMessages = async (io: Server, req: Request, res: Response) => {\n  const { receiverId } = req.query;\n  try {\n    const conversation = await findOrCreateConversation(\n      res.locals.userId,\n      receiverId as string,\n    );\n\n    if (!conversation) {\n      return res.status(404).json({ error: \"Conversation not found\" });\n    }\n\n    const messages = await prisma.directMessage.findMany({\n      where: {\n        conversationId: conversation.id,\n      },\n      include: {\n        member: {\n          include: {\n            profile: true,\n          },\n        },\n      },\n      orderBy: {\n        createdAt: \"desc\",\n      },\n    });\n\n    res.status(200).json(messages);\n  } catch (error) {\n    console.log(\"Error:\", error);\n    res.status(500).json({ error: \"Internal server error\" });\n  }\n};\n","import { AnyZodObject } from \"zod\";\nimport { Request, Response, NextFunction } from \"express\";\n\nconst validator =\n  (schema: AnyZodObject) =>\n  (req: Request, res: Response, next: NextFunction) => {\n    try {\n      schema.parse({\n        body: req.body,\n        query: req.query,\n        params: req.params,\n      });\n      next();\n    } catch (err: any) {\n      console.log(err);\n      return res.status(400).send(err.errors);\n    }\n  };\n\nexport default validator;\n","import { z } from \"zod\";\n\n/**\n * Schema for creating a channel message\n */\nexport const createChannelMessageSchema = z.object({\n  body: z.object({\n    content: z.string().min(1).max(5000),\n    fileUrl: z.string().url().optional().nullable(),\n    isEncrypted: z.boolean().optional(),\n  }),\n  query: z.object({\n    serverId: z.string().min(1),\n    channelId: z.string().min(1),\n  }),\n});\n\n/**\n * Schema for creating a direct message\n */\nexport const createDirectMessageSchema = z.object({\n  body: z.object({\n    content: z.string().min(1).max(5000),\n    fileUrl: z.string().url().optional().nullable(),\n    isEncrypted: z.boolean().optional(),\n  }),\n  query: z.object({\n    conversationId: z.string().min(1),\n  }),\n});\n\nexport const updateMessageSchema = z.object({\n  params: z.object({\n    messageId: z.string().min(1),\n  }),\n  body: z.object({\n    content: z.string().min(1).max(5000),\n  }),\n  query: z.object({\n    serverId: z.string().optional(),\n    channelId: z.string().optional(),\n    conversationId: z.string().optional(),\n  }),\n});\n\n/**\n * Schema for deleting a message\n */\nexport const deleteMessageSchema = z.object({\n  params: z.object({\n    messageId: z.string().min(1),\n  }),\n  query: z.object({\n    serverId: z.string().optional(),\n    channelId: z.string().optional(),\n    conversationId: z.string().optional(),\n  }),\n});\n\n// Backward compatibility or other uses\nexport const conversationSchema = z.object({\n  query: z.object({\n    receiverId: z.string().min(1),\n  }),\n});\n\nexport const sendMessageSchema = z.object({\n  body: z.object({\n    message: z.string().min(1),\n  }),\n  query: z.object({\n    receiverId: z.string().min(1),\n  }),\n});\n","import { Router } from \"express\";\nimport { getConversations } from \"../controllers/conversation\";\n\nconst router = Router();\n\n// GET /api/conversations?serverId={serverId}\nrouter.get(\"/\", getConversations);\n\nexport default router;\n","import { Request, Response } from \"express\";\nimport { prisma } from \"../libs/db\";\n\n/**\n * Get all active conversations for the current user in a specific server\n * GET /api/conversations?serverId={serverId}\n */\nexport const getConversations = async (req: Request, res: Response) => {\n  try {\n    const { serverId } = req.query;\n    const userId = res.locals.userId;\n\n    if (!serverId) {\n      return res.status(400).json({ error: \"Server ID missing\" });\n    }\n\n    // Get the current member in this server\n    const currentMember = await prisma.member.findFirst({\n      where: {\n        serverId: serverId as string,\n        profile: {\n          userId: userId,\n        },\n      },\n    });\n\n    if (!currentMember) {\n      return res.status(404).json({ error: \"Member not found\" });\n    }\n\n    // Find all conversations where the current member is involved\n    const conversations = await prisma.conversation.findMany({\n      where: {\n        OR: [\n          { memberOneId: currentMember.id },\n          { memberTwoId: currentMember.id },\n        ],\n      },\n      include: {\n        memberOne: {\n          include: {\n            profile: true,\n          },\n        },\n        memberTwo: {\n          include: {\n            profile: true,\n          },\n        },\n        directMessages: {\n          take: 1,\n          orderBy: {\n            createdAt: \"desc\",\n          },\n        },\n      },\n    });\n\n    // Filter to only include conversations with at least one message\n    // and sort by most recent message\n    const activeConversations = conversations\n      .filter((conv) => conv.directMessages.length > 0)\n      .sort((a, b) => {\n        const aTime = a.directMessages[0]?.createdAt.getTime() || 0;\n        const bTime = b.directMessages[0]?.createdAt.getTime() || 0;\n        return bTime - aTime; // Most recent first\n      });\n\n    return res.status(200).json({\n      conversations: activeConversations,\n      currentMemberId: currentMember.id,\n    });\n  } catch (error) {\n    console.error(\"[GET_CONVERSATIONS]\", error);\n    return res.status(500).json({ error: \"Internal server error\" });\n  }\n};\n","import http from \"http\";\nimport { prisma } from \"../libs/db\";\nimport logger from \"../libs/logger\";\n\nexport function setupGracefulShutdown(\n  httpServer: http.Server | undefined,\n): void {\n  const shutdown = async (signal: string) => {\n    logger.info(`\\n[${signal}] Shutting down gracefully...`);\n\n    if (httpServer) {\n      httpServer.close(async () => {\n        logger.info(\"Http server closed.\");\n\n        try {\n          await prisma.$disconnect();\n          logger.info(\"Database connection closed.\");\n          process.exit(0);\n        } catch (err) {\n          logger.error(\"Error during database disconnection:\", err);\n          process.exit(1);\n        }\n      });\n    } else {\n      try {\n        await prisma.$disconnect();\n        process.exit(0);\n      } catch (err) {\n        process.exit(1);\n      }\n    }\n\n    // Force close after 10s\n    setTimeout(() => {\n      logger.warn(\n        \"Could not close connections in time, forcefully shutting down.\",\n      );\n      process.exit(1);\n    }, 10000);\n  };\n\n  process.on(\"SIGTERM\", () => shutdown(\"SIGTERM\"));\n  process.on(\"SIGINT\", () => shutdown(\"SIGINT\"));\n}\n"],"mappings":"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","names":["app","fromNodeHeaders","httpServer","allowedOrigins","socket","io","io","Router","router","Router","app","httpServer"]}