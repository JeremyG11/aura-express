{"version":3,"sources":["../src/server.ts","../src/core/logger.ts","../src/config/routes.ts","../src/core/auth.ts","../src/core/db.ts","../src/utils/permissions.ts","../src/email/nodemailer.ts","../src/email/email.ts","../src/libs/argon2.ts","../src/middlewares/authMiddleware.ts","../src/utils/api-response.ts","../src/utils/errors.ts","../src/middlewares/errorHandler.ts","../src/routes/messages.ts","../src/services/member.ts","../src/core/events.ts","../src/services/message.ts","../src/services/conversation.ts","../src/controllers/message.ts","../src/middlewares/validationMiddleware.ts","../src/schemas/message.schema.ts","../src/routes/conversations.ts","../src/controllers/conversation.ts","../src/routes/link-preview.ts","../src/controllers/link-preview.ts","../src/routes/threads.ts","../src/controllers/thread.ts","../src/routes/notifications.ts","../src/services/profile.ts","../src/controllers/notification.ts","../src/routes/reactions.ts","../src/services/reaction.ts","../src/controllers/reaction.ts","../src/routes/members.ts","../src/controllers/member.ts","../src/routes/channels.ts","../src/controllers/channel.ts","../src/services/socket.ts","../src/services/notification.ts","../src/utils/mention-parser.ts","../src/events/message.handler.ts","../src/libs/socket.ts","../src/config/app.ts","../src/config/shutdown.ts"],"sourcesContent":["import \"module-alias/register\";\nimport dotenv from \"dotenv\";\nimport http from \"http\";\nimport logger from \"@/core/logger\";\nimport { setupRoutes } from \"@/config/routes\";\nimport { initializeSocket } from \"@/libs/socket\";\nimport { createApp, allowedOrigins } from \"@/config/app\";\nimport { serverShutdown } from \"@/config/shutdown\";\n\ndotenv.config();\n\nconst port = process.env.PORT || 7272;\n\n// Create Express app\nexport const app = createApp();\n\n// Setup routes\nsetupRoutes(app);\n\n// Create HTTP server\nconst server = http.createServer(app);\n\n// Initialize Socket.IO\ninitializeSocket(server, allowedOrigins, app);\n\n// Start server\nlet httpServer: http.Server | undefined;\n\nif (process.env.NODE_ENV !== \"test\") {\n  httpServer = server.listen(Number(port), \"0.0.0.0\", () => {\n    logger.info(`âš¡ Server is ready on port:${port} ðŸ”¥`);\n    logger.info(`Allowed origins: ${allowedOrigins}`);\n  });\n}\n\n// Setup graceful shutdown\nserverShutdown(httpServer);\n","import winston from \"winston\";\n\nconst logger = winston.createLogger({\n  level: \"info\",\n  format: winston.format.json(),\n  defaultMeta: { service: \"user-service\" },\n  transports: [\n    \n  ],\n});\n\nif (process.env.NODE_ENV !== \"production\") {\n  logger.add(\n    new winston.transports.Console({\n      format: winston.format.simple(),\n    }),\n  );\n} else {\n  logger.add(\n    new winston.transports.Console({\n      format: winston.format.json(),\n    }),\n  );\n}\n\nexport default logger;\n","import express, { Application } from \"express\";\nimport { toNodeHandler } from \"better-auth/node\";\nimport { auth } from \"@/core/auth\";\nimport { authMiddleware } from \"@/middlewares/authMiddleware\";\nimport { errorHandler } from \"@/middlewares/errorHandler\";\nimport messageRoutes from \"@/routes/messages\";\nimport conversationsRoutes from \"@/routes/conversations\";\nimport linkPreviewRoutes from \"@/routes/link-preview\";\nimport threadRoutes from \"@/routes/threads\";\nimport notificationRoutes from \"@/routes/notifications\";\nimport reactionRoutes from \"@/routes/reactions\";\nimport membersRoutes from \"@/routes/members\";\nimport channelRoutes from \"@/routes/channels\";\nimport logger from \"@/core/logger\";\n\nexport function setupRoutes(app: Application): void {\n  // Root route to avoid \"Cannot GET /\"\n  app.get(\"/\", (req, res) => {\n    res.json({\n      message: \"Lively Backend API is running\",\n      documentation: \"/health\",\n    });\n  });\n\n  // Session introspection endpoint for aura server-side auth (must be before catch-all)\n  app.get(\"/api/auth/session\", async (req, res) => {\n    const internalSecret = req.headers[\"x-internal-secret\"];\n\n    if (internalSecret !== process.env.SERVER_INTERNAL_SECRET) {\n      logger.warn(`[Auth] Forbidden introspection attempt from ${req.ip}`);\n      return res\n        .status(403)\n        .json({ error: \"Forbidden - Invalid internal secret\" });\n    }\n\n    const session = await auth.api.getSession({\n      headers: req.headers as any,\n    });\n    res.json({ data: session });\n  });\n\n  // Better Auth route (catch-all, must be after specific routes)\n  app.all(\"/api/auth/*\", toNodeHandler(auth));\n\n  // Health check endpoint (Public)\n  app.get(\"/health\", (req, res) => {\n    res.json({\n      status: \"ok\",\n      timestamp: new Date().toISOString(),\n      uptime: process.uptime(),\n    });\n  });\n\n  // Apply global auth middleware from here onwards\n  app.use(authMiddleware);\n\n    app.use(express.json());\n  \n  // Protected Routes\n  app.use(\"/api/messages\", messageRoutes);\n  app.use(\"/api/conversations\", conversationsRoutes);\n  app.use(\"/api/link-preview\", linkPreviewRoutes);\n  app.use(\"/api/threads\", threadRoutes);\n  app.use(\"/api/notifications\", notificationRoutes);\n  app.use(\"/api/reactions\", reactionRoutes);\n  app.use(\"/api/members\", membersRoutes);\n  app.use(\"/api/channels\", channelRoutes);\n\n  // Centralized error handling (MUST be after all routes)\n  app.use(errorHandler);\n}\n","import { betterAuth } from \"better-auth\";\nimport { prismaAdapter } from \"better-auth/adapters/prisma\";\nimport {\n  admin,\n  customSession,\n  magicLink,\n  twoFactor,\n} from \"better-auth/plugins\";\nimport { passkey } from \"@better-auth/passkey\";\n\nimport { prisma } from \"@/core/db\";\nimport { ac, roles } from \"@/utils/permissions\";\nimport { sendEmailAction } from \"@/email/email\";\nimport { hashPassword, verifyPassword } from \"@/libs/argon2\";\n\nexport const auth = betterAuth({\n  appName:\"Aura\",\n  basePath:\"\",\n  trustProxy: true,\n  database: prismaAdapter(prisma, {\n    provider: \"mongodb\",\n  }),\n  debug: true,\n  secret: process.env.BETTER_AUTH_SECRET,\n  baseURL:\n    process.env.BETTER_AUTH_URL || \"https://node-socket-io-hxb4.onrender.com\",\n  trustedOrigins: [\n    \"http://localhost:3000\",\n    \"http://localhost:7272\",\n    \"https://node-socket-io-hxb4.onrender.com\",\n    \"https://aura-seven-lyart.vercel.app\",\n    process.env.FRONTEND_URL,\n    process.env.BETTER_AUTH_URL,\n  ].filter((origin): origin is string => !!origin),\n\n  emailVerification: {\n    sendOnSignUp: true,\n    expiresIn: 60 * 60,\n    autoSignInAfterVerification: true,\n    sendVerificationEmail: async ({ user, url }) => {\n      const link = new URL(url);\n      link.searchParams.set(\"callbackURL\", \"/auth/verify\");\n\n      await sendEmailAction({\n        to: user.email,\n        subject: \"Verify your email address\",\n        meta: {\n          description:\n            \"Please verify your email address to complete the registration process.\",\n          link: String(link),\n        },\n      });\n    },\n  },\n  emailAndPassword: {\n    enabled: true,\n    minPasswordLength: 6,\n    autoSignIn: false,\n    password: {\n      hash: hashPassword,\n      verify: verifyPassword,\n    },\n    requireEmailVerification: false,\n    sendResetPassword: async ({ user, url }) => {\n      await sendEmailAction({\n        to: user.email,\n        subject: \"Reset your password\",\n        meta: {\n          description: \"Please click the link below to reset your password.\",\n          link: String(url),\n        },\n      });\n    },\n  },\n  databaseHooks: {\n    user: {\n      create: {\n        before: async (user) => {\n          const ADMIN_EMAILS = process.env.ADMIN_EMAILS?.split(\";\") ?? [];\n\n          if (ADMIN_EMAILS.includes(user.email)) {\n            return { data: { ...user, role: \"ADMIN\" } };\n          }\n\n          return { data: user };\n        },\n      },\n    },\n  },\n  user: {\n    additionalFields: {\n      role: {\n        type: [\"USER\", \"ADMIN\"],\n        input: false,\n      },\n    },\n  },\n  session: {\n    expiresIn: 30 * 24 * 60 * 60,\n    cookieCache: {\n      enabled: true,\n      maxAge: 5 * 60,\n    },\n  },\n\n  account: {\n    skipStateCookieCheck: true,\n    accountLinking: {\n      enabled: true,\n      trustedProviders: [\"google\", \"github\"],\n    },\n  },\n\n  advanced: {\n    database: {\n      generateId: false,\n    },\n    defaultCookieAttributes: {\n      sameSite: \"none\",\n      secure: true,\n    },\n    useSecureCookies: true,\n  },\n\n  secondaryStorage: {\n    get: async (key) => {\n      const value = await prisma.verification.findUnique({\n        where: { identifier: key },\n      });\n      console.log(`[SecondaryStorage] GET key=${key} found=${!!value}`);\n      return value?.value || null;\n    },\n    set: async (key, value, expiresAt) => {\n      console.log(`[SecondaryStorage] SET key=${key} expires=${expiresAt}`);\n      await prisma.verification.upsert({\n        where: { identifier: key },\n        create: {\n          identifier: key,\n          value,\n          expiresAt: new Date(expiresAt),\n        },\n        update: {\n          value,\n          expiresAt: new Date(expiresAt),\n        },\n      });\n    },\n    delete: async (key) => {\n      console.log(`[SecondaryStorage] DELETE key=${key}`);\n      await prisma.verification.deleteMany({\n        where: { identifier: key },\n      });\n    },\n  },\n  socialProviders: {\n    google: {\n      clientId: process.env.GOOGLE_CLIENT_ID!,\n      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,\n    },\n    github: {\n      clientId: process.env.GITHUB_CLIENT_ID!,\n      clientSecret: process.env.GITHUB_CLIENT_SECRET!,\n    },\n  },\n  plugins: [\n    admin({\n      defaultRole: \"USER\",\n      adminRoles: [\"ADMIN\"],\n      ac,\n      roles,\n    }),\n    magicLink({\n      sendMagicLink: async ({ email, url }) => {\n        await sendEmailAction({\n          to: email,\n          subject: \"Magic Link Login\",\n          meta: {\n            description: \"Please click the link below to log in.\",\n            link: String(url),\n          },\n        });\n      },\n    }),\n    twoFactor({\n      otpOptions: {},\n    }),\n    passkey(),\n    customSession(async ({ user, session }) => {\n      return {\n        session: {\n          expiresAt: session.expiresAt,\n          token: session.token,\n          userAgent: session.userAgent,\n        },\n        user: {\n          id: user.id,\n          name: user.name,\n          email: user.email,\n          image: user.image,\n          createdAt: user.createdAt,\n          role: (user as any).role,\n        },\n      };\n    }),\n  ],\n});\n","import { PrismaClient } from \"@prisma/client\";\n\nconst prismaClientSingleton = () => {\n  return new PrismaClient();\n};\n\ntype PrismaClientSingleton = ReturnType<typeof prismaClientSingleton>;\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClientSingleton | undefined;\n};\n\nexport const prisma = globalForPrisma.prisma ?? prismaClientSingleton();\n\nif (process.env.NODE_ENV !== \"production\") globalForPrisma.prisma = prisma;","import { createAccessControl } from \"better-auth/plugins/access\";\nimport { defaultStatements, adminAc } from \"better-auth/plugins/admin/access\";\n\nconst statements = {\n  ...defaultStatements,\n  posts: [\"create\", \"read\", \"update\", \"delete\", \"update:own\", \"delete:own\"],\n} as const;\n\nexport const ac = createAccessControl(statements);\n\nexport const roles = {\n  USER: ac.newRole({\n    posts: [\"create\", \"read\", \"update:own\", \"delete:own\"],\n  }),\n\n  ADMIN: ac.newRole({\n    posts: [\"create\", \"read\", \"update\", \"delete\", \"update:own\", \"delete:own\"],\n    ...adminAc.statements,\n  }),\n};\n","import nodemailer from \"nodemailer\";\n\nconst transporter = nodemailer.createTransport({\n  host: \"smtp.gmail.com\",\n  port: 465,\n  secure: true,\n  auth: {\n    user: process.env.NODEMAILER_USER,\n    pass: process.env.NODEMAILER_APP_PASSWORD,\n  },\n});\n\nexport default transporter;\n","import transporter from \"@/email/nodemailer\";\n\nconst styles = {\n  container:\n    \"max-width:500px;margin:20px auto;padding:20px;border:1px solid #ddd;border-radius:6px;\",\n  heading: \"font-size:20px;color:#333;\",\n  paragraph: \"font-size:16px;\",\n  link: \"display:inline-block;margin-top:15px;padding:10px 15px;background:#007bff;color:#fff;text-decoration:none;border-radius:4px;\",\n};\n\nexport async function sendEmailAction({\n  to,\n  subject,\n  meta,\n}: {\n  to: string;\n  subject: string;\n  meta: {\n    description: string;\n    link: string;\n  };\n}) {\n  const mailOptions = {\n    from: process.env.NODEMAILER_USER,\n    to,\n    subject: `GameCord - ${subject}`,\n    html: `\n    <div style=\"${styles.container}\">\n      <h1 style=\"${styles.heading}\">${subject}</h1>\n      <p style=\"${styles.paragraph}\">${meta.description}</p>\n      <a href=\"${meta.link}\" style=\"${styles.link}\">Click Here</a>\n    </div>\n    `,\n  };\n\n  try {\n    await transporter.sendMail(mailOptions);\n    return { success: true };\n  } catch (err) {\n    console.error(\"[SendEmail]:\", err);\n    return { success: false };\n  }\n}\n","import { hash, verify, type Options } from \"@node-rs/argon2\";\n\nconst opts: Options = {\n  memoryCost: 19456,\n  timeCost: 2,\n  outputLen: 32,\n  parallelism: 1,\n};\n\nexport async function hashPassword(password: string): Promise<string> {\n  const result = await hash(password, opts);\n  return result;\n}\n\nexport async function verifyPassword(data: {\n  password: string;\n  hash: string;\n}): Promise<boolean> {\n  const { password, hash: hashedPassword } = data;\n\n  const result = await verify(hashedPassword, password, opts);\n  return result;\n}\n","import { Request, Response, NextFunction } from \"express\";\nimport { auth } from \"@/core/auth\";\nimport { fromNodeHeaders } from \"better-auth/node\";\n\nexport const authMiddleware = async (\n  req: Request,\n  res: Response,\n  next: NextFunction,\n) => {\n  const session = await auth.api.getSession({\n    headers: fromNodeHeaders(req.headers),\n  });\n\n  console.log(\"[Auth] Session result:\", session ? \"FOUND\" : \"NULL\");\n  if (session) {\n    res.locals.userId = session.user.id;\n    res.locals.user = session.user;\n    return next();\n  }\n\n  const internalSecret = req.headers[\"x-internal-secret\"] as string;\n  const bridgedUserId = req.headers[\"x-user-id\"] as string;\n\n  console.log(\"[Auth] Bridged Auth Attempt:\", {\n    hasSecret: !!internalSecret,\n    hasUserId: !!bridgedUserId,\n    secretMatch: internalSecret === process.env.SERVER_INTERNAL_SECRET,\n  });\n\n  if (\n    internalSecret &&\n    internalSecret === process.env.SERVER_INTERNAL_SECRET &&\n    bridgedUserId\n  ) {\n    res.locals.userId = bridgedUserId;\n    return next();\n  }\n\n  // Temporary fallback for development if cookies/secrets are failing\n  if (process.env.NODE_ENV !== \"production\" && bridgedUserId) {\n    console.warn(\n      \"[Auth] WARNING: Using insecure fallback userId:\",\n      bridgedUserId,\n    );\n    res.locals.userId = bridgedUserId;\n    return next();\n  }\n\n  console.error(\"[Auth] Authentication FAILED for:\", req.url);\n  return res\n    .status(401)\n    .json({ error: \"Unauthorized - No valid session or secure bridge found\" });\n};\n","import { Response } from \"express\";\n\n/**\n * Standardized API Response utility\n */\nexport class ApiResponse {\n  /**\n   * Send a success response\n   */\n  public static success(\n    res: Response,\n    data: any,\n    message: string = \"Success\",\n    status: number = 200,\n  ) {\n    return res.status(status).json({\n      success: true,\n      message,\n      data,\n    });\n  }\n\n  /**\n   * Send an error response\n   */\n  public static error(\n    res: Response,\n    error: string,\n    status: number = 500,\n    stack?: string,\n  ) {\n    return res.status(status).json({\n      success: false,\n      error,\n      ...(process.env.NODE_ENV !== \"production\" && stack ? { stack } : {}),\n    });\n  }\n}\n","/**\n * Base class for application-specific errors\n */\nexport class AppError extends Error {\n  public readonly statusCode: number;\n  public readonly isOperational: boolean;\n\n  constructor(\n    message: string,\n    statusCode: number = 500,\n    isOperational: boolean = true,\n  ) {\n    super(message);\n    this.statusCode = statusCode;\n    this.isOperational = isOperational;\n\n    Object.setPrototypeOf(this, new.target.prototype);\n    Error.captureStackTrace(this, this.constructor);\n  }\n}\n\n/**\n * 400 Bad Request\n */\nexport class BadRequestError extends AppError {\n  constructor(message: string = \"Bad Request\") {\n    super(message, 400);\n  }\n}\n\n/**\n * 401 Unauthorized\n */\nexport class UnauthorizedError extends AppError {\n  constructor(message: string = \"Unauthorized\") {\n    super(message, 401);\n  }\n}\n\n/**\n * 403 Forbidden\n */\nexport class ForbiddenError extends AppError {\n  constructor(message: string = \"Forbidden\") {\n    super(message, 403);\n  }\n}\n\n/**\n * 404 Not Found\n */\nexport class NotFoundError extends AppError {\n  constructor(message: string = \"Resource not found\") {\n    super(message, 404);\n  }\n}\n\n/**\n * 500 Internal Server Error\n */\nexport class InternalServerError extends AppError {\n  constructor(message: string = \"Internal Server Error\") {\n    super(message, 500);\n  }\n}\n","import { NextFunction, Request, Response } from \"express\";\nimport { ApiResponse } from \"@/utils/api-response\";\nimport { AppError } from \"@/utils/errors\";\n\n/**\n * Centralized error handler middleware.\n * Catches all unhandled errors and returns a consistent JSON response.\n */\nexport const errorHandler = (\n  err: any,\n  req: Request,\n  res: Response,\n  next: NextFunction,\n) => {\n  let statusCode = err.statusCode || 500;\n  let message = err.message || \"Something went wrong\";\n\n  // If it's one of our custom AppErrors, it carries its own metadata\n  if (err instanceof AppError) {\n    statusCode = err.statusCode;\n    message = err.message;\n  }\n\n  // Log only if it's an internal server error or unexpected error\n  if (statusCode >= 500) {\n    console.error(\n      `[Error] ${req.method} ${req.url} - Status: ${statusCode}`,\n      err,\n    );\n  }\n\n  ApiResponse.error(res, message, statusCode, err.stack);\n};\n","import { Request, Response, Router } from \"express\";\n\nconst router: Router = Router();\n\nimport {\n  createChannelMessage,\n  createDirectMessage,\n  updateMessage,\n  deleteMessage,\n  getConversation,\n  sendMessageController,\n  getMessages,\n} from \"@/controllers/message\";\nimport validator from \"@/middlewares/validationMiddleware\";\nimport {\n  createChannelMessageSchema,\n  createDirectMessageSchema,\n  updateMessageSchema,\n  deleteMessageSchema,\n} from \"@/schemas/message.schema\";\n\nrouter.post(\n  \"/channel\",\n  validator(createChannelMessageSchema),\n  createChannelMessage,\n);\n\nrouter.post(\n  \"/direct\",\n  validator(createDirectMessageSchema),\n  createDirectMessage,\n);\n\nrouter.patch(\"/:messageId\", validator(updateMessageSchema), updateMessage);\n\nrouter.delete(\"/:messageId\", validator(deleteMessageSchema), deleteMessage);\n\nrouter.get(\"/conversation\", getConversation);\n\nrouter.get(\"/\", getMessages);\n\nexport default router;\n","import { prisma } from \"@/core/db\";\nimport { Member } from \"@prisma/client\";\n\nexport class MemberService {\n  /**\n   * Resolves a member context from either serverId or conversationId\n   */\n  public static async resolveMember(\n    userId: string,\n    options: { serverId?: string; conversationId?: string },\n  ): Promise<Member | null> {\n    const { serverId, conversationId } = options;\n\n    if (serverId) {\n      return await prisma.member.findFirst({\n        where: {\n          profile: { userId },\n          serverId,\n        },\n      });\n    }\n\n    if (conversationId) {\n      const conversation = await prisma.conversation.findUnique({\n        where: { id: conversationId },\n        include: {\n          memberOne: true,\n          memberTwo: true,\n        },\n      });\n\n      if (!conversation) return null;\n\n      return await prisma.member.findFirst({\n        where: {\n          profile: { userId },\n          OR: [\n            { id: conversation.memberOneId },\n            { id: conversation.memberTwoId },\n          ],\n        },\n      });\n    }\n\n    return null;\n  }\n}\n","import { EventEmitter } from \"events\";\n\nexport const events = new EventEmitter();\n\n// Define Event Constants for DRY\nexport const MESSAGE_EVENTS = {\n  CREATED: \"message:created\",\n  UPDATED: \"message:updated\",\n  DELETED: \"message:deleted\",\n};\n\nexport const NOTIFICATION_EVENTS = {\n  NEW: \"notification:new\",\n};\n\nexport const REACTION_EVENTS = {\n  ADDED: \"reaction:added\",\n  REMOVED: \"reaction:removed\",\n};\n","import { prisma } from \"@/core/db\";\nimport { MemberService } from \"@/services/member\";\nimport { events, MESSAGE_EVENTS } from \"@/core/events\";\nimport {\n  BadRequestError,\n  NotFoundError,\n  UnauthorizedError,\n} from \"@/utils/errors\";\n\nexport class MessageService {\n  /**\n   * Create a channel message\n   */\n  public static async createChannelMessage(payload: {\n    content: string;\n    fileUrl?: string;\n    isEncrypted?: boolean;\n    parentId?: string;\n    serverId: string;\n    channelId: string;\n    userId: string;\n  }) {\n    const {\n      content,\n      fileUrl,\n      isEncrypted,\n      parentId,\n      serverId,\n      channelId,\n      userId,\n    } = payload;\n\n    const member = await MemberService.resolveMember(userId, { serverId });\n\n    if (!member) {\n      throw new NotFoundError(\"Member not found in this server\");\n    }\n\n    const message = await prisma.message.create({\n      data: {\n        content,\n        fileUrl: fileUrl || null,\n        channelId,\n        memberId: member.id,\n        isEncrypted: !!isEncrypted,\n        parentId: parentId || null,\n      },\n      include: {\n        member: {\n          include: {\n            profile: true,\n          },\n        },\n      },\n    });\n\n    events.emit(MESSAGE_EVENTS.CREATED, {\n      message,\n      type: \"channel\",\n      contextId: channelId,\n    });\n    return message;\n  }\n\n  /**\n   * Create a direct message\n   */\n  public static async createDirectMessage(payload: {\n    content: string;\n    fileUrl?: string;\n    isEncrypted?: boolean;\n    parentId?: string;\n    conversationId: string;\n    userId: string;\n  }) {\n    const { content, fileUrl, isEncrypted, parentId, conversationId, userId } =\n      payload;\n\n    const member = await MemberService.resolveMember(userId, {\n      conversationId,\n    });\n\n    if (!member) {\n      throw new NotFoundError(\"Member not found in conversation\");\n    }\n\n    const message = await prisma.directMessage.create({\n      data: {\n        content,\n        fileUrl: fileUrl || null,\n        conversationId,\n        memberId: member.id,\n        isEncrypted: !!isEncrypted,\n        parentId: parentId || null,\n      },\n      include: {\n        member: {\n          include: {\n            profile: true,\n          },\n        },\n      },\n    });\n\n    events.emit(MESSAGE_EVENTS.CREATED, {\n      message,\n      type: \"direct\",\n      contextId: conversationId,\n    });\n    return message;\n  }\n\n  /**\n   * Update a message (Polymorphic)\n   */\n  public static async updateMessage(payload: {\n    messageId: string;\n    content: string;\n    userId: string;\n    serverId?: string;\n    conversationId?: string;\n  }) {\n    const { messageId, content, userId, serverId, conversationId } = payload;\n\n    const member = await MemberService.resolveMember(userId, {\n      serverId,\n      conversationId,\n    });\n    if (!member) throw new UnauthorizedError(\"Member not found\");\n\n    if (serverId) {\n      const message = await prisma.message.findFirst({\n        where: { id: messageId, memberId: member.id, deleted: false },\n      });\n\n      if (!message)\n        throw new NotFoundError(\"Message not found or unauthorized\");\n\n      const updated = await prisma.message.update({\n        where: { id: messageId },\n        data: { content },\n        include: { member: { include: { profile: true } } },\n      });\n\n      events.emit(MESSAGE_EVENTS.UPDATED, {\n        message: updated,\n        type: \"channel\",\n        contextId: message.channelId,\n      });\n      return updated;\n    } else if (conversationId) {\n      const message = await prisma.directMessage.findFirst({\n        where: { id: messageId, memberId: member.id, deleted: false },\n      });\n\n      if (!message)\n        throw new NotFoundError(\"Message not found or unauthorized\");\n\n      const updated = await prisma.directMessage.update({\n        where: { id: messageId },\n        data: { content },\n        include: { member: { include: { profile: true } } },\n      });\n\n      events.emit(MESSAGE_EVENTS.UPDATED, {\n        message: updated,\n        type: \"direct\",\n        contextId: conversationId,\n      });\n      return updated;\n    }\n\n    throw new BadRequestError(\n      \"Context missing (serverId or conversationId required)\",\n    );\n  }\n\n  /**\n   * Delete a message (Polymorphic)\n   */\n  public static async deleteMessage(payload: {\n    messageId: string;\n    userId: string;\n    serverId?: string;\n    conversationId?: string;\n  }) {\n    const { messageId, userId, serverId, conversationId } = payload;\n\n    const member = await MemberService.resolveMember(userId, {\n      serverId,\n      conversationId,\n    });\n    if (!member) throw new UnauthorizedError(\"Member not found\");\n\n    if (serverId) {\n      const message = await prisma.message.findFirst({\n        where: { id: messageId },\n        include: { member: true },\n      });\n\n      if (!message || message.deleted)\n        throw new NotFoundError(\"Message not found\");\n\n      const canDelete =\n        message.memberId === member.id ||\n        [\"ADMIN\", \"MODERATOR\"].includes(member.role);\n      if (!canDelete)\n        throw new UnauthorizedError(\"Unauthorized to delete this message\");\n\n      const deleted = await prisma.message.update({\n        where: { id: messageId },\n        data: {\n          fileUrl: null,\n          content: \"This message has been deleted.\",\n          deleted: true,\n        },\n        include: { member: { include: { profile: true } } },\n      });\n\n      events.emit(MESSAGE_EVENTS.UPDATED, {\n        message: deleted,\n        type: \"channel\",\n        contextId: message.channelId,\n      });\n      return deleted;\n    } else if (conversationId) {\n      const message = await prisma.directMessage.findFirst({\n        where: { id: messageId, conversationId },\n      });\n\n      if (!message || message.deleted)\n        throw new NotFoundError(\"Message not found\");\n      if (message.memberId !== member.id)\n        throw new UnauthorizedError(\"Unauthorized to delete this message\");\n\n      const deleted = await prisma.directMessage.update({\n        where: { id: messageId },\n        data: {\n          fileUrl: null,\n          content: \"This message has been deleted.\",\n          deleted: true,\n        },\n        include: { member: { include: { profile: true } } },\n      });\n\n      events.emit(MESSAGE_EVENTS.UPDATED, {\n        message: deleted,\n        type: \"direct\",\n        contextId: conversationId,\n      });\n      return deleted;\n    }\n\n    throw new BadRequestError(\n      \"Context missing (serverId or conversationId required)\",\n    );\n  }\n}\n","import { prisma } from \"@/core/db\";\n\nexport const findOrCreateConversation = async (\n  memberOneId: string,\n  memberTwoId: string,\n) => {\n  let conversation =\n    (await findConversation(memberOneId, memberTwoId)) ||\n    (await findConversation(memberTwoId, memberOneId));\n\n  if (!conversation) {\n    conversation = await createNewConversation(memberOneId, memberTwoId);\n  }\n\n  return conversation;\n};\n\nconst findConversation = async (memberOneId: string, memberTwoId: string) => {\n  try {\n    return await prisma.conversation.findFirst({\n      where: {\n        AND: [{ memberOneId: memberOneId }, { memberTwoId: memberTwoId }],\n      },\n      include: {\n        memberOne: {\n          include: {\n            profile: true,\n          },\n        },\n        memberTwo: {\n          include: {\n            profile: true,\n          },\n        },\n      },\n    });\n  } catch (error) {\n    console.error(\"Error finding conversation:\", error);\n    return null;\n  }\n};\n\nconst createNewConversation = async (\n  memberOneId: string,\n  memberTwoId: string,\n) => {\n  try {\n    return await prisma.conversation.create({\n      data: {\n        memberOneId,\n        memberTwoId,\n      },\n      include: {\n        memberOne: {\n          include: {\n            profile: true,\n          },\n        },\n        memberTwo: {\n          include: {\n            profile: true,\n          },\n        },\n      },\n    });\n  } catch {\n    return null;\n  }\n};\n","import { Request, Response } from \"express\";\nimport { MessageService } from \"@/services/message\";\nimport { findOrCreateConversation } from \"@/services/conversation\";\nimport { ApiResponse } from \"@/utils/api-response\";\nimport logger from \"@/core/logger\";\nimport { prisma } from \"@/core/db\";\n\n/**\n * Create a channel message\n */\nexport const createChannelMessage = async (req: Request, res: Response) => {\n  try {\n    const { content, fileUrl, isEncrypted, parentId } = req.body;\n    const { serverId, channelId } = req.query;\n    const userId = res.locals.userId;\n\n    if (!serverId || !channelId) {\n      return ApiResponse.error(res, \"Server ID or Channel ID missing\", 400);\n    }\n\n    const message = await MessageService.createChannelMessage({\n      content,\n      fileUrl,\n      isEncrypted,\n      parentId,\n      serverId: serverId as string,\n      channelId: channelId as string,\n      userId,\n    });\n\n    return ApiResponse.success(res, message, \"Message created\", 201);\n  } catch (error: any) {\n    logger.error(\"[CREATE_CHANNEL_MESSAGE]\", error);\n    const status =\n      error.message === \"Member not found in this server\" ? 404 : 500;\n    return ApiResponse.error(\n      res,\n      error.message || \"Internal server error\",\n      status,\n    );\n  }\n};\n\n/**\n * Create a direct message\n */\nexport const createDirectMessage = async (req: Request, res: Response) => {\n  try {\n    const { content, fileUrl, isEncrypted, parentId } = req.body;\n    const { conversationId } = req.query;\n    const userId = res.locals.userId;\n\n    if (!conversationId) {\n      return ApiResponse.error(res, \"Conversation ID missing\", 400);\n    }\n\n    const message = await MessageService.createDirectMessage({\n      content,\n      fileUrl,\n      isEncrypted,\n      parentId,\n      conversationId: conversationId as string,\n      userId,\n    });\n\n    return ApiResponse.success(res, message, \"Direct message created\", 201);\n  } catch (error: any) {\n    logger.error(\"[CREATE_DIRECT_MESSAGE]\", error);\n    const status =\n      error.message === \"Member not found in conversation\" ? 404 : 500;\n    return ApiResponse.error(\n      res,\n      error.message || \"Internal server error\",\n      status,\n    );\n  }\n};\n\n/**\n * Update a message\n */\nexport const updateMessage = async (req: Request, res: Response) => {\n  try {\n    const { messageId } = req.params;\n    const { content } = req.body;\n    const { serverId, conversationId } = req.query;\n    const userId = res.locals.userId;\n\n    if (!content) {\n      return ApiResponse.error(res, \"Content missing\", 400);\n    }\n\n    const updatedMessage = await MessageService.updateMessage({\n      messageId,\n      content,\n      userId,\n      serverId: serverId as string,\n      conversationId: conversationId as string,\n    });\n\n    return ApiResponse.success(res, updatedMessage, \"Message updated\");\n  } catch (error: any) {\n    logger.error(\"[UPDATE_MESSAGE]\", error);\n    return ApiResponse.error(res, error.message || \"Internal server error\");\n  }\n};\n\n/**\n * Delete a message\n */\nexport const deleteMessage = async (req: Request, res: Response) => {\n  try {\n    const { messageId } = req.params;\n    const { serverId, conversationId } = req.query;\n    const userId = res.locals.userId;\n\n    const deletedMessage = await MessageService.deleteMessage({\n      messageId,\n      userId,\n      serverId: serverId as string,\n      conversationId: conversationId as string,\n    });\n\n    return ApiResponse.success(res, deletedMessage, \"Message deleted\");\n  } catch (error: any) {\n    logger.error(\"[DELETE_MESSAGE]\", error);\n    return ApiResponse.error(res, error.message || \"Internal server error\");\n  }\n};\n\n// --- Legacy controllers (Consider refactoring these into MessageService later) ---\n\nexport const getConversation = async (req: Request, res: Response) => {\n  const { receiverId } = req.query;\n  try {\n    const conversation = await findOrCreateConversation(\n      res.locals.userId,\n      receiverId as string,\n    );\n    return ApiResponse.success(res, conversation);\n  } catch (err: any) {\n    logger.error(err);\n    return ApiResponse.error(res, err.message);\n  }\n};\n\nexport const sendMessageController = async (req: Request, res: Response) => {\n  try {\n    const { message } = req.body;\n    const { receiverId } = req.query;\n    const userId = res.locals.userId;\n\n    const conversation = await findOrCreateConversation(\n      userId,\n      receiverId as string,\n    );\n    if (!conversation)\n      return ApiResponse.error(res, \"Conversation not found\", 404);\n\n    const result = await MessageService.createDirectMessage({\n      content: message,\n      conversationId: conversation.id,\n      userId,\n    });\n\n    return ApiResponse.success(res, result, \"Message sent\", 201);\n  } catch (error: any) {\n    logger.error(error);\n    return ApiResponse.error(res, error.message || \"Internal server error\");\n  }\n};\n\nexport const getMessages = async (req: Request, res: Response) => {\n  const { receiverId, channelId, cursor } = req.query;\n  const MESSAGES_BATCH = 10;\n\n  try {\n    let messages = [];\n\n    if (channelId) {\n      // Fetch channel messages\n      messages = await prisma.message.findMany({\n        take: MESSAGES_BATCH,\n        ...(cursor && { skip: 1, cursor: { id: cursor as string } }),\n        where: { channelId: channelId as string },\n        include: { member: { include: { profile: true } } },\n        orderBy: { createdAt: \"desc\" },\n      });\n    } else if (receiverId) {\n      // Fetch direct messages\n      const conversation = await findOrCreateConversation(\n        res.locals.userId,\n        receiverId as string,\n      );\n\n      if (!conversation) {\n        return ApiResponse.error(res, \"Conversation not found\", 404);\n      }\n\n      messages = await prisma.directMessage.findMany({\n        take: MESSAGES_BATCH,\n        ...(cursor && { skip: 1, cursor: { id: cursor as string } }),\n        where: { conversationId: conversation.id },\n        include: { member: { include: { profile: true } } },\n        orderBy: { createdAt: \"desc\" },\n      });\n    } else {\n      return ApiResponse.error(res, \"receiverId or channelId required\", 400);\n    }\n\n    let nextCursor = null;\n    if (messages.length === MESSAGES_BATCH) {\n      nextCursor = messages[MESSAGES_BATCH - 1].id;\n    }\n\n    return ApiResponse.success(res, {\n      items: messages,\n      nextCursor,\n    });\n  } catch (error) {\n    logger.error(\"[GET_MESSAGES]\", error);\n    return ApiResponse.error(res, \"Internal server error\");\n  }\n};\n","import { AnyZodObject } from \"zod\";\nimport { Request, Response, NextFunction } from \"express\";\n\nconst validator =\n  (schema: AnyZodObject) =>\n  (req: Request, res: Response, next: NextFunction) => {\n    try {\n      schema.parse({\n        body: req.body,\n        query: req.query,\n        params: req.params,\n      });\n      next();\n    } catch (err: any) {\n      console.log(err);\n      return res.status(400).send(err.errors);\n    }\n  };\n\nexport default validator;\n","import { z } from \"zod\";\n\n/**\n * Schema for creating a channel message\n */\nexport const createChannelMessageSchema = z.object({\n  body: z.object({\n    content: z.string().min(1).max(5000),\n    fileUrl: z.string().url().optional().nullable(),\n    isEncrypted: z.boolean().optional(),\n  }),\n  query: z.object({\n    serverId: z.string().min(1),\n    channelId: z.string().min(1),\n  }),\n});\n\n/**\n * Schema for creating a direct message\n */\nexport const createDirectMessageSchema = z.object({\n  body: z.object({\n    content: z.string().min(1).max(5000),\n    fileUrl: z.string().url().optional().nullable(),\n    isEncrypted: z.boolean().optional(),\n  }),\n  query: z.object({\n    conversationId: z.string().min(1),\n  }),\n});\n\nexport const updateMessageSchema = z.object({\n  params: z.object({\n    messageId: z.string().min(1),\n  }),\n  body: z.object({\n    content: z.string().min(1).max(5000),\n  }),\n  query: z.object({\n    serverId: z.string().optional(),\n    channelId: z.string().optional(),\n    conversationId: z.string().optional(),\n  }),\n});\n\n/**\n * Schema for deleting a message\n */\nexport const deleteMessageSchema = z.object({\n  params: z.object({\n    messageId: z.string().min(1),\n  }),\n  query: z.object({\n    serverId: z.string().optional(),\n    channelId: z.string().optional(),\n    conversationId: z.string().optional(),\n  }),\n});\n\n// Backward compatibility or other uses\nexport const conversationSchema = z.object({\n  query: z.object({\n    receiverId: z.string().min(1),\n  }),\n});\n\nexport const sendMessageSchema = z.object({\n  body: z.object({\n    message: z.string().min(1),\n  }),\n  query: z.object({\n    receiverId: z.string().min(1),\n  }),\n});\n","import { Router } from \"express\";\nimport { getConversations } from \"@/controllers/conversation\";\n\nconst router: Router = Router();\n\n// GET /api/conversations?serverId={serverId}\nrouter.get(\"/\", getConversations);\n\nexport default router;\n","import { Request, Response } from \"express\";\nimport { prisma } from \"@/core/db\";\nimport { ApiResponse } from \"@/utils/api-response\";\n\n/**\n * Get all active conversations for the current user in a specific server\n * GET /api/conversations?serverId={serverId}\n */\nexport const getConversations = async (req: Request, res: Response) => {\n  try {\n    const { serverId } = req.query;\n    const userId = res.locals.userId;\n\n    // Get the current profile\n    const profile = await prisma.profile.findFirst({\n      where: {\n        userId: userId,\n      },\n      include: {\n        members: true,\n      },\n    });\n\n    if (!profile) {\n      return ApiResponse.error(res, \"Profile not found\", 404);\n    }\n\n    let memberIds: string[] = [];\n\n    if (serverId) {\n      // Get the current member in this specific server\n      const currentMember = profile.members.find(\n        (m) => m.serverId === (serverId as string),\n      );\n\n      if (!currentMember) {\n        return ApiResponse.error(res, \"Member not found in this server\", 404);\n      }\n      memberIds = [currentMember.id];\n    } else {\n      // Global: get all member IDs for this profile across all servers\n      memberIds = profile.members.map((m) => m.id);\n    }\n\n    if (memberIds.length === 0) {\n      return ApiResponse.success(res, {\n        conversations: [],\n        currentMemberId: null,\n      });\n    }\n\n    // Find all conversations where any of the current user's members are involved\n    const conversations = await prisma.conversation.findMany({\n      where: {\n        OR: [\n          { memberOneId: { in: memberIds } },\n          { memberTwoId: { in: memberIds } },\n        ],\n      },\n      include: {\n        memberOne: {\n          include: {\n            profile: true,\n            server: true, // Include server info so user knows which server the DM is from\n          },\n        },\n        memberTwo: {\n          include: {\n            profile: true,\n            server: true,\n          },\n        },\n        directMessages: {\n          take: 1,\n          orderBy: {\n            createdAt: \"desc\",\n          },\n        },\n      },\n    });\n\n    // Filter to only include conversations with at least one message\n    // and sort by most recent message\n    const activeConversations = conversations\n      .filter((conv) => conv.directMessages.length > 0)\n      .sort((a, b) => {\n        const aTime = a.directMessages[0]?.createdAt.getTime() || 0;\n        const bTime = b.directMessages[0]?.createdAt.getTime() || 0;\n        return bTime - aTime; // Most recent first\n      });\n\n    return ApiResponse.success(res, {\n      conversations: activeConversations,\n      currentMemberIds: memberIds,\n    });\n  } catch (error) {\n    console.error(\"[GET_CONVERSATIONS]\", error);\n    return ApiResponse.error(res, \"Internal server error\");\n  }\n};\n","import { Router } from \"express\";\nimport { getLinkPreview } from \"@/controllers/link-preview\";\n\nconst router: Router = Router();\n\nrouter.get(\"/\", getLinkPreview);\n\nexport default router;\n","import { Request, Response } from \"express\";\nimport axios from \"axios\";\nimport logger from \"@/core/logger\";\nimport { ApiResponse } from \"@/utils/api-response\";\n\nexport const getLinkPreview = async (req: Request, res: Response) => {\n  try {\n    const { url } = req.query;\n\n    if (!url || typeof url !== \"string\") {\n      return ApiResponse.error(res, \"URL is required\", 400);\n    }\n\n    const apiKey = process.env.OPENGRAPH_IO_KEY;\n\n    if (!apiKey) {\n      logger.error(\n        \"[LinkPreview] OPENGRAPH_IO_KEY is missing in environment variables.\",\n      );\n      return ApiResponse.error(\n        res,\n        \"Link preview service is not configured.\",\n        500,\n      );\n    }\n\n    logger.info(`[LinkPreview] Fetching from OpenGraph.io for: ${url}`);\n\n    const opengraphUrl = `https://opengraph.io/api/1.1/site/${encodeURIComponent(url)}?app_id=${apiKey}`;\n\n    const response = await axios.get(opengraphUrl, { timeout: 10000 });\n    const data = response.data;\n\n    if (data.error) {\n      logger.error(`[OpenGraph.io] Error: ${data.error.message}`);\n      return ApiResponse.error(res, data.error.message, 400);\n    }\n\n    // Transform OpenGraph.io response to our simplified format\n    const hybrid = data.hybridGraph || {};\n    const openGraph = data.openGraph || {};\n    const htmlInferred = data.htmlInferred || {};\n\n    let fallbackTitle = url;\n    try {\n      fallbackTitle = new URL(url).hostname;\n    } catch (e) {\n      // Ignore\n    }\n\n    return ApiResponse.success(\n      res,\n      {\n        title:\n          hybrid.title ||\n          openGraph.title ||\n          htmlInferred.title ||\n          fallbackTitle,\n        description:\n          hybrid.description ||\n          openGraph.description ||\n          htmlInferred.description ||\n          \"\",\n        image: hybrid.image || openGraph.image || htmlInferred.image || null,\n        favIcon: data.favicon || null,\n        url: data.url || url,\n      },\n      \"Link preview fetched\",\n    );\n  } catch (error: any) {\n    if (axios.isAxiosError(error) && error.response) {\n      logger.error(\n        `[LinkPreview] OpenGraph.io returned ${error.response.status}: ${JSON.stringify(error.response.data)}`,\n      );\n      return ApiResponse.error(\n        res,\n        error.response.data.error?.message || \"External service error\",\n        error.response.status,\n      );\n    }\n\n    logger.error(`[LinkPreview] Unexpected Error: ${error.message}`);\n    return ApiResponse.error(res, \"Failed to fetch link preview\");\n  }\n};\n","import { Router } from \"express\";\nimport { getChannelThreadMetadata, getDirectThreadMetadata } from \"@/controllers/thread\";\n\nconst router: Router = Router();\n\nrouter.get(\"/channel/:messageId\", getChannelThreadMetadata);\nrouter.get(\"/direct/:messageId\", getDirectThreadMetadata);\n\nexport default router;\n","import { Request, Response } from \"express\";\nimport { prisma } from \"@/core/db\";\nimport { ApiResponse } from \"@/utils/api-response\";\n\n// Get thread metadata for a channel message\nexport const getChannelThreadMetadata = async (req: Request, res: Response) => {\n  try {\n    const { messageId } = req.params;\n\n    if (!messageId) {\n      return ApiResponse.error(res, \"Message ID missing\", 400);\n    }\n\n    // Get all replies to this message\n    const replies = await prisma.message.findMany({\n      where: {\n        parentId: messageId,\n        deleted: false,\n      },\n      include: {\n        member: {\n          include: {\n            profile: true,\n          },\n        },\n      },\n      orderBy: {\n        createdAt: \"desc\",\n      },\n    });\n\n    // Extract unique participants\n    const participantsMap = new Map();\n    replies.forEach((reply) => {\n      if (!participantsMap.has(reply.member.profile.id)) {\n        participantsMap.set(reply.member.profile.id, {\n          id: reply.member.profile.id,\n          name: reply.member.profile.name,\n          imageUrl: reply.member.profile.imageUrl,\n        });\n      }\n    });\n\n    const participants = Array.from(participantsMap.values());\n    const lastReplyAt = replies.length > 0 ? replies[0].createdAt : null;\n\n    return ApiResponse.success(res, {\n      replyCount: replies.length,\n      participants,\n      lastReplyAt,\n    });\n  } catch (error) {\n    console.error(\"[GET_CHANNEL_THREAD_METADATA]\", error);\n    return ApiResponse.error(res, \"Internal server error\");\n  }\n};\n\n// Get thread metadata for a direct message\nexport const getDirectThreadMetadata = async (req: Request, res: Response) => {\n  try {\n    const { messageId } = req.params;\n\n    if (!messageId) {\n      return ApiResponse.error(res, \"Message ID missing\", 400);\n    }\n\n    // Get all replies to this message\n    const replies = await prisma.directMessage.findMany({\n      where: {\n        parentId: messageId,\n        deleted: false,\n      },\n      include: {\n        member: {\n          include: {\n            profile: true,\n          },\n        },\n      },\n      orderBy: {\n        createdAt: \"desc\",\n      },\n    });\n\n    // Extract unique participants\n    const participantsMap = new Map();\n    replies.forEach((reply) => {\n      if (!participantsMap.has(reply.member.profile.id)) {\n        participantsMap.set(reply.member.profile.id, {\n          id: reply.member.profile.id,\n          name: reply.member.profile.name,\n          imageUrl: reply.member.profile.imageUrl,\n        });\n      }\n    });\n\n    const participants = Array.from(participantsMap.values());\n    const lastReplyAt = replies.length > 0 ? replies[0].createdAt : null;\n\n    return ApiResponse.success(res, {\n      replyCount: replies.length,\n      participants,\n      lastReplyAt,\n    });\n  } catch (error) {\n    console.error(\"[GET_DIRECT_THREAD_METADATA]\", error);\n    return ApiResponse.error(res, \"Internal server error\");\n  }\n};\n","import { Router } from \"express\";\nimport {\n  getNotifications,\n  getUnreadCount,\n  markAsRead,\n  markAllAsRead,\n  deleteNotification,\n  deleteAllNotifications,\n} from \"@/controllers/notification\";\n\nimport { authMiddleware } from \"@/middlewares/authMiddleware\";\n\nconst router: Router = Router();\n\n// Apply auth middleware to all notification routes\nrouter.use(authMiddleware);\n\n// Get all notifications\nrouter.get(\"/\", getNotifications);\n\n// Get unread count\nrouter.get(\"/unread-count\", getUnreadCount);\n\n// Mark notification as read\nrouter.patch(\"/:notificationId/read\", markAsRead);\n\n// Mark all as read\nrouter.patch(\"/mark-all-read\", markAllAsRead);\n\n// Delete notification\nrouter.delete(\"/:notificationId\", deleteNotification);\n\n// Delete all notifications\nrouter.delete(\"/delete-all\", deleteAllNotifications);\n\nexport default router;\n","import { prisma } from \"@/core/db\";\n\n/**\n * Get profile by user ID\n */\nexport const getProfileByUserId = async (userId: string) => {\n  return await prisma.profile.findUnique({\n    where: { userId },\n  });\n};\n\n/**\n * Get member by user ID and server ID\n */\nexport const getMemberByUserIdAndServerId = async (\n  userId: string,\n  serverId: string,\n) => {\n  return await prisma.member.findFirst({\n    where: {\n      profile: { userId },\n      serverId,\n    },\n  });\n};\n\n/**\n * Get member by user ID and conversation ID\n */\nexport const getMemberByUserIdAndConversationId = async (\n  userId: string,\n  conversationId: string,\n) => {\n  const conversation = await prisma.conversation.findUnique({\n    where: { id: conversationId },\n    include: {\n      memberOne: true,\n      memberTwo: true,\n    },\n  });\n\n  if (!conversation) {\n    return null;\n  }\n\n  return await prisma.member.findFirst({\n    where: {\n      profile: { userId },\n      OR: [{ id: conversation.memberOneId }, { id: conversation.memberTwoId }],\n    },\n  });\n};\n","import { Request, Response } from \"express\";\n\nimport { prisma } from \"@/core/db\";\nimport logger from \"@/core/logger\";\nimport { ApiResponse } from \"@/utils/api-response\";\nimport { getProfileByUserId } from \"@/services/profile\";\n\n// Get all notifications for current user\nexport const getNotifications = async (req: Request, res: Response) => {\n  try {\n    const userId = res.locals.userId;\n    if (!userId) return ApiResponse.error(res, \"Unauthorized\", 401);\n\n    if (!prisma.notification) {\n      logger.error(\n        \"[ERROR] prisma.notification is UNDEFINED. Current models:\",\n        Object.keys(prisma),\n      );\n      return ApiResponse.error(\n        res,\n        \"Database model 'notification' not found in Prisma client\",\n        500,\n      );\n    }\n\n    const profile = await getProfileByUserId(userId);\n    if (!profile) return ApiResponse.error(res, \"Profile not found\", 404);\n\n    const notifications = await prisma.notification.findMany({\n      where: { receiverId: profile.id },\n      include: {\n        sender: {\n          select: { id: true, name: true, imageUrl: true },\n        },\n      },\n      orderBy: { createdAt: \"desc\" },\n      take: 50,\n    });\n\n    return ApiResponse.success(res, notifications);\n  } catch (error) {\n    console.error(\"[GET_NOTIFICATIONS]\", error);\n    return ApiResponse.error(res, \"Internal server error\");\n  }\n};\n\n// Get unread notification count\nexport const getUnreadCount = async (req: Request, res: Response) => {\n  try {\n    const userId = res.locals.userId;\n    if (!userId) return ApiResponse.error(res, \"Unauthorized\", 401);\n\n    const profile = await getProfileByUserId(userId);\n    if (!profile) return ApiResponse.error(res, \"Profile not found\", 404);\n\n    const count = await prisma.notification.count({\n      where: {\n        receiverId: profile.id,\n        isRead: false,\n      },\n    });\n\n    return ApiResponse.success(res, { count });\n  } catch (error) {\n    console.error(\"[GET_UNREAD_COUNT]\", error);\n    return ApiResponse.error(res, \"Internal server error\");\n  }\n};\n\n// Mark notification as read\nexport const markAsRead = async (req: Request, res: Response) => {\n  try {\n    const { notificationId } = req.params;\n    const userId = res.locals.userId;\n    if (!userId) return ApiResponse.error(res, \"Unauthorized\", 401);\n\n    const profile = await getProfileByUserId(userId);\n    if (!profile) return ApiResponse.error(res, \"Profile not found\", 404);\n\n    const notification = await prisma.notification.update({\n      where: {\n        id: notificationId,\n        receiverId: profile.id,\n      },\n      data: { isRead: true },\n    });\n\n    const io = req.app.get(\"io\");\n    io.to(`user:${userId}`).emit(\"notification:read\", notification);\n\n    return ApiResponse.success(\n      res,\n      notification,\n      \"Notification marked as read\",\n    );\n  } catch (error) {\n    console.error(\"[MARK_AS_READ]\", error);\n    return ApiResponse.error(res, \"Internal server error\");\n  }\n};\n\n// Mark all notifications as read\nexport const markAllAsRead = async (req: Request, res: Response) => {\n  try {\n    const userId = res.locals.userId;\n    if (!userId) return ApiResponse.error(res, \"Unauthorized\", 401);\n\n    const profile = await getProfileByUserId(userId);\n    if (!profile) return ApiResponse.error(res, \"Profile not found\", 404);\n\n    await prisma.notification.updateMany({\n      where: {\n        receiverId: profile.id,\n        isRead: false,\n      },\n      data: { isRead: true },\n    });\n\n    const io = req.app.get(\"io\");\n    io.to(`user:${userId}`).emit(\"notification:all-read\");\n\n    return ApiResponse.success(\n      res,\n      { success: true },\n      \"All notifications marked as read\",\n    );\n  } catch (error) {\n    console.error(\"[MARK_ALL_AS_READ]\", error);\n    return ApiResponse.error(res, \"Internal server error\");\n  }\n};\n\n// Delete a notification\nexport const deleteNotification = async (req: Request, res: Response) => {\n  try {\n    const { notificationId } = req.params;\n    const userId = res.locals.userId;\n    if (!userId) return ApiResponse.error(res, \"Unauthorized\", 401);\n\n    const profile = await getProfileByUserId(userId);\n    if (!profile) return ApiResponse.error(res, \"Profile not found\", 404);\n\n    await prisma.notification.delete({\n      where: {\n        id: notificationId,\n        receiverId: profile.id,\n      },\n    });\n\n    const io = req.app.get(\"io\");\n    io.to(`user:${userId}`).emit(\"notification:deleted\", {\n      id: notificationId,\n    });\n\n    return ApiResponse.success(res, { success: true }, \"Notification deleted\");\n  } catch (error) {\n    console.error(\"[DELETE_NOTIFICATION]\", error);\n    return ApiResponse.error(res, \"Internal server error\");\n  }\n};\n\n// Delete all notifications for current user\nexport const deleteAllNotifications = async (req: Request, res: Response) => {\n  try {\n    const userId = res.locals.userId;\n    if (!userId) return ApiResponse.error(res, \"Unauthorized\", 401);\n\n    const profile = await getProfileByUserId(userId);\n    if (!profile) return ApiResponse.error(res, \"Profile not found\", 404);\n\n    await prisma.notification.deleteMany({\n      where: { receiverId: profile.id },\n    });\n\n    const io = req.app.get(\"io\");\n    io.to(`user:${userId}`).emit(\"notification:all-deleted\");\n\n    return ApiResponse.success(\n      res,\n      { success: true },\n      \"All notifications deleted\",\n    );\n  } catch (error) {\n    console.error(\"[DELETE_ALL_NOTIFICATIONS]\", error);\n    return ApiResponse.error(res, \"Internal server error\");\n  }\n};\n\n// Helper function to create a notification\nexport const createNotification = async (data: {\n  type: \"MENTION\" | \"REPLY\" | \"REACTION\" | \"THREAD_REPLY\";\n  content: string;\n  senderId: string;\n  receiverId: string;\n  messageId?: string;\n  channelId?: string;\n  serverId?: string;\n  conversationId?: string;\n  emoji?: string;\n}) => {\n  try {\n    const notification = await prisma.notification.create({\n      data,\n      include: {\n        sender: {\n          select: { id: true, name: true, imageUrl: true },\n        },\n      },\n    });\n\n    return notification;\n  } catch (error) {\n    console.error(\"[CREATE_NOTIFICATION]\", error);\n    throw error;\n  }\n};\n","import { Router } from \"express\";\nimport {\n  addReaction,\n  removeReaction,\n  getMessageReactions,\n} from \"@/controllers/reaction\";\n\nimport { authMiddleware } from \"@/middlewares/authMiddleware\";\n\nconst router: Router = Router();\n\n// Get reactions for a message (Public)\nrouter.get(\"/message/:messageId\", getMessageReactions);\n\n// Protected routes\nrouter.use(authMiddleware);\n\n// Add reaction to message\nrouter.post(\"/\", addReaction);\n\n// Remove reaction\nrouter.delete(\"/:reactionId\", removeReaction);\n\n// Get reactions for a message\nrouter.get(\"/message/:messageId\", getMessageReactions);\n\nexport default router;\n","import { prisma } from \"@/core/db\";\nimport { events, REACTION_EVENTS } from \"@/core/events\";\nimport { getProfileByUserId } from \"@/services/profile\";\nimport { NotFoundError } from \"@/utils/errors\";\n\nexport class ReactionService {\n  /**\n   * Add a reaction to a message\n   */\n  public static async addReaction(payload: {\n    userId: string;\n    emoji: string;\n    messageId?: string;\n    directMessageId?: string;\n  }) {\n    const { userId, emoji, messageId, directMessageId } = payload;\n\n    const profile = await getProfileByUserId(userId);\n    if (!profile) throw new NotFoundError(\"Profile not found\");\n\n    // Determine message author for notification\n    let authorProfileId: string | null = null;\n    let authorUserId: string | null = null;\n\n    if (messageId) {\n      const message = await prisma.message.findUnique({\n        where: { id: messageId },\n        include: { member: { include: { profile: true } } },\n      });\n      authorProfileId = message?.member.profile.id || null;\n      authorUserId = message?.member.profile.userId || null;\n    } else if (directMessageId) {\n      const directMessage = await prisma.directMessage.findUnique({\n        where: { id: directMessageId },\n        include: { member: { include: { profile: true } } },\n      });\n      authorProfileId = directMessage?.member.profile.id || null;\n      authorUserId = directMessage?.member.profile.userId || null;\n    }\n\n    // Check if user already has a reaction on this message\n    const existingReaction = await prisma.reaction.findFirst({\n      where: {\n        profileId: profile.id,\n        messageId,\n        directMessageId,\n      },\n    });\n\n    if (existingReaction) {\n      // If it's the same emoji, remove it (toggle off)\n      if (existingReaction.emoji === emoji) {\n        await prisma.reaction.delete({\n          where: { id: existingReaction.id },\n        });\n\n        events.emit(REACTION_EVENTS.REMOVED, { reaction: existingReaction });\n        return null;\n      }\n\n      const oldReaction = { ...existingReaction };\n\n      const updatedReaction = await prisma.reaction.update({\n        where: { id: existingReaction.id },\n        data: { emoji },\n        include: {\n          profile: {\n            select: { id: true, name: true, imageUrl: true },\n          },\n        },\n      });\n\n      // Notify clients to remove the old emoji count\n      events.emit(REACTION_EVENTS.REMOVED, { reaction: oldReaction });\n\n      // Notify clients to add the new emoji count\n      events.emit(REACTION_EVENTS.ADDED, {\n        reaction: updatedReaction,\n        authorProfileId,\n        authorUserId,\n        senderProfileId: profile.id,\n      });\n\n      return updatedReaction;\n    }\n\n    const reaction = await prisma.reaction.create({\n      data: {\n        emoji,\n        profileId: profile.id,\n        messageId,\n        directMessageId,\n      },\n      include: {\n        profile: {\n          select: { id: true, name: true, imageUrl: true },\n        },\n      },\n    });\n\n    events.emit(REACTION_EVENTS.ADDED, {\n      reaction,\n      authorProfileId,\n      authorUserId,\n      senderProfileId: profile.id,\n    });\n\n    return reaction;\n  }\n\n  /**\n   * Remove a reaction\n   */\n  public static async removeReaction(payload: {\n    userId: string;\n    reactionId: string;\n  }) {\n    const { userId, reactionId } = payload;\n\n    const profile = await getProfileByUserId(userId);\n    if (!profile) throw new NotFoundError(\"Profile not found\");\n\n    const reaction = await prisma.reaction.delete({\n      where: {\n        id: reactionId,\n        profileId: profile.id,\n      },\n    });\n\n    events.emit(REACTION_EVENTS.REMOVED, { reaction });\n    return reaction;\n  }\n}\n","import { Request, Response } from \"express\";\nimport { prisma } from \"@/core/db\";\nimport { ReactionService } from \"@/services/reaction\";\nimport { ApiResponse } from \"@/utils/api-response\";\nimport logger from \"@/core/logger\";\n\n/**\n * Add emoji reaction to message\n */\nexport const addReaction = async (req: Request, res: Response) => {\n  try {\n    const userId = res.locals.userId;\n    if (!userId) return ApiResponse.error(res, \"Unauthorized\", 401);\n\n    const { emoji, messageId, directMessageId } = req.body;\n\n    if (!emoji || (!messageId && !directMessageId)) {\n      return ApiResponse.error(res, \"Missing required fields\", 400);\n    }\n\n    const reaction = await ReactionService.addReaction({\n      userId,\n      emoji,\n      messageId,\n      directMessageId,\n    });\n\n    return ApiResponse.success(res, reaction, \"Reaction added\");\n  } catch (error: any) {\n    logger.error(\"[ADD_REACTION]\", error);\n    const status = error.message === \"Profile not found\" ? 404 : 500;\n    return ApiResponse.error(\n      res,\n      error.message || \"Internal server error\",\n      status,\n    );\n  }\n};\n\n/**\n * Remove reaction\n */\nexport const removeReaction = async (req: Request, res: Response) => {\n  try {\n    const { reactionId } = req.params;\n    const userId = res.locals.userId;\n    if (!userId) return ApiResponse.error(res, \"Unauthorized\", 401);\n\n    await ReactionService.removeReaction({\n      userId,\n      reactionId,\n    });\n\n    return ApiResponse.success(res, { success: true }, \"Reaction removed\");\n  } catch (error: any) {\n    logger.error(\"[REMOVE_REACTION]\", error);\n    const status = error.message === \"Profile not found\" ? 404 : 500;\n    return ApiResponse.error(\n      res,\n      error.message || \"Internal server error\",\n      status,\n    );\n  }\n};\n\n/**\n * Get all reactions for a message\n */\nexport const getMessageReactions = async (req: Request, res: Response) => {\n  try {\n    const { messageId } = req.params;\n    const { type } = req.query; // \"channel\" or \"direct\"\n\n    const reactions = await prisma.reaction.findMany({\n      where: type === \"direct\" ? { directMessageId: messageId } : { messageId },\n      include: {\n        profile: {\n          select: { id: true, name: true, imageUrl: true },\n        },\n      },\n      orderBy: { createdAt: \"asc\" },\n    });\n\n    // Group reactions by emoji\n    const groupedReactions = reactions.reduce(\n      (acc, reaction) => {\n        if (!acc[reaction.emoji]) {\n          acc[reaction.emoji] = [];\n        }\n        acc[reaction.emoji].push(reaction);\n        return acc;\n      },\n      {} as Record<string, typeof reactions>,\n    );\n\n    return ApiResponse.success(res, groupedReactions);\n  } catch (error) {\n    logger.error(\"[GET_MESSAGE_REACTIONS]\", error);\n    return ApiResponse.error(res, \"Internal server error\");\n  }\n};\n","import { Router } from \"express\";\nimport { getServerMembers } from \"@/controllers/member\";\n\nconst router: Router = Router();\n\nrouter.get(\"/server/:serverId\", getServerMembers);\n\nexport default router;\n","import { prisma } from \"@/core/db\";\nimport { Request, Response } from \"express\";\nimport { ApiResponse } from \"@/utils/api-response\";\n\nexport const getServerMembers = async (req: Request, res: Response) => {\n  try {\n    const { serverId } = req.params;\n    const userId = res.locals.userId;\n\n    if (!serverId) {\n      return ApiResponse.error(res, \"Server ID missing\", 400);\n    }\n\n    // Check if the user is a member of the server\n    const currentMember = await prisma.member.findFirst({\n      where: {\n        serverId,\n        profile: {\n          userId,\n        },\n      },\n    });\n\n    if (!currentMember) {\n      return ApiResponse.error(res, \"Forbidden\", 403);\n    }\n\n    const members = await prisma.member.findMany({\n      where: {\n        serverId,\n      },\n      include: {\n        profile: true,\n      },\n      orderBy: {\n        role: \"asc\",\n      },\n    });\n\n    return ApiResponse.success(res, members);\n  } catch (error) {\n    console.error(\"[GET_SERVER_MEMBERS]\", error);\n    return ApiResponse.error(res, \"Internal server error\");\n  }\n};\n","import { Router } from \"express\";\nimport { getServerChannels } from \"@/controllers/channel\";\n\nconst router: Router = Router();\n\nrouter.get(\"/server/:serverId\", getServerChannels);\n\nexport default router;\n","import { prisma } from \"@/core/db\";\nimport { Request, Response } from \"express\";\nimport { ApiResponse } from \"@/utils/api-response\";\n\nexport const getServerChannels = async (req: Request, res: Response) => {\n  try {\n    const { serverId } = req.params;\n    const userId = res.locals.userId;\n\n    if (!serverId) {\n      return ApiResponse.error(res, \"Server ID missing\", 400);\n    }\n\n    // Check if the user is a member of the server\n    const currentMember = await prisma.member.findFirst({\n      where: {\n        serverId,\n        profile: {\n          userId,\n        },\n      },\n    });\n\n    if (!currentMember) {\n      return ApiResponse.error(res, \"Forbidden\", 403);\n    }\n\n    const channels = await prisma.channel.findMany({\n      where: {\n        serverId,\n      },\n      orderBy: {\n        createdAt: \"asc\",\n      },\n    });\n\n    return ApiResponse.success(res, channels);\n  } catch (error) {\n    console.error(\"[GET_SERVER_CHANNELS]\", error);\n    return ApiResponse.error(res, \"Internal server error\");\n  }\n};\n","import { Server } from \"socket.io\";\nimport logger from \"@/core/logger\";\n\nclass SocketService {\n  private io: Server | null = null;\n\n  /**\n   * Initialize the service with the Socket.IO instance\n   */\n  public initialize(io: Server): void {\n    this.io = io;\n    logger.info(\"[SocketService] Initialized\");\n  }\n\n  /**\n   * Emit a message to a specific room or channel\n   */\n  public emit(event: string, data: any, room?: string): void {\n    if (!this.io) {\n      logger.error(\"[SocketService] Called before initialization\");\n      return;\n    }\n\n    if (room) {\n      this.io.to(room).emit(event, data);\n    } else {\n      this.io.emit(event, data);\n    }\n  }\n\n  /**\n   * Emit a chat message to a channel or conversation\n   */\n  public emitChatMessage(\n    contextId: string,\n    event: \"messages\" | \"messages:update\",\n    data: any,\n  ): void {\n    const eventKey = `chat:${contextId}:${event}`;\n    this.emit(eventKey, data);\n  }\n\n  /**\n   * Emit a notification to a specific user\n   */\n  public emitNotification(userId: string, data: any): void {\n    this.emit(\"notification:new\", data, `user:${userId}`);\n  }\n}\n\nexport const socketService = new SocketService();\n","import { prisma } from \"@/core/db\";\nimport logger from \"@/core/logger\";\nimport { socketService } from \"@/services/socket\";\nimport { NotificationType } from \"@prisma/client\";\n\nexport class NotificationService {\n  /**\n   * Create a notification and emit it via socket\n   */\n  public static async createNotification(payload: {\n    type: NotificationType;\n    content: string;\n    senderId: string;\n    receiverId: string;\n    messageId?: string;\n    channelId?: string;\n    serverId?: string;\n    conversationId?: string;\n    emoji?: string;\n  }) {\n    try {\n      const {\n        senderId,\n        receiverId,\n        messageId,\n        channelId,\n        serverId,\n        conversationId,\n        emoji,\n        ...rest\n      } = payload;\n\n      const notification = await prisma.notification.create({\n        data: {\n          ...rest,\n          sender: { connect: { id: senderId } },\n          receiver: { connect: { id: receiverId } },\n          messageId,\n          channelId,\n          serverId,\n          conversationId,\n          emoji,\n        },\n      });\n\n      // Find the receiver's userId to emit the notification\n      const receiverProfile = await prisma.profile.findUnique({\n        where: { id: receiverId },\n      });\n\n      if (receiverProfile) {\n        socketService.emitNotification(receiverProfile.userId, notification);\n      }\n\n      return notification;\n    } catch (error) {\n      logger.error(\"[NotificationService] Error creating notification\", error);\n      throw error;\n    }\n  }\n}\n","/**\n * Utility to parse @mentions from message content\n * Extracts user IDs from @mention format: @[username](userId)\n */\n\nexport interface Mention {\n  userId: string;\n  username: string;\n  startIndex: number;\n  endIndex: number;\n}\n\n/**\n * Parse mentions from message content\n * Format: @[username](userId)\n */\nexport function parseMentions(content: string): Mention[] {\n  const mentions: Mention[] = [];\n  const mentionRegex = /@\\[([^\\]]+)\\]\\(([^)]+)\\)/g;\n  let match;\n\n  while ((match = mentionRegex.exec(content)) !== null) {\n    mentions.push({\n      username: match[1],\n      userId: match[2],\n      startIndex: match.index,\n      endIndex: match.index + match[0].length,\n    });\n  }\n\n  return mentions;\n}\n\n/**\n * Extract unique user IDs from mentions\n */\nexport function extractMentionedUserIds(content: string): string[] {\n  const mentions = parseMentions(content);\n  const uniqueIds = [...new Set(mentions.map((m) => m.userId))];\n  return uniqueIds;\n}\n\n/**\n * Check if content contains any mentions\n */\nexport function hasMentions(content: string): boolean {\n  return /@\\[([^\\]]+)\\]\\(([^)]+)\\)/.test(content);\n}\n","import { events, MESSAGE_EVENTS, REACTION_EVENTS } from \"@/core/events\";\nimport { socketService } from \"@/services/socket\";\nimport { NotificationService } from \"@/services/notification\";\nimport { extractMentionedUserIds } from \"@/utils/mention-parser\";\nimport { prisma } from \"@/core/db\";\nimport logger from \"@/core/logger\";\n\n/**\n * Handle message created event\n */\nevents.on(MESSAGE_EVENTS.CREATED, async ({ message, type, contextId }) => {\n  try {\n    socketService.emitChatMessage(contextId, \"messages\", message);\n\n    if (type === \"channel\") {\n      const mentionedUserIds = extractMentionedUserIds(message.content);\n      if (mentionedUserIds.length > 0) {\n        const mentionedProfiles = await prisma.profile.findMany({\n          where: { userId: { in: mentionedUserIds } },\n        });\n\n        const channel = await prisma.channel.findUnique({\n          where: { id: message.channelId },\n        });\n\n        for (const profile of mentionedProfiles) {\n          if (profile.id !== message.member.profileId) {\n            await NotificationService.createNotification({\n              type: \"MENTION\",\n              content: `mentioned you in #${channel?.name || \"channel\"}`,\n              senderId: message.member.profileId,\n              receiverId: profile.id,\n              messageId: message.id,\n              channelId: message.channelId,\n              serverId: channel?.serverId,\n            });\n          }\n        }\n      }\n    }\n  } catch (error) {\n    logger.error(\"[MessageHandler] Error handling message:created\", error);\n  }\n});\n\n/**\n * Handle message updated event\n */\nevents.on(MESSAGE_EVENTS.UPDATED, async ({ message, type, contextId }) => {\n  socketService.emitChatMessage(contextId, \"messages:update\", message);\n});\n\n/**\n * Handle reaction added event\n */\nevents.on(\n  REACTION_EVENTS.ADDED,\n  async ({ reaction, authorProfileId, authorUserId, senderProfileId }) => {\n    const roomId = reaction.messageId || reaction.directMessageId;\n    socketService.emit(\"reaction:added\", reaction, roomId);\n\n    // Send notification to author if not reacting to own message\n    if (\n      authorProfileId &&\n      authorProfileId !== senderProfileId &&\n      authorUserId\n    ) {\n      await NotificationService.createNotification({\n        type: \"REACTION\",\n        content: `reacted ${reaction.emoji} to your message`,\n        senderId: senderProfileId,\n        receiverId: authorProfileId,\n        messageId: reaction.messageId || undefined,\n      });\n    }\n  },\n);\n\n/**\n * Handle reaction removed event\n */\nevents.on(REACTION_EVENTS.REMOVED, async ({ reaction }) => {\n  const roomId = reaction.messageId || reaction.directMessageId;\n  socketService.emit(\"reaction:removed\", { id: reaction.id }, roomId);\n});\n","import http from \"http\";\nimport \"@/events/message.handler\";\nimport { Server } from \"socket.io\";\nimport { auth } from \"@/core/auth\";\nimport { prisma } from \"@/core/db\";\nimport logger from \"@/core/logger\";\nimport { Application } from \"express\";\nimport { CustomSocket } from \"@/types\";\nimport { socketService } from \"@/services/socket\";\nimport { fromNodeHeaders } from \"better-auth/node\";\nimport { findOrCreateConversation } from \"@/services/conversation\";\n\nexport let io: Server;\n\nexport const initializeSocket = (\n  httpServer: http.Server,\n  allowedOrigins: string[],\n  app: Application,\n) => {\n  io = new Server(httpServer, {\n    cors: {\n      origin: allowedOrigins,\n      credentials: true,\n      methods: [\"GET\", \"POST\"],\n    },\n    transports: [\"websocket\", \"polling\"],\n    allowEIO3: true,\n  });\n\n  // Initialize SocketService\n  socketService.initialize(io);\n\n  // Attach io instance to Express app so controllers can access it\n  app.set(\"io\", io);\n\n  //  middleware for io\n  io.use(async (socket: CustomSocket, next) => {\n    logger.info(\"[Socket.io] New connection attempt\");\n\n    const session = await auth.api.getSession({\n      headers: fromNodeHeaders(socket.handshake.headers),\n    });\n\n    if (!session) {\n      logger.warn(\"[Socket.io] Unauthenticated connection attempt rejected\");\n      return next(new Error(\"Authentication failed\"));\n    }\n\n    socket.user = {\n      id: session.user.id,\n      name: session.user.name,\n      imageUrl: session.user.image || \"\",\n      email: session.user.email,\n    };\n\n    logger.info(`[Socket.io] User authenticated: ${socket.user.id}`);\n    next();\n  });\n\n  // on socket connection\n  io.on(\"connection\", (socket: CustomSocket) => {\n    logger.info(`[Socket.io] Client connected: ${socket.id}`);\n    socket.join(socket.user?.id as string);\n\n    // Update user status to online\n    prisma.user\n      .update({\n        where: { id: socket.user.id },\n        data: { isOnline: true },\n      })\n      .catch((err) =>\n        logger.error(\n          `[Socket.io] Error updating online status for ${socket.user.id}:`,\n          err,\n        ),\n      );\n\n    // A catch-all listener\n    socket.onAny((event, ...args) => {\n      logger.info(event, args);\n    });\n\n    const activeUsers = [];\n    for (let [id, socket] of io.of(\"/\").sockets) {\n      activeUsers.push({\n        socketId: id,\n        ...socket.handshake.auth,\n      });\n    }\n    socket.emit(\"active-users\", activeUsers);\n\n    socket.broadcast.emit(\"user connected\", {\n      socketId: socket.id,\n      userData: { ...socket.handshake.auth },\n    });\n\n    // session\n    socket.emit(\"session\", {\n      user: socket.user,\n    });\n\n    // Listening to Direct Messages\n    socket.on(\"private message\", async ({ content, to }) => {\n      io.to(to)\n        .to(socket.user.id)\n        .emit(\"private message\", {\n          ...content,\n          from: socket.user,\n          to,\n        });\n      logger.info(socket.user.id);\n      // message to database\n      try {\n        const conversation = await findOrCreateConversation(socket.user.id, to);\n        if (!conversation) return;\n\n        const member =\n          conversation.memberOne.profileId === socket.user.id\n            ? conversation.memberOne\n            : conversation.memberTwo;\n\n        await prisma.directMessage.create({\n          data: {\n            content: content.content || content, // Handle both object and string\n            conversationId: conversation.id,\n            memberId: member.id,\n          },\n        });\n      } catch (err) {\n        logger.error(err);\n      }\n    });\n\n    // mark as read\n    socket.on(\"markAsRead\", async ({ senderId }) => {\n      try {\n        const receiverId = socket.user.id;\n        // Update all messages from senderId to receiverId in their conversation\n        await prisma.directMessage.updateMany({\n          where: {\n            member: {\n              profileId: senderId,\n            },\n            conversation: {\n              OR: [\n                { memberOneId: receiverId, memberTwoId: senderId },\n                { memberOneId: senderId, memberTwoId: receiverId },\n              ],\n            },\n            seen: false,\n          },\n          data: {\n            seen: true,\n          },\n        });\n\n        // Notify the sender that their messages were read\n        io.to(senderId).emit(\"markAsRead\", { senderId, receiverId });\n      } catch (error) {\n        logger.error(\"âŒ Error marking messages as read:\", error);\n      }\n    });\n\n    // typing\n    socket.on(\"typing\", (to) => {\n      socket.broadcast.to(to).emit(\"broadcast typing\", {});\n    });\n\n    //  notifications\n    const notifications: {} = [];\n    socket.on(\"notification\", (arg) => {\n      // send it to users\n      socket.broadcast.to(arg.to).emit(\"notification\", arg.notification);\n    });\n    // Handle notification acknowledgment\n    socket.on(\"notification-acknowledgment\", (notificationId) => {\n      // const notification = notifications.find((n) => n.id === notificationId);\n      // if (notification) {\n      //   notification.seen = true;\n      // }\n    });\n\n    // Room management\n    socket.on(\"join-room\", (room) => {\n      socket.join(room);\n      logger.info(`[Socket.io] User ${socket.user.id} joined room ${room}`);\n    });\n\n    socket.on(\"leave-room\", (room) => {\n      socket.leave(room);\n      logger.info(`[Socket.io] User ${socket.user.id} left room ${room}`);\n    });\n\n    // Disconnect user\n    socket.on(\"disconnect\", async () => {\n      logger.info(`[Socket.io] Client disconnected: ${socket.id}`);\n\n      const userId = socket.user.id;\n      const matchingSockets = await io.in(userId).fetchSockets();\n      const isStillConnected = matchingSockets.length > 0;\n\n      if (!isStillConnected) {\n        logger.info(\n          `[Socket.io] Last connection for user ${userId} closed. Marking offline.`,\n        );\n        try {\n          await (prisma.user.update as any)({\n            where: { id: userId },\n            data: {\n              isOnline: false,\n              lastSeenAt: new Date(),\n            },\n          });\n          socket.broadcast.emit(\"user disconnected\", userId);\n        } catch (err) {\n          logger.error(\n            `[Socket.io] Error updating offline status for ${userId}:`,\n            err,\n          );\n        }\n      }\n    });\n  });\n};\n","import express, { Application } from \"express\";\nimport cors from \"cors\";\nimport cookieParser from \"cookie-parser\";\nimport { rateLimit } from \"express-rate-limit\";\nimport logger from \"@/core/logger\";\n\n// CORS configuration - support multiple origins\nconst allowedOrigins = process.env.ALLOWED_ORIGINS\n  ? process.env.ALLOWED_ORIGINS.split(\",\")\n  : [\"http://localhost:3000\"];\n\nexport { allowedOrigins };\n\nexport function createApp(): Application {\n  const app: Application = express();\n\n  app.set(\"trust proxy\", 1);\n\n  // Basic middleware\n  app.use(cookieParser());\n\n  // CORS configuration\n  app.use(\n    cors({\n      origin: (origin, callback) => {\n        if (!origin) return callback(null, true);\n        if (allowedOrigins.indexOf(origin) !== -1) {\n          callback(null, true);\n        } else {\n          callback(new Error(\"Not allowed by CORS\"));\n        }\n      },\n      credentials: true,\n    }),\n  );\n\n  // Request logging\n  app.use((req, res, next) => {\n    logger.info(`[Request] ${req.method} ${req.url}`);\n    next();\n  });\n\n  // Rate limiting to prevent DoS/Brute-force\n  const limiter = rateLimit({\n    windowMs: 15 * 60 * 1000,\n    max: 1000,\n    standardHeaders: true,\n    legacyHeaders: false,\n  });\n  app.use(limiter);\n\n  return app;\n}\n","import http from \"http\";\nimport { prisma } from \"@/core/db\";\nimport logger from \"@/core/logger\";\n\nexport function serverShutdown(httpServer: http.Server | undefined): void {\n  const shutdown = async (signal: string) => {\n    logger.info(`\\n[${signal}] Shutting down gracefully...`);\n\n    if (httpServer) {\n      httpServer.close(async () => {\n        logger.info(\"Http server closed.\");\n\n        try {\n          await prisma.$disconnect();\n          logger.info(\"Database connection closed.\");\n          process.exit(0);\n        } catch (err) {\n          logger.error(\"Error during database disconnection:\", err);\n          process.exit(1);\n        }\n      });\n    } else {\n      try {\n        await prisma.$disconnect();\n        process.exit(0);\n      } catch (err) {\n        process.exit(1);\n      }\n    }\n\n    // Force close after 10s\n    setTimeout(() => {\n      logger.warn(\n        \"Could not close connections in time, forcefully shutting down.\",\n      );\n      process.exit(1);\n    }, 10000);\n  };\n\n  process.on(\"SIGTERM\", () => shutdown(\"SIGTERM\"));\n  process.on(\"SIGINT\", () => shutdown(\"SIGINT\"));\n}\n"],"mappings":"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","names":["Router","router","Router","Router","router","Router","Router","router","Router","Router","io","router","Router","Router","router","Router","Router","router","Router","Router","router","Router","app","io","fromNodeHeaders","httpServer","allowedOrigins","app","fromNodeHeaders","socket","express","app","express","httpServer"]}